# DRY Tracker — Components & Functions Under Watch

Ongoing log of components, functions, patterns, and utilities that the DRY-GUY agent has flagged or that developers have identified as candidates for deduplication, extraction, or sharing.

**Purpose:** Prevent duplication before it happens. When implementing a new PRD, check this list first — if something similar already exists, reuse it instead of building from scratch.

**Process:**
1. After every significant implementation, run the `dry-guy` agent
2. Record any flagged patterns, near-duplicates, or extraction candidates here
3. When a shared utility is created from a DRY finding, move the entry to the "Resolved" section
4. Reference this log in PRs that touch flagged areas

---

## Status Legend

| Status | Meaning |
|--------|---------|
| `watch` | Identified as potential duplication risk — monitor as more PRDs are implemented |
| `flagged` | DRY-GUY has flagged active duplication — extraction needed |
| `in-progress` | Shared utility/component is being extracted |
| `resolved` | Shared utility created and all consumers refactored to use it |

---

## Active Watch List

### Database & Backend Patterns

| ID | Pattern / Component | PRDs Involved | Status | Notes |
|----|---------------------|---------------|--------|-------|
| DRY-001 | `DbId` type alias (`i64`) usage consistency | All PRDs | `watch` | Defined in PRD-000. Every module must use `DbId`, not raw `i64` for IDs |
| DRY-002 | Status lookup table query patterns | All PRDs with status FKs | `watch` | Expect repeated `JOIN {domain}_statuses` patterns — candidate for shared query helpers |
| DRY-003 | CRUD handler boilerplate (list/get/create/update/delete) | PRD-01, PRD-02, and all entity PRDs | `watch` | Axum handlers will repeat the same patterns — candidate for macro or generic handler |
| DRY-004 | Pagination query pattern | PRD-20, PRD-42, PRD-73, all list endpoints | `watch` | `LIMIT/OFFSET` or cursor-based pagination will appear in many handlers |
| DRY-005 | `updated_at` trigger creation in migrations | All PRDs with tables | `watch` | Trigger function defined once in PRD-000; each table just adds the trigger. Watch for copy-paste divergence |
| DRY-006 | Error response formatting | PRD-02 and all API PRDs | `watch` | Constraint violation → user-friendly error translation will be needed everywhere |
| DRY-007 | FK index creation pattern in migrations | All PRDs with tables | `watch` | Every FK needs `CREATE INDEX idx_{table}_{col}` — easy to forget or name inconsistently |
| DRY-008 | Soft delete `WHERE deleted_at IS NULL` filter | PRD-109, all entity repos | `watch` | Every repo query (find_by_id, list_*) must include this filter. Missing it = showing deleted records. |
| DRY-009 | `soft_delete` / `restore` / `hard_delete` method pattern | PRD-109, all entity repos | `watch` | All 9+ repos need identical method signatures. Candidate for trait or macro if boilerplate grows. |
| DRY-010 | Version-as-final transactional pattern | PRD-109, PRD-069 | `watch` | Unmark old + mark new in one transaction. Could be reused if other entities get versioning. |
| DRY-011 | Trash entity-type parallel lists (5 locations) | PRD-109 | `watch` | 9 entity type strings appear in 5 parallel match/list sites: `KNOWN_ENTITY_TYPES`, `PURGE_ORDER`, `table_and_name_expr`, `check_parent_trashed` (all in `trash_repo.rs`), and `dispatch_restore` (in `handlers/trash.rs`). Adding a new entity type requires updating all 5. Consider a single `EntityMeta` data array if the codebase grows beyond 12 entity types. |
| DRY-012 | `resolve_role_name` logic duplicated across handlers | PRD-03 | `resolved` | Extracted to `RoleRepo::resolve_name()` in `db/src/repositories/role_repo.rs`. Both `auth.rs` and `admin.rs` now call it. |
| DRY-013 | Role name magic strings (`"admin"`, `"creator"`, `"reviewer"`) | PRD-03 | `resolved` | Constants defined in `core/src/roles.rs` (`ROLE_ADMIN`, `ROLE_CREATOR`, `ROLE_REVIEWER`). `rbac.rs` updated to use them. |
| DRY-014 | Validate-then-hash password 2-step pattern | PRD-03 | `watch` | `validate_password_strength(...)` + `hash_password(...)` with identical `map_err` wrapping appears twice in `admin.rs:64-69` and `admin.rs:177-182`. Extract to `validate_and_hash_password(password, min_len) -> AppResult<String>` if a third occurrence appears (e.g., self-service password change endpoint). |
| DRY-015 | RBAC extractor boilerplate (`RequireAdmin`, `RequireCreator`, `RequireAuth`) | PRD-03 | `watch` | Three `FromRequestParts` impls that differ only in role check logic. If a 4th extractor (e.g., `RequireReviewer`) is added, extract a `require_role!` macro. |
| DRY-016 | `find_by_prompt_id` + event emit pattern in processor.rs | PRD-05 | `watch` | `ComfyUIExecutionRepo::find_by_prompt_id` + `event_tx.send(...)` appears 2x in `processor.rs` (handle_executing completion + handle_execution_error). Different event variants carry different data. Extract to shared helper if a 3rd occurrence appears. |
| DRY-017 | Middleware/router construction duplicated in main.rs and tests/common/mod.rs | PRD-02, PRD-05, PRD-10, PRD-09 | `resolved` | Fully resolved: `build_app_router()` extracted to `trulience_api::router` module. Both `main.rs` and `tests/common/mod.rs` now call the same shared function. Zero middleware duplication. |
| DRY-018 | Broadcast receiver loop pattern (recv + Lagged + Closed) | PRD-10 | `watch` | `persistence.rs` and `notifications/router.rs` share structurally identical `loop { match receiver.recv().await { Ok => handle, Lagged => warn, Closed => break } }`. Two instances with different handler logic. Extract a `run_subscriber(receiver, handler_fn)` utility if a 3rd broadcast subscriber is added. |
| DRY-019 | Channel name magic strings (`"in_app"`, `"digest"`, `"webhook"`, `"email"`) | PRD-10 | `resolved` | Constants defined in `core/src/channels.rs` (`CHANNEL_IN_APP`, `CHANNEL_DIGEST`, `CHANNEL_WEBHOOK`, `CHANNEL_EMAIL`). Router, digest scheduler, and notification handler updated. |

| DRY-074 | Rule type name strings in validation evaluator (`"required"`, `"type_check"`, etc.) | PRD-14 | `watch` | 8 rule type strings matched against in `core/src/validation/evaluator.rs`. They match the seeded `validation_rule_types` names. Currently only one consumer. Extract to `core/src/validation_rule_types.rs` constants if a second consumer (e.g., frontend, seed verification) appears. |
| DRY-075 | Import status magic strings + status_id magic number | PRD-14 | `resolved` | Hardcoded `"preview"`, `"committed"` strings and `status_id != 1` in handler. Extracted to `core/src/import_status.rs` constants (following DRY-013/DRY-019/DRY-072 pattern). |
| DRY-076 | Source type `"api"` magic string in `persist_preview_report` | PRD-14 | `watch` | Single-use string literal in `handlers/validation.rs`. Extract to a constant if a second import source type (e.g., `"csv_upload"`, `"bulk_file"`) is added. |
| DRY-077 | Tracing init boilerplate (dotenvy + registry + EnvFilter + fmt) | All binaries (api, worker, agent) | `flagged` | 3 binaries now share identical 6-line tracing init differing only in default filter string. Extract to `trulience_core::telemetry::init_tracing(default_filter: &str)`. Threshold of 3 met with PRD-06. |
| DRY-078 | Restart status magic `status_id` numbers (e.g., `DEFAULT 1` = initiated) | PRD-06 | `watch` | `restart_logs.status_id DEFAULT 1` relies on seed ordering. Same fragile pattern as DRY-075 (import status). `core/src/restart_status.rs` constants exist but are unused. Extract numeric IDs or resolve by name when status transitions are implemented. |
| DRY-079 | Metric name strings crossing SQL/Rust boundary | PRD-06 | `watch` | Metric names (`temperature_celsius`, `vram_used_percent`, `utilization_percent`) appear in migration seed SQL and `core/src/metric_names.rs`. Same cross-boundary pattern as DRY-070 (QA check types). Acceptable -- SQL migrations can't reference Rust constants. |
| DRY-080 | `DataResponse<T>` typed response envelope | PRD-06+ | `resolved` | Extracted to `api/src/response.rs`. Hardware handlers use it; other handlers still use `serde_json::json!({ "data": ... })`. Existing handlers should migrate to `DataResponse<T>` when touched. |
| DRY-081 | Agent WS reconnect (fixed delay) vs ComfyUI reconnect (exponential backoff) | PRD-05, PRD-06 | `watch` | Agent `sender.rs` uses fixed 5s reconnect delay. ComfyUI `reconnect.rs` uses configurable exponential backoff. Intentionally different -- agent reconnect is simpler. If a 3rd WebSocket client needs reconnect, consider extracting a shared `ReconnectStrategy` enum. |
| DRY-082 | `getCssVar()` runtime CSS custom property resolver | PRD-06 | `watch` | `MetricsChart.tsx:64-67` defines a local `getCssVar(name, fallback)` helper that reads CSS custom properties via `getComputedStyle`. Only 1 consumer now. Extract to `src/lib/css-vars.ts` when a 2nd charting or canvas component needs it. |
| DRY-083 | `DataResponse<T>` adoption in existing handlers | PRD-06+ | `flagged` | `notification.rs` (4 instances) and `validation.rs` (7 instances) still use ad-hoc `serde_json::json!({ "data": ... })` instead of the shared `DataResponse<T>` from `api/src/response.rs`. `reclamation.rs` (11 instances) migrated in PRD-15 audit. Migrate remaining when touched. |
| DRY-084 | Script type name magic strings (`"shell"`, `"python"`, `"binary"`) | PRD-09 | `resolved` | Constants defined in `core/src/script_types.rs` (`SCRIPT_TYPE_SHELL`, `SCRIPT_TYPE_PYTHON`, `SCRIPT_TYPE_BINARY`). `orchestrator.rs` updated to use them. Same pattern as DRY-013, DRY-019, DRY-072. |
| DRY-085 | QA handler `run_python_script` vs scripting subprocess module | PRD-09, PRD-22 | `watch` | `image_qa.rs:232-262` has its own `run_python_script()` (CLI args, no stdin, no timeout, no output cap) that is behaviorally duplicated by the new `core/scripting/subprocess.rs` (stdin-based, timeout, output cap, kill-on-drop). Different interfaces (args vs stdin) prevent direct replacement now. When QA scripts are refactored to accept stdin-based input, migrate to the scripting module's `run_command`. |
| DRY-086 | `VENV_DIR` env var name string | PRD-09 | `watch` | `"VENV_DIR"` literal appears 2x: `orchestrator.rs:101` (sets it) and `python.rs:108` (reads it). Different crates, tightly coupled contract. Extract to `core/src/script_types.rs` constant if a 3rd consumer appears. |
| DRY-090 | `ADMIN_ROLE` constant redefined in `handlers/jobs.rs` | PRD-07 | `resolved` | Hardcoded `const ADMIN_ROLE: &str = "admin"` instead of using `ROLE_ADMIN` from `core/src/roles.rs` (DRY-013). Replaced with import of existing constant. |
| DRY-092 | `list_by_user` / `list_all` structural duplicate in `job_repo.rs` | PRD-07 | `resolved` | Two methods shared identical pagination clamping, status filter logic, and query assembly differing only by `WHERE submitted_by = $1`. Extracted shared `list_jobs(pool, user_id: Option, params)` private method. |
| DRY-093 | `MAX_LIMIT`/`DEFAULT_LIMIT` pagination clamping pattern duplicated | PRD-07, PRD-10, PRD-12, PRD-17, PRD-42, PRD-44, PRD-47 | `flagged` | **8 consumers**: `tag_repo.rs` (100/500), `job_repo.rs` (50/100), `notification.rs` (50/100), `script_execution_repo` (~), `asset_repo.rs` (50/100), `dashboard.rs` handler (`FEED_MAX_LIMIT`/`FEED_DEFAULT_LIMIT`), `webhooks.rs` (50/200, now using `clamp_limit`/`clamp_offset` from core), `bug_reports.rs` (50/200, inline clamping). Also 2x bare `unwrap_or(50)` in `reclamation.rs` handler without MAX_LIMIT cap. Shared `clamp_limit`/`clamp_offset` exists in `core/src/search.rs` -- remaining consumers should migrate. |
| DRY-098 | `validate_entity_type` function duplicated in `tags.rs` and `trash.rs` | PRD-47, PRD-109 | `watch` | Same function name and pattern but different entity registries (singular taggable types vs plural soft-deletable types). If a 3rd handler needs entity type validation, extract shared `validate_entity_type(value, valid_list, kind_label) -> AppResult<()>`. |
| DRY-094 | Magic status_id numbers `1, 2` in `dispatcher.rs` | PRD-07 | `resolved` | Hardcoded `status_id IN (1, 2)` instead of `JobStatus::Pending.id()` / `JobStatus::Running.id()`. Replaced with parameterized binds using the enum. |
| DRY-095 | Job WS message type magic strings in `progress.rs` | PRD-07 | `resolved` | `"job_progress"`, `"job_completed"`, `"job_failed"`, `"job_cancelled"` were inline strings. Extracted to `core/src/job_events.rs` constants (following DRY-079 / metric_names pattern). |
| DRY-096 | `serde_json::json!` + `Message::Text` + `broadcast` repeated 4x in `progress.rs` | PRD-07 | `resolved` | Extracted `broadcast_json(ws_manager, payload)` private helper to deduplicate the serialization + WS wrapping + broadcast pipeline. |
| DRY-097 | Ownership guard pattern (find + authorize) repeated 3x in `jobs.rs` | PRD-07 | `resolved` | `find_by_id` + `NotFound` + ownership check + `Forbidden` was copy-pasted in `get_job`, `cancel_job`, `retry_job`. Extracted `find_and_authorize(pool, job_id, auth, action)` helper. |
| DRY-167 | SHA-256 hex digest implemented 3x in core crate | PRD-13, PRD-12, PRD-45 | `flagged` | Three independent implementations: `metadata.rs:sha256_hex()` (Sha256+hex::encode), `api_keys.rs:hash_api_key()` (Sha256+hex::encode), `audit.rs:compute_integrity_hash()` (chained SHA-256). First two are structurally identical (both `Sha256::digest` + `hex::encode`). Extract shared `sha256_hex(data: &[u8]) -> String` to `core/src/hashing.rs`; keep `compute_integrity_hash` separate (chained/different purpose). 3 consumers, threshold met. |
| DRY-168 | Metadata regeneration logic duplicated within `metadata.rs` handler | PRD-13 | `flagged` | Lines 197-215 and 267-279 in `api/src/handlers/metadata.rs` repeat the same 5-step pipeline: `serialize_metadata` -> `sha256_hex` -> `CreateMetadataGeneration` construction -> `MetadataGenerationRepo::upsert`. Extract `upsert_generation(pool, entity_type, entity_id, project_id, metadata) -> Result<MetadataGeneration>` private helper. 2 call sites in same file. |
| DRY-169 | `find_stale_characters` / `find_stale_scenes` structural duplicates | PRD-13 | `flagged` | `metadata_repo.rs` has two 20-line methods that differ only in table name (`characters` vs `scenes`), join column, and entity type string. Same SELECT, same WHERE logic, same COALESCE pattern. Extract shared `find_stale_entities(pool, project_id, table, join_col, entity_type) -> Vec<StaleMetadata>` or use a generic approach with `&str` table name parameter. |
| DRY-170 | Magic strings `'character'`/`'scene'` in metadata SQL instead of constants | PRD-13 | `flagged` | `metadata_repo.rs` hardcodes `'character'` and `'scene'` in 4 SQL queries instead of using `ENTITY_TYPE_CHARACTER`/`ENTITY_TYPE_SCENE` from `core/src/metadata.rs`. Use `$N` bind params with the existing constants. |
| DRY-174 | `IMAGE_EXTENSIONS` in `importer.rs` overlaps with `VALID_IMAGE_FORMATS` in `images.rs` | PRD-16, PRD-21 | `watch` | `core/src/importer.rs` defines `IMAGE_EXTENSIONS = [".jpg", ".jpeg", ".png", ".webp", ".tiff", ".bmp"]` (with dots) while `core/src/images.rs` defines `VALID_IMAGE_FORMATS = ["jpg", "jpeg", "png", "webp", "tiff", "bmp"]` (without dots). Same set, different format. Consolidate by making `importer.rs` derive from `VALID_IMAGE_FORMATS` with dot prefix, or add a `VALID_IMAGE_EXTENSIONS` to `images.rs`. 2 consumers. |
| DRY-175 | Hardcoded `'uploading'` string in `import_session_repo.rs` SQL | PRD-16 | `watch` | Line 42 uses `'uploading'` string literal instead of `SESSION_STATUS_UPLOADING` constant from `core/src/importer.rs`. 1 SQL consumer. Fix when file is next touched. |
| DRY-176 | `serde_json::json!` responses in `metadata.rs` and `importer.rs` handlers | PRD-13, PRD-16 | `flagged` | `metadata.rs` handler uses `serde_json::json!` at 2 endpoints (regeneration report, staleness preview) and `importer.rs` at 1 endpoint (upload response) instead of typed `DataResponse<T>` structs. Same pattern as DRY-083. Migrate to `DataResponse<T>` with typed response structs. |

| DRY-179 | Duplicate sensitive-key redaction functions in `audit.rs` vs `config_export.rs` | PRD-44, PRD-45 | `flagged` | Two recursive JSON redaction functions with overlapping key lists (6 shared keys), different placeholders (`"[REDACTED]"` vs `"***REDACTED***"`), and different APIs (clone vs mutate-in-place). `audit.rs:SENSITIVE_FIELDS` (10 entries) and `config_export.rs:SENSITIVE_KEYS` (10 entries). Extract shared `core/src/redaction.rs` with unified key list, shared `is_sensitive_key()`, and both mutate/clone variants. |
| DRY-180 | `ensure_segment_exists` pattern repeated 3x in `approval.rs` handler | PRD-35 | `flagged` | `SegmentRepo::find_by_id + ok_or_else + CoreError::NotFound` block (8 lines) duplicated identically in `approve_segment`, `reject_segment`, `flag_segment`. Extract `ensure_segment_exists(pool, segment_id)` private helper (same pattern as DRY-097 `find_and_authorize`, DRY-121 `ensure_asset_exists`). |
| DRY-182 | ComfyUI workflow parsing duplicated between backend handler and frontend parser | PRD-33 | `watch` | `handlers/workflow_canvas.rs:import_comfyui` (~85 lines) and `comfyui-parser.ts:parseComfyUIWorkflow` (~53 lines) implement the same node/edge extraction from ComfyUI JSON. Cross-boundary behavioral duplicate. Frontend also has `exportToComfyUI` (no backend equivalent). Designate frontend as client-side parser for offline use; if backend handler is the primary import path, consider moving parsing logic to `core/src/workflow_canvas.rs` for testability. 2 consumers (1 Rust, 1 TS). |
| DRY-183 | Inline pagination clamping in `bug_reports.rs` instead of `clamp_limit`/`clamp_offset` | PRD-44 | `flagged` | `params.limit.unwrap_or(50).min(200)` and `params.offset.unwrap_or(0)` inline in handler instead of using shared `clamp_limit`/`clamp_offset` from `core/src/search.rs`. DRY-093 8th consumer. |
| DRY-184 | Hardcoded `"admin"` string in `bug_reports.rs` instead of `ROLE_ADMIN` | PRD-44 | `flagged` | 2x `"admin"` string at lines 73 and 111 instead of `ROLE_ADMIN` from `core/src/roles.rs`. Same violation as DRY-090 (CRITICAL in PRD-07). |
| DRY-189 | State machine pattern structural duplicate (`bug_report.rs` vs `scheduling.rs`) | PRD-44, PRD-08 | `watch` | Both have `valid_transitions(from) -> &[targets]` + `validate_transition(from, to) -> Result<()>` with identical logic but different types (`&str` vs `i16`) and error types (`CoreError` vs `String`). 2 consumers. Extract generic `StateMachine` trait at 3rd consumer. |
| DRY-190 | Auth extractor inconsistency (`RequireAuth` vs `AuthUser`) across handler files | PRD-33, PRD-35, PRD-44 | `watch` | `workflow_canvas.rs` uses `RequireAuth` while `approval.rs` and `bug_reports.rs` use `AuthUser`. Both provide same functionality. Style inconsistency, not duplication. Standardize when files are next touched. |
| DRY-199 | Role name strings `admin`/`creator`/`reviewer` in `tourPaths.ts` cross-boundary | PRD-53 | `watch` | Tour paths keyed by role name strings matching backend `core/src/roles.rs` constants. Same cross-boundary pattern as DRY-114 (preset names). Sync comment added. No frontend role constants exist. Extract at 2nd frontend consumer. |
| DRY-201 | Regex compiled on every call in `scene_type_config.rs` | PRD-23 | `resolved` | `regex::Regex::new(r"\{(\w+)\}")` was compiled on every call to `resolve_prompt_template()` and `extract_placeholders()`. Extracted to `static PLACEHOLDER_RE: LazyLock<regex::Regex>` -- compiled once, reused forever. |
| DRY-202 | `BadgeVariant` type redefined in `SceneMatrixView.tsx` | PRD-23 | `resolved` | `type BadgeVariant` was locally redefined instead of importing from `Badge.tsx`. Exported `BadgeVariant` from `Badge.tsx` + primitives barrel. SceneMatrixView now imports it. StatusBadge.tsx and ActiveTasksWidget.tsx also redefine it (DRY-020 related) -- fix when touched. |
| DRY-203 | Textarea className string duplicated 3x in scene-types feature | PRD-23 | `resolved` | Identical 150-char textarea className string appeared in `PromptTemplateEditor.tsx` (2x) and `SceneTypeEditor.tsx` (1x). Extracted `TEXTAREA_CLASSES` constant to `PromptTemplateEditor.tsx`, imported in `SceneTypeEditor.tsx`. |
| DRY-204 | Magic `status_id` numbers in `generate_matrix` handler | PRD-23 | `resolved` | `match status_id { 1 => "pending", 2 => "generating", ... }` used raw numbers instead of `SceneStatus` enum. Extracted `scene_status_label()` function using `SceneStatus::*.id()` pattern (same as DRY-094 fix in `dispatcher.rs`). |
| DRY-205 | `validate_variant_applicability` structurally duplicates `validate_known_key` | PRD-23, PRD-53 | `watch` | Same contains-check + error-format pattern as `onboarding.rs:validate_known_key()`. 2 consumers with different error types and contexts. Extract generic validator at 3rd consumer. |
| DRY-206 | CRUD handlers in `scene_type.rs` return raw `Json<T>` instead of `DataResponse<T>` | PRD-23, PRD-01 | `watch` | `list_by_project`, `get_by_id`, `update`, `delete`, `create` handlers return `Json(entity)` directly without `DataResponse` envelope. Same pattern as other pre-DataResponse handlers (scenes, segments, source_images, derived_images). Low priority -- matches existing convention for original entity CRUD. Migrate when handlers are next touched. |
| DRY-207 | Variant applicability constants duplicated between Rust and TypeScript | PRD-23 | `watch` | `core/src/scene_type_config.rs` defines `VARIANT_CLOTHED/TOPLESS/BOTH/CLOTHES_OFF` and `VALID_VARIANT_TYPES`. Frontend `types.ts` defines `VARIANT_OPTIONS` with same values. Same cross-boundary pattern as DRY-114 (preset names), DRY-079 (metric names). Acceptable -- different runtimes. |
| DRY-208 | `CLIP_POSITIONS` and `CLIP_TABS` duplicate clip position labels | PRD-23 | `watch` | `types.ts:CLIP_POSITIONS = ["full_clip", "start_clip", "continuation_clip"]` and `PromptTemplateEditor.tsx:CLIP_TABS` duplicate the same 3 position identifiers. `CLIP_TABS` adds human labels. Same file-pair, acceptable -- `CLIP_POSITIONS` is for API params, `CLIP_TABS` is for UI tabs. |
| DRY-209 | `EmbeddingStatus` enum duplicated in `core/src/embedding.rs` and `db/src/models/status.rs` | PRD-76 | `resolved` | Hand-rolled enum in core (with `from_id`, `label`, `id`) and macro-generated enum in db (with only `id`). Core version is canonical because domain logic (`classify_extraction_result`) depends on it. Removed db `define_status_enum!` version, added comment pointing to core as canonical source. Tests moved to core. |
| DRY-212 | `find_by_id + ok_or(NotFound)` repeated 9x in `workers.rs` handler without helper | PRD-46 | `resolved` | Extracted `ensure_worker_exists(pool, id) -> AppResult<Worker>` helper and `validate_create_input(input) -> AppResult<()>` helper, following DRY-097/DRY-121 pattern. Reduced from 9 inline instances to 5 calls to helper + 2 special cases (update returns `Option`, approve returns `Option`). |
| DRY-213 | Hardcoded `status_id` numbers in `worker_repo.rs` SQL | PRD-46 | `resolved` | `status_id = 3` (Offline), `status_id = 1` (Idle) hardcoded in `register`, `list_available`, `approve`, `decommission` methods. Replaced with bind parameters using `WorkerStatus::Idle.id()` / `WorkerStatus::Offline.id()`. Fleet stats FILTER clauses left as-is (cannot easily parameterize SQL aggregate filters). |
| DRY-215 | Redundant `.map_err(\|e\| AppError::Core(e))` in `embedding.rs` handler | PRD-76 | `resolved` | `#[from] CoreError` on `AppError` provides auto-conversion via `?`. Removed explicit `map_err` closure. |
| DRY-216 | Worker validation block duplicated in `register_worker` and `self_register_worker` | PRD-46 | `resolved` | Identical 4-line validation block (validate_worker_name + validate_tags) extracted to `validate_create_input(&input)` helper in same file. |
| DRY-218 | `formatHeartbeat` relative time formatter in `WorkerCard.tsx` | PRD-46 | `watch` | Custom relative time formatter (`Xs ago`, `Xm ago`, `Xh ago`) in `WorkerCard.tsx:28-37`. 1 consumer. Extract to `@/lib/format.ts` as `formatRelativeTime(iso)` if a 2nd consumer appears. |

### Frontend Patterns

| ID | Pattern / Component | PRDs Involved | Status | Notes |
|----|---------------------|---------------|--------|-------|
| DRY-020 | Status badge/chip component | PRD-29, PRD-35, PRD-42, PRD-54 | `watch` | Status display (colored badge with lookup name) will appear in many views |
| DRY-021 | Data table with sort/filter/pagination | PRD-29, PRD-20, PRD-42, PRD-73 | `watch` | Reusable table component needed early — many PRDs will need it |
| DRY-022 | Confirmation dialog (destructive actions) | PRD-29, PRD-15, PRD-72 | `watch` | CASCADE deletes require confirmation — shared dialog needed |
| DRY-023 | Image thumbnail/preview component | PRD-21, PRD-62, PRD-83, PRD-96 | `watch` | Multiple PRDs display image/video thumbnails — one component |
| DRY-024 | Progress indicator (job/generation) | PRD-24, PRD-54, PRD-57, PRD-90 | `watch` | Generation progress bars/strips appear across many views |
| DRY-025 | Side-by-side comparison layout | PRD-22, PRD-68, PRD-101 | `watch` | Image and video comparison views share the same layout pattern |
| DRY-026 | Form validation patterns | PRD-14, PRD-23, PRD-66 | `watch` | Input validation with error display will repeat across all forms |
| DRY-099 | `TagSuggestion` type duplicated `TagWithCount` in `TagInput.tsx` | PRD-47 | `resolved` | `TagSuggestion` was structurally identical to `TagWithCount` (`TagInfo + usage_count`). Unified to single `TagWithCount` type in `TagChip.tsx`. |
| DRY-102 | Click-outside pattern duplicated in `TagInput.tsx`, `Dropdown.tsx`, `JobTrayPanel.tsx` | PRD-47, PRD-29, PRD-54 | `resolved` | 3 consumers reached threshold. Extracted `useClickOutside(ref, callback, enabled?)` to `src/hooks/useClickOutside.ts`. All 3 consumers refactored. |
| DRY-103 | Raw `api.*()` calls in tag components instead of TanStack Query hooks | PRD-47 | `watch` | `TagInput.tsx` and `TagFilter.tsx` use `api.get/post/delete` directly. Established pattern is TanStack Query hooks (see `use-hardware.ts`). Extract `useTags`, `useApplyTag`, `useRemoveTag`, `useTagSuggestions` hooks when feature matures. |
| DRY-104 | Taggable entity type string constants | PRD-47 | `watch` | `VALID_ENTITY_TYPES` in `tags.rs:292` -- 1 consumer. Extract to `core/src/entity_types.rs` if a 2nd consumer needs the list. |
| DRY-105 | Inline SVG close icon in `TagChip.tsx` | PRD-47 | `watch` | Hardcoded X icon SVG. 1 consumer. Extract to design system icon token at 2nd inline close icon. |
| DRY-106 | Theme status name `'active'` magic string in `theme_repo.rs` SQL | PRD-29 | `watch` | `list_custom_themes()` uses `WHERE name = 'active'` subquery. 1 consumer. Extract to `core/src/theme_status.rs` constant if a 2nd consumer appears. Same cross-boundary pattern as DRY-079. |
| DRY-107 | `STATUS_OPTIONS` hardcoded status_id numbers in `TokenEditor.tsx` | PRD-29 | `watch` | `{ value: "1", label: "Draft" }` etc. relies on migration seed ordering. 1 consumer. If a 2nd frontend component needs theme status list, fetch from API or define shared constants. |
| DRY-108 | `TokenEditor.tsx` exceeded 500-line threshold (670 lines) | PRD-29 | `resolved` | Extracted 7 section components (Surface/Text/Action/Border/Font/Spacing + Preview) and shared types/constants to `token-editor/TokenSections.tsx` (404 lines). Main component now 298 lines. 6x structurally identical `updateX` functions replaced with generic `updateTokenSection<K>()`. |
| DRY-109 | `TagWithCount` redundantly re-exported from `TagInput.tsx` and `TagFilter.tsx` | PRD-47 | `resolved` | Both files re-exported `TagWithCount` even though they import it from the canonical source `TagChip.tsx`. Removed redundant re-exports to prevent import confusion. |
| DRY-110 | `CATEGORY_LABELS` and `CATEGORY_ORDER` duplicated in `CheatSheet.tsx` and `KeymapEditor.tsx` | PRD-52 | `resolved` | Identical constant declarations in two files. Extracted to `ShortcutRegistry.ts` alongside `groupBindingsByCategory()` utility. |
| DRY-111 | `snapValue()` duplicated in `useSnapGrid.ts` and `usePanelResize.ts` | PRD-30 | `resolved` | Identical function `Math.round(value / gridSize) * gridSize`. Exported from `useSnapGrid.ts`, imported in `usePanelResize.ts`. |
| DRY-112 | Debounce timer pattern across 3 persistence hooks | PRD-29, PRD-30, PRD-32 | `watch` | `useThemePersistence`, `useLayoutPersistence`, and `useProficiencyTracker` all use `useRef<setTimeout>` + `clearTimeout` + `setTimeout` debounce pattern with different delays (500ms, 2000ms, 2000ms). Structurally similar but different callback logic. Extract `useDebouncedCallback(fn, delay)` if a 4th consumer appears. |
| DRY-113 | Proficiency level magic strings in SQL | PRD-32 | `watch` | `'beginner'`, `'intermediate'`, `'expert'` appear in `proficiency_repo.rs` SQL and migration DDL. Same cross-boundary pattern as DRY-079 (metric names in SQL). Acceptable for now. Extract to `core/src/proficiency_levels.rs` if a second Rust consumer appears. |
| DRY-114 | Preset name list duplicated between backend and frontend | PRD-52 | `watch` | Backend `PRESET_NAMES` in `keymaps.rs` and frontend `presets` object in `presets/index.ts` both enumerate `[default, premiere, resolve, avid]`. Cross-boundary duplication. The `GET /keymaps/presets` endpoint serves as single source of truth; frontend presets map is local for offline key resolution. No action needed unless lists diverge. |
| DRY-115 | Raw `api.*()` calls in layout persistence hooks | PRD-30 | `watch` | `useLayoutPersistence.ts` and `PresetSwitcher.tsx` both make raw `api.get/put/post/delete` calls to `/user/layouts`. Same pattern as DRY-103 (tags). Extract TanStack Query hooks when layout feature matures. |
| DRY-127 | `formatTime()` duplicated in `CinemaMode.tsx` and `GridControls.tsx` | PRD-36 | `resolved` | Identical function (seconds to `M:SS`) in 2 cinema files, behaviorally duplicating `formatDuration()` from `video-player/frame-utils.ts`. Removed both locals, replaced with `formatDuration` import from `@/features/video-player`. |
| DRY-128 | Recharts Tooltip `contentStyle` object duplicated 7x across 3 chart components | PRD-41 | `resolved` | Identical 4-property style object in QualityCharts (4x), WorkflowComparison (2x), WorkerBenchmark (1x). Extracted `TOOLTIP_CONTENT_STYLE`, `AXIS_TICK_STYLE`, `GRID_STROKE` to `performance/chartStyles.ts`. |
| DRY-129 | `formatElapsed()` reimplements duration formatting in `ActiveTasksWidget.tsx` | PRD-42 | `resolved` | Behavioral duplicate of `formatDuration()` from `@/lib/format.ts`. Refactored to delegate to `formatDuration(seconds * 1000)` with null guard. |
| DRY-130 | Click-outside pattern at 3 consumers (threshold met) | PRD-47, PRD-29, PRD-54 | `resolved` | See DRY-102 (updated to resolved). Extracted `useClickOutside` hook to `src/hooks/useClickOutside.ts`. Refactored TagInput, Dropdown, JobTrayPanel. |
| DRY-116 | `export_keymap` handler duplicate JSON branches | PRD-52 | `resolved` | Two `serde_json::json!` branches (Some/None) produced identical structure with different values. Extracted shared destructuring with fallback defaults. |
| DRY-117 | `formatFileSize()` duplicated in `AssetBrowser.tsx` and `AssetDetail.tsx` | PRD-17 | `resolved` | Identical function behaviorally duplicating `formatBytes()` from `@/lib/format.ts`. Removed both, replaced with `formatBytes` import. |
| DRY-118 | `formatDate()` inline helper in `AssetDetail.tsx` | PRD-17 | `resolved` | Short-date formatter was local to one file. Extracted to shared `formatDate()` in `@/lib/format.ts` alongside existing `formatDateTime` and `formatCountdown`. |
| DRY-119 | `reclamation.rs` handler uses `serde_json::json!` (11x) instead of `DataResponse<T>` | PRD-15 | `resolved` | Handler imported `DataResponse` but only used it for 2/13 endpoints. Migrated all 11 remaining endpoints to `DataResponse<T>` with `impl IntoResponse` return type. DRY-083 partially improved (reclamation cleared; notification.rs + validation.rs remain). |
| DRY-120 | Column list repeated 15x across `reclamation_repo.rs` (no COLUMNS constants) | PRD-15 | `resolved` | Trash queue columns 5x, protection rule columns 4x, policy columns 3x, run columns 3x. Extracted `RULE_COLUMNS`, `POLICY_COLUMNS`, `TRASH_COLUMNS`, `RUN_COLUMNS` constants following `asset_repo.rs` COLUMNS pattern. |
| DRY-121 | `verify_exists + NotFound` guard repeated 4x in `assets.rs` handler | PRD-17 | `resolved` | Identical 5-line pattern (verify_exists + AppError::Core(CoreError::NotFound)) in add_dependency, get_impact, add_note, rate_asset. Extracted `ensure_asset_exists(pool, id)` private helper (DRY-097 pattern). |
| DRY-122 | Trash queue status_id magic numbers in `reclamation_repo.rs` | PRD-15 | `watch` | `TRASH_STATUS_PENDING = 1`, `TRASH_STATUS_DELETED = 3`, `TRASH_STATUS_RESTORED = 4` are repo-local constants matching seed ordering. Same fragile pattern as DRY-078 (restart status). Extract to `core/src/trash_status.rs` if a second consumer needs these values. |
| DRY-123 | `STATUS_OPTIONS` hardcoded asset status_id numbers in `AssetBrowser.tsx` | PRD-17 | `watch` | `{ value: "1", label: "Active" }` etc. relies on migration seed ordering. Same pattern as DRY-107 (theme STATUS_OPTIONS). 1 consumer. Fetch from API endpoint or share constants at 2nd consumer. |
| DRY-124 | `ASSET_TYPE_OPTIONS` hardcoded asset type_id numbers in `AssetBrowser.tsx` | PRD-17 | `watch` | `{ value: "1", label: "Model" }` etc. relies on migration seed ordering. 1 consumer. `AssetRepo::list_types()` endpoint exists but is not being called. Fetch dynamically if a 2nd consumer needs type list. |
| DRY-125 | `"required"` and `"info"` magic strings as default values in `asset_repo.rs` | PRD-17 | `watch` | `dependency_role.unwrap_or("required")` and `severity.unwrap_or("info")` -- 1 consumer each. Extract to constants if a 2nd consumer appears. |
| DRY-126 | `"manual"` run_type magic string in reclamation handler | PRD-15 | `watch` | `run_type: "manual".to_string()` in handler. 1 consumer. Extract to `core/src/reclamation_types.rs` constant if a 2nd run_type source (e.g., "scheduled") appears. |
| DRY-131 | Workflow aggregation SELECT columns duplicated in `performance_metric_repo.rs` | PRD-41 | `watch` | 9 identical column expressions in `aggregate_by_workflow` vs `aggregate_for_workflows`. Same pattern as DRY-120 (column constants). Extract `WORKFLOW_AGG_COLUMNS` constant if a 3rd consumer appears. |
| DRY-132 | Scope type magic strings (`"global"`, `"workflow"`, `"worker"`) in `performance.rs` handler | PRD-41 | `watch` | 3 magic strings used in threshold create/update handlers + SQL `scope_type` CHECK. 1 Rust consumer. Extract to `core/src/scope_types.rs` if a 2nd consumer appears. |
| DRY-133 | Worker aggregation SELECT columns duplicated in `performance_metric_repo.rs` | PRD-41 | `watch` | 8 identical column expressions in `aggregate_by_worker` vs `aggregate_single_worker`. Same as DRY-131. Extract `WORKER_AGG_COLUMNS` constant if a 3rd consumer appears. |
| DRY-134 | `parse_from`/`parse_to` date parsing helpers in `performance.rs` handler | PRD-41 | `watch` | Extracts optional `from`/`to` query params, parses with `chrono::NaiveDate::parse_from_str`. 1 consumer. Extract to `api/src/util.rs` if a 2nd handler needs date range parsing. |
| DRY-135 | `renderWithProviders` test helper duplicated across 6 test files | PRD-85, PRD-41, PRD-42, PRD-15, PRD-21, PRD-08 | `resolved` | Extracted to `src/lib/test-utils.tsx`. All 6 consumers (ExtensionManager, PerformanceDashboard, StudioPulse, ReclamationDashboard, VariantGallery, QueueStatusView) now import from shared location. |
| DRY-136 | `parseError` + JSON parse try/catch pattern in 2 sub-components of `ExtensionManager.tsx` | PRD-85 | `watch` | `SettingsEditor` and `InstallForm` both use `useState<string \| null>(null)`, `try { JSON.parse } catch { setParseError }`, and identical error `<p>` display. Same file, 2 instances. Extract shared `useJsonParse` hook if a 3rd JSON-editing component appears. |
| DRY-137 | `collectDesignTokens` in `ExtensionSandbox.tsx` vs `getCssVar` in `MetricsChart.tsx` | PRD-85, PRD-06 | `watch` | Both read CSS custom properties via `getComputedStyle(document.documentElement)`. Different purposes (batch collection vs single lookup). Related to DRY-082. Extract shared `src/lib/css-vars.ts` when a 3rd consumer needs CSS var access. |
| DRY-161 | Confirmation dialog pattern (AlertTriangle + description + Cancel/Action buttons) | PRD-12 | `watch` | `ApiKeyManager.tsx` (rotate/revoke key confirmations) and `WebhookManager.tsx` (delete webhook confirmation) share identical dialog structure: AlertTriangle icon, warning description paragraph, Cancel + destructive Action button pair. 2 consumers. Design system `ConfirmDialog` component candidate at 3rd consumer. Related to DRY-022. |
| DRY-162 | Admin table styling pattern (Card + overflow-x-auto + table + th/td classes) | PRD-12, PRD-85 | `watch` | `ApiKeyManager.tsx`, `WebhookManager.tsx`, `DeliveryLog.tsx`, `ExtensionManager.tsx` all repeat identical Card > overflow-x-auto > table > thead > th class pattern. 4 consumers. Design system `AdminTable` component candidate (threshold met but deferred to design system work). |
| DRY-146 | `formatWait()` + `formatSeconds()` seconds-to-human formatters in queue components | PRD-08 | `watch` | `QueueStatusView.tsx:formatWait(secs)` and `QuotaStatusBadge.tsx:formatSeconds(secs)` are structurally similar to `formatDuration(ms)` from `@/lib/format.ts`. Different input units (seconds vs ms) and slightly different output format. 2 consumers. Extract `formatDurationSeconds()` to `@/lib/format.ts` at 3rd consumer. |
| DRY-147 | `UpdateImageVariant` struct with all `None` fields repeated in handler | PRD-21 | `watch` | `reject_variant` and `export_for_editing` both construct `UpdateImageVariant` with 11 `None` fields. Could add `Default` impl. 2 consumers. Extract at 3rd occurrence. |
| DRY-148 | Multipart upload + validate format + store file pattern in image_variant handler | PRD-21 | `watch` | `reimport_variant` and `upload_manual_variant` share ~30 lines of near-identical multipart parsing, format validation, and file storage logic. 2 consumers. Extract `parse_image_upload()` helper at 3rd upload handler (related to DRY-042). |
| DRY-149 | `state_machine::status_name` duplicates `JobStatus` enum variant names | PRD-08 | `watch` | `core/src/scheduling.rs:status_name()` maps status_id to string names ("Pending", "Running", etc.) which are logically the same as `db/models/status.rs:JobStatus` variant names. Intentional: `core` has zero internal deps so cannot reference `db` types. No action needed unless a 3rd mapping appears. |
| DRY-150 | `off_peak` policy_type magic string in `scheduling_repo.rs` SQL | PRD-08 | `watch` | `'off_peak'` string appears in `find_active_off_peak` query. 1 Rust consumer. Extract to `core/src/scheduling.rs` constant at 2nd consumer (e.g., scheduler engine). |
| DRY-154 | `FailureDiagnostics` (db model) vs `FailureDiagnosticData` (core) near-duplicate | PRD-28 | `watch` | Both structs have same 9 fields; differ in `stage_index` type (`i32` vs `u32`) and `timestamp` type (`Timestamp` vs `String`). Intentional layer separation (db types vs domain types). Merge if types ever align or a 3rd struct appears. |
| DRY-159 | `parse_timestamp` in audit handler vs `parse_from`/`parse_to` in performance handler | PRD-45, PRD-42 | `watch` | Both parse `Option<String>` to `chrono::DateTime<Utc>` with fallback. 2 consumers. Extract to shared `api/src/util.rs` at 3rd consumer (DRY-134 escalated). |
| DRY-160 | Debounce timer pattern (useRef+setTimeout) in persistence hooks | PRD-04, PRD-30, PRD-32, PRD-52 | `flagged` | Now 5 consumers: `useThemePersistence`, `useLayoutPersistence`, `useProficiencyTracker`, `useAutoSave`, `TagInput`. DRY-112 threshold exceeded. Extract `useDebouncedCallback(callback, delayMs)` hook to `src/hooks/`. |
| DRY-171 | Raw `fetch` with `localStorage.getItem("access_token")` bypassing shared `api` client | PRD-66, PRD-16 | `flagged` | `use-metadata-editor.ts` (lines 120, 151) manually reads auth token from localStorage for CSV export/import `fetch` calls. `use-importer.ts` (line 74) uses raw `fetch` with NO auth header at all (potential bug). Shared `api.ts` client already handles auth via `useAuthStore`. These should use `api.post()`/`api.get()` or at minimum import from `useAuthStore` instead of reading localStorage directly. 3 instances across 2 files. |
| DRY-172 | `formatValue()` in `CsvImport.tsx` and `formatCellValue()` in `MetadataSpreadsheet.tsx` | PRD-66 | `watch` | Both functions handle null/undefined/boolean/array/object -> string formatting. `CsvImport.tsx:222-226` and `MetadataSpreadsheet.tsx:301-305` have near-identical logic with minor presentation differences (CsvImport uses `JSON.stringify` for objects, Spreadsheet returns `[Array]`/`[Object]`). 2 consumers in same feature. Extract shared `formatMetadataValue()` to `features/metadata-editor/utils.ts` if a 3rd display context appears. |
| DRY-173 | Inline `new Date().toLocaleString()` instead of `formatDateTime` from `@/lib/format.ts` | PRD-13 | `watch` | `StalenessIndicator.tsx:58` uses `new Date(generatedAt).toLocaleString()` instead of the shared `formatDateTime()` utility. 1 consumer. Fix when file is next touched. |
| DRY-177 | Import status constants overlap between `importer.rs` and `import_status.rs` | PRD-16, PRD-14 | `watch` | `core/src/importer.rs` defines `SESSION_STATUS_UPLOADING/MAPPING/PREVIEWING/COMMITTED/CANCELLED/FAILED` while `core/src/import_status.rs` defines `IMPORT_STATUS_PREVIEW/COMMITTED/PARTIAL/FAILED/CANCELLED`. Different lifecycle stages (session vs import batch) but conceptually related. Watch for confusion. No action needed unless a handler needs both sets. |
| DRY-178 | `PhysicalAttributes` struct in `metadata_editor.rs` vs field definitions | PRD-66, PRD-13 | `watch` | `core/src/metadata_editor.rs` defines `PhysicalAttributes` struct with typed fields and also has `FIELD_DEFINITIONS` array describing the same fields as metadata. Intentional dual representation (typed struct for validation vs field defs for dynamic UI). Watch for divergence if fields are added to one but not the other. |
| DRY-181 | Identical `onSuccess` invalidation in 3 review mutation hooks | PRD-35 | `flagged` | `useApproveSegment`, `useRejectSegment`, `useFlagSegment` in `use-review.ts` have identical `onSuccess` callbacks (invalidate approvals + all review keys) and same `mutationFn` shape `({ segmentId, input }) => api.post(...)`. Extract `useDecisionMutation<TInput>(endpoint)` factory. ~40 lines of duplication. |
| DRY-185 | Magic timing thresholds 1000/5000 in `WorkflowCanvas.tsx` duplicate backend constants | PRD-33 | `flagged` | Inline `executionMs < 1000 ? green : < 5000 ? yellow : red` duplicates `TIMING_FAST_MS`/`TIMING_MODERATE_MS` from `core/src/workflow_canvas.rs`. Extract frontend constants to `types.ts` with sync comment + `timingColorClass()` utility. |
| DRY-186 | `RejectionDialog.tsx` hand-rolls modal overlay instead of `Modal` composite | PRD-35 | `flagged` | Custom `fixed inset-0 z-50 bg-black/50` overlay with manual positioning, missing keyboard handling (Escape), focus trapping. Shared `Modal` component at `@/components/composite/Modal` used by 11+ components. Refactor to use `<Modal>`. |
| DRY-187 | Inline loading spinner in `WorkflowCanvas.tsx` instead of `Spinner` primitive | PRD-33 | `flagged` | `animate-spin rounded-full border-2 border-current border-t-transparent` hand-rolled spinner. Shared `Spinner` component at `@/components/primitives/Spinner` used by 30+ components. Replace with `<Spinner />` import. |
| DRY-188 | Inline `toLocaleDateString()` in `BugReportList.tsx` instead of `formatDate` | PRD-44 | `flagged` | `new Date(report.created_at).toLocaleDateString()` at line 115. Shared `formatDate(iso)` exists in `@/lib/format.ts`. Same violation as DRY-157 and DRY-173. Replace with `formatDate(report.created_at)`. |
| DRY-200 | TourEngine overlay lacks Escape key handler and focus trapping | PRD-53 | `watch` | `TourEngine.tsx` hand-rolls `fixed inset-0 z-50` overlay without keyboard handling (Escape key) or focus trapping, unlike shared `Modal` composite. Tour has specialized behavior (spotlight, step navigation) making `Modal` a poor fit. Add Escape handler when interactive features mature. |
| DRY-210 | Local `formatDate()` in `WorkerDetailPanel.tsx` instead of shared `formatDateTime` | PRD-46 | `resolved` | Custom `formatDate(iso)` function returning `new Date(iso).toLocaleString()` -- behavioral duplicate of `formatDateTime()` from `@/lib/format.ts`. Replaced with `formatDateOrDash()` wrapper using shared `formatDateTime` import. |
| DRY-211 | Inline `BadgeVariant` union type in `workers/types.ts` | PRD-46 | `resolved` | `"success" \| "warning" \| "danger" \| "default"` inline union type in `WORKER_STATUS_VARIANT` Record instead of importing `BadgeVariant` from `@/components/primitives/Badge`. Replaced with import. Also added `WORKER_STATUS` named constants object to eliminate magic status_id numbers in the same file. |
| DRY-214 | Inline SVG close icon in `LowConfidenceWarning.tsx` | PRD-76 | `resolved` | Hand-coded 7-line `<svg>` element for close/dismiss button. Replaced with `<X size={16} />` from `@/tokens/icons`. Same pattern as DRY-105 (TagChip inline SVG). |
| DRY-217 | Magic number `4` for draining status in `WorkerDetailPanel.tsx` | PRD-46 | `resolved` | Hardcoded `worker.status_id !== 4` in conditional rendering. Replaced with `worker.status_id !== WORKER_STATUS.DRAINING` using named constant from `workers/types.ts`. |

### API & Data Fetching

| ID | Pattern / Component | PRDs Involved | Status | Notes |
|----|---------------------|---------------|--------|-------|
| DRY-040 | React Query / data fetching hooks | All frontend PRDs | `watch` | `useQuery`/`useMutation` patterns will repeat — establish hook conventions early |
| DRY-041 | WebSocket event subscription pattern | PRD-05, PRD-10, PRD-11 | `watch` | Real-time updates from event bus will be consumed by many components |
| DRY-042 | File upload handling | PRD-16, PRD-21, PRD-86 | `watch` | Multiple PRDs accept file uploads — shared upload component + backend handler |
| DRY-043 | CSV/report export pattern | PRD-22, PRD-73, PRD-94 | `watch` | Several PRDs export data as CSV — shared export utility |

### Pipeline & Generation

| ID | Pattern / Component | PRDs Involved | Status | Notes |
|----|---------------------|---------------|--------|-------|
| DRY-060 | FFmpeg command builder | PRD-24, PRD-25, PRD-39, PRD-83 | `resolved` | Implemented in `core/src/ffmpeg.rs`. PRD-24/25/39 will reuse `probe_video`, `extract_frame_thumbnail`, `extract_thumbnails_at_interval`. |
| DRY-091 | 10x `.map_err(\|e\| AppError::InternalError(e.to_string()))` in `handlers/video.rs` | PRD-83 | `watch` | Add `From<FfmpegError>` impl to `AppError` to eliminate 6 of 10. Watch for `From<io::Error>` as more file-serving handlers appear. |
| DRY-061 | Image quality scoring | PRD-22, PRD-49, PRD-76 | `watch` | First consumer (PRD-22) now live. `run_python_script` helper, `determine_status`, `compute_overall_status` in `api/src/handlers/image_qa.rs`. Python scripts in `scripts/python/qa/`. Shared runner in `qa/__init__.py`. When PRD-49/PRD-76 arrive, consider extracting `run_python_script` to a shared module. |
| DRY-070 | QA check type name strings across Rust + Python + SQL | PRD-22 | `watch` | Check type names (`"resolution"`, `"format"`, `"face_detection"`, etc.) appear in migration seed data, Rust handler constants (`CHECKS_*`), and Python script output keys. Currently 3 consumers. If a 4th consumer appears (e.g., frontend), extract to `core/src/qa_checks.rs`. |
| DRY-071 | Python QA script status classification pattern | PRD-22 | `watch` | `"pass" if X else ("warn" if Y else "fail")` ternary appears 7x across 3 scripts. Shared `classify_score()` in `qa/__init__.py` is available but scripts not yet refactored to use it (different threshold logic per check). Refactor when adding new QA scripts. |
| DRY-062 | ComfyUI workflow submission pattern | PRD-05, PRD-24, PRD-58 | `watch` | Workflow dispatch to ComfyUI will be called from multiple orchestrators |

---

## Resolved

| ID | Original Pattern | Resolution | Shared Location | Date |
|----|-----------------|------------|-----------------|------|
| DRY-012 | `resolve_role_name` duplicated in auth.rs + admin.rs | Extracted to `RoleRepo::resolve_name()` | `db/src/repositories/role_repo.rs` | 2026-02-20 |
| DRY-013 | Role magic strings hardcoded in rbac.rs | Created `ROLE_ADMIN/CREATOR/REVIEWER` constants | `core/src/roles.rs` | 2026-02-20 |
| DRY-019 | Channel name magic strings in router, digest, handlers | Created `CHANNEL_IN_APP/DIGEST/WEBHOOK/EMAIL` constants | `core/src/channels.rs` | 2026-02-20 |
| DRY-072 | QA status magic strings (`"pass"`, `"warn"`, `"fail"`) in Rust handler | Created `QA_PASS/QA_WARN/QA_FAIL` constants + Python `QA_PASS/QA_WARN/QA_FAIL` | `core/src/qa_status.rs`, `scripts/python/qa/__init__.py` | 2026-02-20 |
| DRY-073 | Python QA script `__main__` boilerplate (13 lines x 3 scripts) | Extracted `run_check_cli()` shared runner | `scripts/python/qa/__init__.py` | 2026-02-20 |
| DRY-075 | Import status magic strings + `status_id != 1` magic number | Created `IMPORT_STATUS_*` constants + `IMPORT_STATUS_PREVIEW_ID` | `core/src/import_status.rs` | 2026-02-20 |
| DRY-080 | `DataResponse<T>` typed response envelope local to `hardware.rs` | Extracted to shared `api/src/response.rs` module | `api/src/response.rs` | 2026-02-21 |
| DRY-084 | Script type name magic strings in orchestrator.rs | Created `SCRIPT_TYPE_SHELL/PYTHON/BINARY` constants | `core/src/script_types.rs` | 2026-02-21 |
| DRY-060 | FFmpeg command builder duplicated across PRDs | Shared `probe_video`, `extract_frame_thumbnail`, `extract_thumbnails_at_interval` | `core/src/ffmpeg.rs` | 2026-02-21 |
| DRY-087 | `AudioTrackInfo` struct duplicated in core + db | Removed duplicate from `db/models/video.rs`, re-export from `core::ffmpeg` | `core/src/ffmpeg.rs` | 2026-02-21 |
| DRY-088 | `"storage/thumbnails"` path literal duplicated 2x in handler | Extracted `THUMBNAIL_STORAGE_DIR` constant + `thumbnail_dir()` helper | `api/src/handlers/video.rs` | 2026-02-21 |
| DRY-089 | "Find first video stream" iteration pattern 5x in ffmpeg.rs | Extracted `first_video_stream()` private helper | `core/src/ffmpeg.rs` | 2026-02-21 |
| DRY-090 | `ADMIN_ROLE` constant redefined in jobs.rs (duplicate of `ROLE_ADMIN`) | Replaced local constant with import of `ROLE_ADMIN` from `core/src/roles.rs` | `core/src/roles.rs` (existing) | 2026-02-21 |
| DRY-092 | `list_by_user` / `list_all` structural duplicate in job_repo.rs | Extracted shared `list_jobs()` private method | `db/src/repositories/job_repo.rs` | 2026-02-21 |
| DRY-094 | Magic status_id numbers `1, 2` in dispatcher.rs SQL | Replaced with `JobStatus::Pending.id()` / `JobStatus::Running.id()` binds | `api/src/engine/dispatcher.rs` | 2026-02-21 |
| DRY-095 | Job WS message type magic strings in progress.rs | Created `MSG_TYPE_JOB_*` constants | `core/src/job_events.rs` | 2026-02-21 |
| DRY-096 | serde_json + Message::Text + broadcast repeated 4x | Extracted `broadcast_json()` helper | `api/src/engine/progress.rs` | 2026-02-21 |
| DRY-097 | Find + authorize ownership pattern 3x in jobs.rs | Extracted `find_and_authorize()` helper | `api/src/handlers/jobs.rs` | 2026-02-21 |
| DRY-099 | `TagSuggestion` structurally identical to `TagWithCount` | Unified to single `TagWithCount` type exported from `TagChip.tsx` | `src/components/domain/TagChip.tsx` | 2026-02-21 |
| DRY-101 | Inline `prefix.trim().to_lowercase()` in `suggest()` | Replaced with call to existing `normalize_tag_name()` | `db/src/repositories/tag_repo.rs` | 2026-02-21 |
| DRY-017 | Middleware/router construction duplicated in main.rs and tests | Extracted `build_app_router()` to `trulience_api::router` module | `api/src/router.rs` | 2026-02-21 |
| DRY-108 | `TokenEditor.tsx` 670-line god component with 7 section components + 6x duplicate updaters | Split sections to `token-editor/TokenSections.tsx`, replaced 6 updaters with generic `updateTokenSection<K>()` | `features/admin/token-editor/TokenSections.tsx` | 2026-02-21 |
| DRY-109 | `TagWithCount` redundantly re-exported from `TagInput.tsx` and `TagFilter.tsx` | Removed re-exports; canonical source is `TagChip.tsx` | `components/domain/TagChip.tsx` (existing) | 2026-02-21 |
| DRY-110 | `CATEGORY_LABELS` + `CATEGORY_ORDER` duplicated in CheatSheet + KeymapEditor | Extracted to `ShortcutRegistry.ts` with `groupBindingsByCategory()` utility | `features/shortcuts/ShortcutRegistry.ts` | 2026-02-21 |
| DRY-111 | `snapValue()` duplicated in `useSnapGrid.ts` + `usePanelResize.ts` | Exported from `useSnapGrid.ts`, imported in `usePanelResize.ts` | `features/layout/useSnapGrid.ts` | 2026-02-21 |
| DRY-116 | `export_keymap` handler duplicate JSON branches | Extracted shared destructuring with fallback defaults | `api/src/handlers/keymaps.rs` | 2026-02-21 |
| DRY-117 | `formatFileSize()` duplicated in AssetBrowser + AssetDetail | Removed duplicate, replaced with `formatBytes` from shared `@/lib/format.ts` | `src/lib/format.ts` (existing) | 2026-02-21 |
| DRY-118 | `formatDate()` inline helper in AssetDetail.tsx | Extracted to shared `formatDate()` in `@/lib/format.ts` | `src/lib/format.ts` | 2026-02-21 |
| DRY-119 | `serde_json::json!` (11x) in reclamation.rs instead of `DataResponse<T>` | Migrated all 11 endpoints to `DataResponse<T>` with `impl IntoResponse` return | `api/src/handlers/reclamation.rs` | 2026-02-21 |
| DRY-120 | Column list repeated 15x in reclamation_repo.rs | Extracted `RULE_COLUMNS`, `POLICY_COLUMNS`, `TRASH_COLUMNS`, `RUN_COLUMNS` constants | `db/src/repositories/reclamation_repo.rs` | 2026-02-21 |
| DRY-121 | `verify_exists + NotFound` guard 4x in assets.rs handler | Extracted `ensure_asset_exists(pool, id)` private helper | `api/src/handlers/assets.rs` | 2026-02-21 |
| DRY-102 | Click-outside pattern 3x (TagInput, Dropdown, JobTrayPanel) | Extracted `useClickOutside(ref, callback, enabled?)` hook | `src/hooks/useClickOutside.ts` | 2026-02-21 |
| DRY-127 | `formatTime()` duplicated in CinemaMode + GridControls | Removed locals, replaced with `formatDuration` from `video-player/frame-utils` | `features/video-player/frame-utils.ts` (existing) | 2026-02-21 |
| DRY-128 | Recharts Tooltip contentStyle 7x across 3 chart components | Extracted `TOOLTIP_CONTENT_STYLE`, `AXIS_TICK_STYLE`, `GRID_STROKE` | `features/dashboard/performance/chartStyles.ts` | 2026-02-21 |
| DRY-129 | `formatElapsed()` reimplements formatDuration logic | Refactored to delegate to shared `formatDuration(seconds*1000)` | `src/lib/format.ts` (existing) | 2026-02-21 |
| DRY-138 | `enable_extension`/`disable_extension` structural duplicate (22 identical lines) | Extracted shared `toggle_extension(state, id, user_id, enabled)` helper | `api/src/handlers/extensions.rs` | 2026-02-21 |
| DRY-139 | Textarea styling 9-line `cn()` block duplicated in SettingsEditor + InstallForm | Extracted `TEXTAREA_BASE_CLASSES` + `textareaBorderClass()` | `features/extensions/ExtensionManager.tsx` | 2026-02-21 |
| DRY-140 | Frontend `methodToAccess` mapped POST/PUT/DELETE to "create"/"update"/"delete" but backend `KNOWN_ACCESS_LEVELS` only defines `["read", "write"]` | Aligned frontend to use "write" for all mutating methods | `features/extensions/ExtensionApiBridge.ts` | 2026-02-21 |
| DRY-141 | `formatFileSize()` in `SourceImageUpload.tsx` duplicated `formatBytes()` from `@/lib/format.ts` | Removed local, replaced with `formatBytes` import | `src/lib/format.ts` (existing) | 2026-02-21 |
| DRY-142 | `formatDate()` local in `VariantHistory.tsx` duplicated `formatDateTime()` from `@/lib/format.ts` | Removed local, replaced with `formatDateTime` import | `src/lib/format.ts` (existing) | 2026-02-21 |
| DRY-143 | `"storage/variants"` path literal duplicated 2x in `image_variant.rs` handler | Extracted `VARIANT_STORAGE_DIR` constant + `ensure_variant_dir()` helper | `api/src/handlers/image_variant.rs` | 2026-02-21 |
| DRY-135 | `renderWithProviders` test helper duplicated across 6 test files | Extracted to shared `src/lib/test-utils.tsx`, all 6 consumers refactored | `src/lib/test-utils.tsx` | 2026-02-21 |
| DRY-145 | `image_variant.rs` handler used raw `Json<T>` instead of `DataResponse<T>` (10 endpoints) | Migrated all endpoints to `DataResponse<T>` with `impl IntoResponse` | `api/src/handlers/image_variant.rs` | 2026-02-21 |
| DRY-151 | `formatBytes()` duplicated in `checkpoints/types.ts` (behavioral duplicate of `@/lib/format.ts`) | Removed local, re-exported from `@/lib/format` | `src/lib/format.ts` (existing) | 2026-02-21 |
| DRY-152 | `find_and_authorize_job` in `checkpoints.rs` -- line-for-line copy of `find_and_authorize` in `jobs.rs` | Made `jobs::find_and_authorize` pub, imported in checkpoints.rs | `api/src/handlers/jobs.rs` (existing) | 2026-02-21 |
| DRY-153 | Raw `INSERT INTO jobs` SQL with inline COLUMNS in `checkpoints.rs` handler | Extracted `JobRepo::resume_from_checkpoint()` method, handler now delegates to repo | `db/src/repositories/job_repo.rs` | 2026-02-21 |
| DRY-155 | Query/count filter duplication (45+ identical lines) in `audit_repo.rs` | Extracted `build_audit_filter()` + `bind_audit_values()` shared helpers | `db/src/repositories/audit_repo.rs` | 2026-02-21 |
| DRY-156 | `serde_json::json!` in `checkpoints.rs` diagnostics + `audit.rs` query response | Replaced with typed `JobDiagnosticsResponse` struct and `AuditLogPage` struct | `api/src/handlers/checkpoints.rs`, `db/src/models/audit.rs` | 2026-02-21 |
| DRY-163 | SearchBar.tsx inline click-outside (addEventListener/removeEventListener) | Replaced with shared `useClickOutside` hook import | `src/hooks/useClickOutside.ts` (existing) | 2026-02-21 |
| DRY-164 | Duplicate search execution logic in `unified_search` + `execute_saved_search` | Extracted `run_search(pool, params)` private async helper | `api/src/handlers/search.rs` | 2026-02-21 |
| DRY-165 | Duplicate term sanitization in `build_tsquery` + `build_prefix_tsquery` | Extracted `sanitize_terms(query)` private helper | `core/src/search.rs` | 2026-02-21 |
| DRY-166 | Webhook handler inline pagination clamping (`unwrap_or(50).min(200)`) | Replaced with `clamp_limit`/`clamp_offset` from core | `core/src/search.rs` (existing) | 2026-02-21 |
| DRY-191 | `handleTourComplete` and `handleTourSkip` identical callbacks in `OnboardingGate.tsx` | Merged into single `handleTourEnd` callback | `features/onboarding/OnboardingGate.tsx` | 2026-02-21 |
| DRY-192 | `PLACEMENT_CLASSES` duplicated in `ContextualHint.tsx` (identical to Tooltip.tsx `POSITION_CLASSES`) | Exported `Placement` type and `PLACEMENT_CLASSES` from `Tooltip.tsx`, imported in ContextualHint | `components/primitives/Tooltip.tsx` | 2026-02-21 |
| DRY-193 | Placement union type `"top"\|"bottom"\|"left"\|"right"` repeated 4x in onboarding | Extracted shared `Placement` type from Tooltip, used in `types.ts`, `ContextualHint.tsx`, `hintDefinitions.ts` | `components/primitives/Tooltip.tsx`, `features/onboarding/types.ts` | 2026-02-21 |
| DRY-194 | Redundant `idx_user_onboarding_user_id` index duplicates unique index on same column | Removed redundant plain index (unique index provides same coverage) | `migrations/20260221000052_create_user_onboarding.sql` | 2026-02-21 |
| DRY-195 | Dismiss-button styling class repeated 3x across onboarding components | Extracted `DISMISS_LINK_CLASSES` constant to `types.ts`, used in TourEngine, OnboardingChecklist, ContextualHint | `features/onboarding/types.ts` | 2026-02-21 |
| DRY-196 | `HintDefinition` interface defined in `hintDefinitions.ts` instead of canonical `types.ts` | Moved type to `types.ts`, re-exported from `hintDefinitions.ts` | `features/onboarding/types.ts` | 2026-02-21 |
| DRY-197 | `validate_checklist_item`/`validate_feature_key` structurally identical validation patterns | Extracted generic `validate_known_key`/`validate_known_keys` private helpers | `core/src/onboarding.rs` | 2026-02-21 |
| DRY-198 | `get_or_create` used 2-query pattern (INSERT DO NOTHING + SELECT fallback) | Refactored to single-query `DO UPDATE SET user_id = user_onboarding.user_id` pattern (matches `workspace_repo.rs`) | `db/src/repositories/onboarding_repo.rs` | 2026-02-21 |

---

## DRY-GUY Audit Log

Record of every DRY-GUY audit run against the codebase.

| Date | PRD(s) Touched | Files Audited | Findings | Action Taken |
|------|---------------|---------------|----------|--------------|
| 2026-02-20 | Phase -1 scaffold | 33 (11 Rust, 14 Frontend, 8 Infra) | 6 (0 critical, 3 medium, 3 low) | Fixed CI DATABASE_URL dedup, vitest config merge, Storybook color comment. Watch: tracing init, Docker anchors. |
| 2026-02-20 | PRD-00 Database Normalization | 12 (2 Rust lib, 2 Rust test, 1 API, 4 SQL, 2 docs, 1 DRY-TRACKER) | 3 (0 critical, 1 medium, 2 low) | All acceptable/deferred. Medium: tracing init (2 binaries, extract at 3). Low: SQL filter clause in tests (readable as-is), lookup DDL repetition (mitigated by template migration 000003). No code changes needed. |
| 2026-02-20 | PRD-01 Phase 4 (API Endpoints) | 17 (8 handlers, 5 routes, 1 error, 1 lib, 1 test helper, 1 main) | 2 low, rest acceptable | No changes. NotFound construction (19x) and delete-if pattern (8x) are thin-adapter repetition. DRY-003 stays `watch`. scene_type.rs correctly deduplicates dual-scope via inner helpers. |
| 2026-02-20 | PRD-01 Test Files (entity_crud, entity_api, schema_conventions) | 8 test files across db+api crates | 2 HIGH (extracted), 1 MEDIUM (watch), 2 LOW (acceptable) | Extracted `body_json`, `post_json`, `put_json`, `get`, `delete`, `send_json` to `api/tests/common/mod.rs`. Unified `post_json`/`put_json` via `send_json` base. Refactored health.rs + entity_api.rs to use shared helpers. Watch: entity_crud.rs fixtures if second api test needs them. |
| 2026-02-20 | PRD-109 Phases 5-6 (Trash API + Delivery) | 12 (1 trash_repo, 5 entity repos modified, 1 trash handler, 1 trash route, 1 delivery.rs, 1 handlers/mod, 1 routes/mod, 1 repos/mod) | 1 HIGH (dead code), 2 MEDIUM (watch), 2 LOW, 4 CLEAN | HIGH: `find_by_id_include_deleted` on 5 individual repos is dead code (uncalled) — recommend removal. MEDIUM: DRY-009 confirmed (27 identical soft_delete/restore/hard_delete methods across 9 repos), DRY-011 added (5 parallel entity-type lists). LOW: fallback in `table_and_name_expr`, dispatch_restore inherent to architecture. CLEAN: delivery.rs, route file, handler pattern. |
| 2026-02-20 | PRD-03 Phases 1-6 (User Identity & RBAC) | 19 new + 9 modified (3 SQL migrations, 3 db models, 3 db repos, 3 auth modules, 2 middleware modules, 2 handler modules, 2 route modules, 1 config) | 2 flagged (DRY-012, DRY-013), 2 watch (DRY-014, DRY-015), 3 LOW, rest CLEAN | FLAGGED: `resolve_role_name` duplicated between auth.rs and admin.rs (DRY-012); role name magic strings in rbac.rs (DRY-013). WATCH: validate+hash pattern 2x in admin.rs (DRY-014), RBAC extractor boilerplate at 3 impls (DRY-015). LOW: `"Account is deactivated"` 2x in auth.rs (same file, different paths), `UserInfo` vs `UserResponse` (intentionally different scopes), `"unknown"` fallback (resolves with DRY-012). CLEAN: password.rs, jwt.rs, AuthUser extractor, all repos, all routes, all migrations, test config. |
| 2026-02-20 | PRD-05 (ComfyUI WebSocket Bridge) | 8 new + 6 modified (8 comfyui crate files, 2 db model/repo files, 2 db repo files, 2 migration files, 2 Cargo.toml, 1 state.rs, 1 main.rs, 1 tests/common/mod.rs) | 1 FLAGGED (DRY-017), 1 MEDIUM fixed, 1 LOW fixed, 1 MEDIUM watch (DRY-016), 3 LOW acceptable, rest CLEAN | FIXED: `api.rs` internal duplication -- extracted `ensure_success()` helper to deduplicate `parse_response`/`check_status` (eliminated 7 duplicate lines). FIXED: `reqwest` and `tokio-util` not in workspace deps -- moved to `workspace.dependencies` with `workspace = true` in comfyui Cargo.toml. FLAGGED: DRY-017 middleware stack duplication between main.rs and tests/common/mod.rs (worsened by PRD-05 adding comfyui_manager). WATCH: DRY-016 find_by_prompt_id+event pattern (2x in processor.rs). LOW: UUID client_id generation 2x (different purposes), execution status SQL strings (encapsulated behind methods), instance status strings (migration-only). CLEAN: messages.rs, events.rs, reconnect.rs, client.rs, manager.rs structure, db models, db repos, migrations. |
| 2026-02-20 | PRD-10 (Event Bus & Notification System) | 22 files (8 events crate, 5 db models/repos, 4 api handlers/routes, 3 api notification module, 2 migrations) + 7 modified (state, main, test common, ws/manager, lib, routes/mod, handlers/mod) | 1 CRITICAL fixed, 3 HIGH (2 fixed, 1 worsened), 1 MEDIUM fixed, 2 LOW acceptable | FIXED (CRITICAL): `persistence.rs` duplicated `INSERT INTO events` SQL + `SELECT id FROM event_types` -- refactored to call `EventRepo::insert()` and `EventRepo::get_event_type_by_name()`, eliminating 18 lines of duplicate SQL. FIXED (HIGH): `digest.rs` duplicated "users due for digest" query with divergent SQL (hardcoded hourly/daily vs repo's `digest_interval::interval` cast) + raw SQL for marking notifications delivered + updating last-sent timestamp -- refactored to call `NotificationPreferenceRepo::list_users_due_for_digest()`, `NotificationRepo::pending_count_for_channel()`, `NotificationRepo::mark_channel_delivered()`, and `NotificationPreferenceRepo::mark_digest_sent()`. Added 2 new methods to NotificationRepo and 1 to NotificationPreferenceRepo. FIXED (MEDIUM): Channel name magic strings (`"in_app"`, `"digest"`) in 7 locations -- extracted to `core/src/channels.rs` constants (DRY-019 resolved). WORSENED: DRY-017 (middleware/router duplication) now includes `event_bus` in AppState. WATCH: DRY-018 added (broadcast recv loop pattern, 2 instances). LOW: `find_latest_event_id` called 2x in router.rs (internal, different paths), webhook retry vs comfyui reconnect (different purposes). CLEAN: bus.rs, delivery/mod.rs, email.rs, webhook.rs, all db models, all migrations, notification route, notification handler, WsManager.send_to_user. |
| 2026-02-20 | PRD-14 (Data Validation & Import Integrity) | 14 (3 SQL migrations, 5 core validation module files, 2 db repos, 2 db models, 1 handler, 1 route) + 3 modified (core lib.rs, handlers/mod.rs, routes/mod.rs) | 1 HIGH fixed, 2 MEDIUM (1 fixed, 1 watch), 1 LOW watch | FIXED (HIGH): Import status magic strings `"preview"`, `"committed"` and `status_id != 1` magic number in handler — extracted `IMPORT_STATUS_PREVIEW/COMMITTED/PARTIAL/FAILED/CANCELLED` and `IMPORT_STATUS_PREVIEW_ID` to `core/src/import_status.rs` (DRY-075, following DRY-013/DRY-019/DRY-072 pattern). FIXED (MEDIUM): Near-duplicate SQL in `validation_rule_repo.rs` — `load_rules` and `list_by_entity_type` differed only by `AND vr.is_active = true` — extracted shared `query_rules(active_only: bool)` private method. FIXED (MEDIUM): Fragile `ImportAction` serialization using `format!("{:?}", ...)` in handler — added `ImportAction::as_str()` returning stable serde-aligned strings. WATCH: DRY-074 (rule type name strings, 1 consumer), DRY-076 (source_type `"api"` literal, 1 consumer). CLEAN: evaluator.rs unit tests, conflict.rs logic, import_preview.rs types, all SQL migrations, integration test file, route registration. |
| 2026-02-20 | PRD-22 (Source Image Quality Assurance) | 16 (3 SQL migrations, 1 model, 3 repos, 1 handler, 1 route, 3 Python scripts, 1 Python __init__, 3 mod.rs) + cross-ref to core/src | 2 CRITICAL fixed, 1 HIGH fixed, 2 MEDIUM watch (DRY-070, DRY-071), 1 LOW acceptable | FIXED (CRITICAL BUG): Missing UNIQUE constraint on `(project_id, check_type_id)` in migration 000022 -- `ON CONFLICT` upsert would have failed at runtime. Added `COALESCE(project_id, 0)` expression index + matching upsert SQL. FIXED (CRITICAL BUG): Handler parsed Python output as bare array but scripts return `{"results": [...]}` dict -- would have failed with "Expected array". Updated to extract `"results"` key. FIXED (HIGH): QA status magic strings `"pass"/"warn"/"fail"` in 10 locations in `image_qa.rs` -- extracted `QA_PASS/QA_WARN/QA_FAIL` to `core/src/qa_status.rs`, following established pattern (DRY-013 roles, DRY-019 channels). Also added Python-side constants in `qa/__init__.py`. FIXED (HIGH): Python `__main__` boilerplate (13 lines x 3 scripts = 39 lines identical) -- extracted `run_check_cli()` to `qa/__init__.py`. WATCH: DRY-070 (check type name strings across 3 boundaries), DRY-071 (Python status classification ternary 7x). LOW: `list_by_character` vs `list_by_character_source` structural similarity (thin-adapter, acceptable). CLEAN: models, qa_check_type_repo, routes, mod.rs exports, migration 000020, migration 000021. |
| 2026-02-21 | PRD-06 (Hardware Monitoring) -- initial | 24 files (3 SQL migrations, 3 core modules, 1 core hardware submod, 1 core hardware/thresholds, 3 db repos, 1 db model, 1 api handler, 1 api route, 1 api background/mod, 1 api background/metrics_retention, 4 agent crate files, 1 api lib, 1 api response.rs new) + cross-ref to comfyui/reconnect.rs, db/image_qa_threshold_repo | 3 HIGH fixed, 1 FLAGGED (DRY-077), 4 WATCH (DRY-078, DRY-079, DRY-081), rest CLEAN | FIXED (HIGH): `UpdateWorkerThresholdsRequest` and `UpdateGlobalThresholdsRequest` were identical structs -- merged into single `UpdateThresholdsRequest`. FIXED (HIGH): `MetricThresholdRepo::update_global()` was a copy of `upsert()` with `worker_id=NULL` hardcoded (identical SQL, 14 duplicate lines) -- removed, handler now calls `upsert()` with `worker_id: None`. FIXED (HIGH): `DataResponse<T>` response envelope struct was local to `hardware.rs` -- extracted to shared `api/src/response.rs` (DRY-080). FIXED (MEDIUM): INSERT column list duplicated between `GpuMetricRepo::insert()` and `insert_batch()` -- extracted `INSERT_COLUMNS` constant. FIXED (MEDIUM): `"gpu_metrics"` WS message type string duplicated between agent `sender.rs` and API `hardware.rs` -- added `MSG_TYPE_GPU_METRICS` constant to `core/src/metric_names.rs`, API handler now uses it, agent has sync comment. FIXED (LOW): Missing `Default` impl for `MetricsCollector` (clippy warning). FLAGGED: DRY-077 -- tracing init now at 3 binaries (agent is 3rd), extraction threshold met. WATCH: DRY-078 (restart status_id magic numbers), DRY-079 (metric name strings SQL/Rust boundary), DRY-081 (agent vs ComfyUI reconnect strategies). CLEAN: collector.rs, restart.rs, thresholds.rs evaluator, alert.rs, all migrations, routes, background/metrics_retention. |
| 2026-02-21 | PRD-06 (Hardware Monitoring) -- re-audit | 29 PRD-06 files + 9 comparison files (notification.rs, validation.rs, digest.rs, main.rs, tests/common, StatusBadge.tsx, api.ts, worker/main.rs, ThumbnailCard.tsx) | 3 HIGH (2 fixed, 1 flag-only), 4 MEDIUM (1 fixed, 2 watch, 1 pre-existing), 2 LOW acceptable | FIXED (HIGH): Agent `sender.rs` used hardcoded `"gpu_metrics"` + `"restart_result"` strings instead of `MSG_TYPE_GPU_METRICS` constant -- added `trulience-core` dep to agent crate, imported constant, added new `MSG_TYPE_RESTART_RESULT` constant. FIXED (HIGH): `update_worker_thresholds` and `update_global_thresholds` were 19-line structural duplicates differing only in `worker_id` -- extracted shared `upsert_thresholds()` helper. FLAGGED (HIGH): DRY-083 -- `notification.rs` (7x) and `validation.rs` (7x) still use `serde_json::json!` instead of `DataResponse<T>`. FIXED (MEDIUM): WorkerCard.tsx missing `ease-[var(--ease-default)]` in transition class. WATCH: DRY-082 (`getCssVar` utility, 1 consumer). MEDIUM: Test threshold fixture duplication (acceptable -- test isolation). LOW: Power/fan display rows in WorkerCard (2 instances, same component), centering divs in MetricsChart (2 instances, same component). CLEAN: all repos, all migrations, routes, background tasks, all other frontend components. |
| 2026-02-21 | PRD-09 (Multi-Runtime Script Orchestrator) | 16 new + 2 migrations + 2 modified (main.rs, state.rs) + cross-ref to image_qa.rs, tests/common/mod.rs, response.rs | 1 HIGH fixed (DRY-084), 1 MEDIUM fixed (test helper), 2 WATCH (DRY-085, DRY-086), rest CLEAN | FIXED (HIGH): Script type name magic strings `"shell"`, `"python"`, `"binary"` in 4 locations in `orchestrator.rs` -- extracted `SCRIPT_TYPE_SHELL/PYTHON/BINARY` to `core/src/script_types.rs` (DRY-084, following DRY-013/DRY-019/DRY-072 pattern). FIXED (MEDIUM): `default_input()` test helper duplicated identically in `shell.rs` and `binary.rs` -- extracted to shared `scripting::test_helpers::default_input()` in `scripting/mod.rs`. WATCH: DRY-085 (QA handler `run_python_script` vs scripting subprocess -- behavioral duplicate, different interfaces prevent direct merge). WATCH: DRY-086 (`"VENV_DIR"` env var name literal in 2 files, 2 crates). CLEAN: executor.rs (well-factored trait + types), subprocess.rs (single `run_command`), python.rs (venv management), status.rs (numeric constants matching established pattern), all DB models, both repos (clean COLUMNS/JOIN pattern), all handlers (properly use `DataResponse<T>`), routes, migrations, orchestrator lifecycle logic, mod.rs exports. DRY-017 worsened (AppState now has `script_orchestrator` field requiring parallel update in tests/common). |
| 2026-02-21 | PRD-09 (Multi-Runtime Script Orchestrator) -- re-audit | 21 files (16 PRD-09 + cross-ref to auth_api.rs, hardware_api.rs, common/mod.rs, image_qa.rs, notification.rs) | 2 HIGH fixed, 1 MEDIUM fixed, 3 MEDIUM watch, rest CLEAN | FIXED (HIGH): `build_app_with_orchestrator()` in `script_api.rs` was 60-line copy of `build_test_app()` -- extracted `build_test_app_with()` to `common/mod.rs` with optional orchestrator parameter. Both `build_test_app()` and `build_test_app_with_orchestrator()` now delegate to single builder (DRY-017 partially resolved). FIXED (HIGH): `create_admin()` + `login()` test helpers duplicated across `script_api.rs`, `auth_api.rs`, `hardware_api.rs` (3 independent user creation helpers) -- extracted `create_test_user()`, `login_user()`, `login_for_token()` to `common/mod.rs`. `script_api.rs` refactored to use shared helpers. FIXED (MEDIUM): `scripts.rs` used fully-qualified `trulience_core::error::CoreError::NotFound` (4 locations) instead of imported alias used by all other handlers -- added `use trulience_core::error::CoreError;` import. WATCH: DRY-004 (2nd pagination query struct `ExecutionListQuery`), DRY-085 (QA run_python_script vs subprocess), DRY-086 (VENV_DIR string). |
| 2026-02-21 | PRD-83 (Video Playback Engine & Codec Support) | 27 files (7 backend new, 6 backend modified, 12 frontend new, 2 frontend tests) | 3 HIGH fixed, 2 MEDIUM (1 pre-existing DRY-083, 1 watch DRY-091), rest CLEAN | FIXED (HIGH): DRY-087 `AudioTrackInfo` struct duplicated in `core/src/ffmpeg.rs` and `db/src/models/video.rs` -- removed duplicate from db, re-export from core, eliminated 8-line field-by-field mapper in handler. FIXED (HIGH): DRY-088 `"storage/thumbnails"` path literal duplicated 2x in `handlers/video.rs` -- extracted `THUMBNAIL_STORAGE_DIR` constant + `thumbnail_dir()` helper. FIXED (MEDIUM): DRY-089 "find first video stream" iteration repeated 5x in `core/src/ffmpeg.rs` -- extracted `first_video_stream()` private helper. FIXED (LOW): Hardcoded `'segment' or 'version'` error message -- now uses `VALID_SOURCE_TYPES` constant. RESOLVED: DRY-060 (FFmpeg command builder) -- shared utility now lives in `core/src/ffmpeg.rs`. WORSENED: DRY-083 (DataResponse not used by `get_metadata` and `generate_thumbnails` -- 3rd handler module skipping envelope). WATCH: DRY-091 (10x `.map_err` in handler, add `From<FfmpegError>` when pattern reaches 4th handler). CLEAN: all frontend files (types, codec-detector, frame-utils, hooks, components, barrel export, tests), all repos, migration, routes, constants. |
| 2026-02-21 | PRD-07 (Parallel Task Execution Engine) | 14 files (8 new: migration, model, repo, engine/mod, dispatcher, progress, handler, route; 6 modified: db models/mod, db repos/mod, api lib, handlers/mod, routes/mod, comfyui manager) + cross-ref to core/roles.rs, notification.rs, scripts.rs, response.rs, metric_names.rs | 1 CRITICAL fixed, 2 HIGH fixed, 3 MEDIUM fixed, 1 MEDIUM watch (DRY-093), rest CLEAN | FIXED (CRITICAL DRY-090): `ADMIN_ROLE` constant redefined as `"admin"` in `jobs.rs` -- exact duplicate of `ROLE_ADMIN` from `core/src/roles.rs`. Replaced with import. FIXED (HIGH DRY-092): `list_by_user`/`list_all` in `job_repo.rs` were 30-line structural duplicates -- extracted shared `list_jobs(pool, user_id: Option, params)` private method with dynamic WHERE clause builder. FIXED (HIGH DRY-097): Ownership guard (find_by_id + NotFound + ownership check + Forbidden) repeated 3x in handlers -- extracted `find_and_authorize(pool, job_id, auth, action)` helper. FIXED (MEDIUM DRY-094): Magic status_id numbers `1, 2` in `dispatcher.rs` SQL -- replaced with `JobStatus::Pending.id()`/`JobStatus::Running.id()` parameterized binds. FIXED (MEDIUM DRY-095): Job WS message type magic strings 4x in `progress.rs` -- created `core/src/job_events.rs` with `MSG_TYPE_JOB_PROGRESS/COMPLETED/FAILED/CANCELLED` constants. FIXED (MEDIUM DRY-096): `serde_json::json! + Message::Text + broadcast` pipeline repeated 4x -- extracted `broadcast_json()` helper. WATCH: DRY-093 (`MAX_LIMIT`/`DEFAULT_LIMIT` pagination constants now at 3 consumers). CLEAN: migration (proper trigger, indexes, FK constraints), model (uses DbId/Timestamp), route file, engine/mod.rs, DataResponse used correctly throughout, JobStatus enum properly defined in status.rs. |
| 2026-02-21 | Group 1 Phase 2 (PRD-07, PRD-47, PRD-02 DRY fix, PRD-29 deferred) | 46 files (20 backend: 4 migrations, 3 models, 3 repos, 3 handlers, 3 routes, 1 router, 1 engine/mod, 1 dispatcher, 1 progress; 6 frontend: 3 domain components, 1 TokenEditor, 1 TokenEditor.test, 1 useThemePersistence; 2 modified: main.rs, tests/common/mod.rs) + cross-ref to DRY-TRACKER, notification.rs, trash.rs, response.rs, Dropdown.tsx, use-hardware.ts | 1 HIGH fixed (DRY-108), 2 MEDIUM fixed (DRY-109, 6x duplicate updaters), 1 RESOLVED (DRY-017), 3 WATCH new (DRY-106, DRY-107, DRY-093 status updated), rest CLEAN | **DRY-017 RESOLVED**: `build_app_router()` in `api/src/router.rs` now single source of truth; both `main.rs` and `tests/common/mod.rs` call it with zero duplication. **DRY-108 FIXED**: `TokenEditor.tsx` was 670 lines (over 500-line threshold) with 7 inlined section components and 6 structurally identical `updateX` functions; extracted sections to `token-editor/TokenSections.tsx` (404 lines), main component now 298 lines, 6 updaters replaced with single generic `updateTokenSection<K>()`. **DRY-109 FIXED**: `TagWithCount` redundantly re-exported from `TagInput.tsx` and `TagFilter.tsx`; removed, canonical source is `TagChip.tsx`. **DRY-093 CONFIRMED**: 4th consumer (`tag_repo.rs`) confirmed, extraction threshold met, status updated to flagged. **NEW WATCH**: DRY-106 (theme status `'active'` magic string, 1 consumer), DRY-107 (`STATUS_OPTIONS` hardcoded status_id numbers in TokenEditor, 1 consumer). **CLEAN**: All 3 handler files properly use `DataResponse<T>`, `AuthUser`, `ROLE_ADMIN` import, `CoreError::NotFound`. All 3 repo files use `COLUMNS` constant pattern, `DbId`/`Timestamp` types. All 3 route files are thin routers. `router.rs` cleanly extracts DRY-017. Job model uses `JobStatus` enum, no magic numbers. Tag model types well-structured with `TagInfo`/`TagWithCount` hierarchy. Theme model follows established CRUD patterns. `dispatcher.rs` uses `JobStatus::*.id()` (DRY-094 pattern). `progress.rs` uses `MSG_TYPE_JOB_*` constants and `broadcast_json` helper (DRY-095/096 resolved). `jobs.rs` uses `find_and_authorize` helper (DRY-097 resolved). Frontend `TagChip/TagInput/TagFilter` follow design token conventions. `useThemePersistence` properly isolated from `ThemeProvider`. |
| 2026-02-21 | PRD-47 (Tagging & Custom Labels) | 9 new (2 migrations, 1 model, 1 repo, 1 handler, 1 route, 3 frontend components) + 12 cross-ref (scripts.rs, hardware.rs, jobs.rs, trash.rs, trash_repo.rs, response.rs, job_repo.rs, notification.rs, StatusBadge.tsx, ThumbnailCard.tsx, Dropdown.tsx, use-hardware.ts) | 1 HIGH fixed (DRY-099), 1 MEDIUM fixed (DRY-101), 1 HIGH watch (DRY-098), 3 MEDIUM watch (DRY-093 worsened, DRY-102, DRY-103), 2 LOW watch (DRY-104, DRY-105), rest CLEAN | FIXED (HIGH DRY-099): `TagSuggestion` in `TagInput.tsx` was structurally identical to `TagWithCount` (`TagInfo + usage_count`) -- unified to single `TagWithCount` type exported from `TagChip.tsx`, eliminated 8-line duplicate interface. FIXED (MEDIUM DRY-101): Inline `prefix.trim().to_lowercase()` in `tag_repo.rs:suggest()` duplicated existing `normalize_tag_name()` helper -- replaced with function call. WORSENED: DRY-093 now at 4 consumers (tag_repo.rs is 4th), extraction threshold met. WATCH: DRY-098 (validate_entity_type function in 2 handlers with different registries), DRY-102 (click-outside pattern at 2 consumers), DRY-103 (raw API calls instead of TanStack Query hooks), DRY-104 (taggable entity type constants, 1 consumer), DRY-105 (inline SVG close icon, 1 consumer). CLEAN: both migrations (proper trigger, indexes, UNIQUE constraints), model DTOs (uses DbId/Timestamp, proper projection types), handler (correctly uses DataResponse<T>, AuthUser, RequireAdmin, CoreError::NotFound), route file, TagChip.tsx (focused single-responsibility), TagFilter.tsx (proper TagInfo extension). |
| 2026-02-21 | Group 3 Phase 2 (PRD-15, PRD-17) | 28 files (8 backend new: 2 models, 2 repos, 2 handlers, 2 routes; 4 backend core: 2 reclamation, 2 assets submodules; 8 SQL migrations; 10 frontend: 6 components, 2 hook files, 1 format utility, 1 CompatibilityWarning) | 5 HIGH fixed (DRY-117 to DRY-121), 1 FLAGGED worsened (DRY-093), 5 WATCH new (DRY-122 to DRY-126), rest CLEAN | **FIXED (HIGH DRY-117):** `formatFileSize()` identically defined in `AssetBrowser.tsx:38` and `AssetDetail.tsx:23` -- behaviorally duplicated `formatBytes()` from `@/lib/format.ts`. Removed both (18 lines), replaced with `formatBytes` import. **FIXED (HIGH DRY-118):** `formatDate()` local helper in `AssetDetail.tsx` -- extracted to shared `formatDate()` in `@/lib/format.ts`. **FIXED (HIGH DRY-119):** `reclamation.rs` handler imported `DataResponse` but used `serde_json::json!` for 11 of 13 endpoints -- migrated all to `DataResponse<T>` with `impl IntoResponse` return types. DRY-083 partially reduced (reclamation cleared). **FIXED (HIGH DRY-120):** Column lists repeated 15x across `reclamation_repo.rs` -- extracted 4 COLUMNS constants (`RULE_COLUMNS`, `POLICY_COLUMNS`, `TRASH_COLUMNS`, `RUN_COLUMNS`) following established `asset_repo.rs` pattern. Eliminated ~60 lines of duplicate column strings. **FIXED (HIGH DRY-121):** `verify_exists + NotFound` guard repeated 4x identically in `assets.rs` handler (add_dependency, get_impact, add_note, rate_asset) -- extracted `ensure_asset_exists(pool, id)` helper, following DRY-097 (find_and_authorize) pattern. Eliminated 20 lines. **WORSENED DRY-093:** `asset_repo.rs` (50/100) is 5th consumer of pagination clamping pattern; `reclamation.rs` has 2x bare `unwrap_or(50)` without MAX_LIMIT cap. **WATCH:** DRY-122 (trash queue status_id magic numbers), DRY-123 (asset STATUS_OPTIONS hardcoded ids), DRY-124 (ASSET_TYPE_OPTIONS hardcoded ids), DRY-125 (`"required"`/`"info"` default strings in repo), DRY-126 (`"manual"` run_type string). **CLEAN:** All 8 SQL migrations (proper triggers, indexes, UNIQUE constraints, FK indexes). Both models (use DbId/Timestamp, clean DTOs). Both route files (thin routers). Core modules (pure logic, no DB deps, proper unit tests). All frontend hooks (TanStack Query with proper query key factories). Frontend components all under 500 lines. `ProtectedBadge` is a thin intentional wrapper. `CompatibilityWarning` well-structured. |
| 2026-02-21 | Group 2 Phase 2 (PRD-30, PRD-32, PRD-52) | 53 files (15 backend: 3 migrations, 3 models, 3 repos, 3 handlers, 3 routes; 38 frontend: 14 layout, 10 progressive-disclosure, 13 shortcuts, 1 AdvancedDrawer) + 3 cross-ref (themes.rs, theme_repo.rs, useThemePersistence.ts) | 3 HIGH fixed (DRY-110, DRY-111, DRY-116), 5 WATCH new (DRY-112 to DRY-115), rest CLEAN | **FIXED (HIGH DRY-110):** `CATEGORY_LABELS` and `CATEGORY_ORDER` identically declared in `CheatSheet.tsx` and `KeymapEditor.tsx` -- extracted to `ShortcutRegistry.ts` alongside new `groupBindingsByCategory()` utility; both consumers refactored to import. Eliminated 20 duplicate lines. **FIXED (HIGH DRY-111):** `snapValue()` identically defined in `useSnapGrid.ts` and `usePanelResize.ts` (same `Math.round(value/gridSize)*gridSize` body) -- exported from `useSnapGrid.ts`, imported in `usePanelResize.ts`. Eliminated 3 duplicate lines. **FIXED (HIGH DRY-116):** `export_keymap` handler had two identical `serde_json::json!` branches (Some/None) producing same JSON shape -- extracted shared destructuring with fallback defaults. Eliminated 7 duplicate lines. **WATCH DRY-112:** Debounce timer pattern at 3 persistence hooks (theme, layout, proficiency). Extract `useDebouncedCallback` at 4th consumer. **WATCH DRY-113:** Proficiency level strings in SQL (beginner/intermediate/expert). Same cross-boundary pattern as DRY-079. **WATCH DRY-114:** Preset name list cross-boundary duplication (backend PRESET_NAMES vs frontend presets map). **WATCH DRY-115:** Raw `api.*()` calls in layout persistence (same pattern as DRY-103 for tags). **CLEAN:** All 3 migrations (proper triggers, indexes, UNIQUE constraints, FK indexes). All 3 models use `DbId`/`Timestamp`, proper `FromRow`/`Serialize`/`Deserialize` derives. All 3 repos use `COLUMNS` constant pattern, clean SQL. All 3 handlers use `DataResponse<T>`, `RequireAuth`/`RequireAdmin`, `CoreError::NotFound` pattern. All 3 route files are thin routers. Frontend: all components under 500 lines, design token CSS variables used consistently, proper Zustand store patterns, barrel exports. No cross-feature type duplication. DRY-003 (CRUD handler boilerplate) remains `watch` -- handlers are thin-adapter, no macro warranted yet. DRY-004 (pagination) not impacted -- no list endpoints use pagination in this batch. DRY-093 (pagination clamping) not impacted. |
| 2026-02-21 | Group 4 Phase 2 (PRD-41, PRD-42, PRD-54, PRD-36, PRD-37) | 52 files (9 backend: 2 models, 2 repos, 2 handlers, 2 routes, 1 migration; 43 frontend: 7 dashboard/performance, 5 dashboard/widgets, 3 dashboard hooks/base, 7 cinema, 10 qa-aids, 8 job-tray, 1 hooks/useEventBus, 1 lib/format, 1 video-player/index) | 4 HIGH fixed (DRY-127 to DRY-130), 4 MEDIUM watch (DRY-131 to DRY-134), 1 FLAGGED worsened (DRY-093 to 6 consumers), rest CLEAN | **FIXED (HIGH DRY-127):** `formatTime(seconds)` identically defined in `CinemaMode.tsx` and `GridControls.tsx` -- behavioral duplicate of `formatDuration()` from `video-player/frame-utils.ts`. Removed both locals (16 lines), added barrel export to `video-player/index.ts`, replaced with `formatDuration` import. **FIXED (HIGH DRY-128):** Recharts Tooltip `contentStyle` object duplicated 7x across `QualityCharts.tsx` (4x), `WorkflowComparison.tsx` (2x), `WorkerBenchmark.tsx` (1x). Also axis tick style duplicated 14x and grid stroke 7x. Created `performance/chartStyles.ts` with `TOOLTIP_CONTENT_STYLE`, `AXIS_TICK_STYLE`, `GRID_STROKE`. All 3 files refactored. Eliminated ~70 lines. **FIXED (HIGH DRY-129):** `formatElapsed(seconds)` in `ActiveTasksWidget.tsx` reimplemented `formatDuration` logic from `@/lib/format.ts`. Refactored to delegate: `formatDuration(seconds * 1000)` with null guard. **FIXED (HIGH DRY-130):** Click-outside pattern reached 3-consumer threshold (TagInput, Dropdown, JobTrayPanel). Extracted `useClickOutside(ref, callback, enabled?)` to `src/hooks/useClickOutside.ts`. All 3 consumers refactored. DRY-102 resolved. **WATCH DRY-131:** Workflow aggregation SELECT duplication in `performance_metric_repo.rs` (2 methods). **WATCH DRY-132:** Scope type magic strings (`"global"`, `"workflow"`, `"worker"`) in performance handler. 1 Rust consumer. **WATCH DRY-133:** Worker aggregation SELECT duplication in `performance_metric_repo.rs` (2 methods). **WATCH DRY-134:** `parse_from`/`parse_to` date parsing helpers. 1 consumer. **DRY-093 WORSENED:** Dashboard handler adds 6th consumer (`FEED_MAX_LIMIT`/`FEED_DEFAULT_LIMIT`). **CLEAN:** All backend handlers use `DataResponse<T>`, `RequireAuth`/`RequireAdmin`, `CoreError::NotFound`. Both repos use `COLUMNS`/`INSERT_COLUMNS` pattern. All SQL migrations have proper triggers, indexes, FK indexes. Job tray uses shared `formatDuration` from `@/lib/format.ts`. All dashboard widgets under 500 lines. QA aids are well-factored (pure geometry helpers, physics engine class, audio scrub class all cleanly separated). Cinema mode properly reuses `useVideoPlayer`, `useVideoMetadata`, `formatDuration` from shared video-player module. No cross-feature type duplication. No unused imports detected. |
| 2026-02-21 | PRD-85 (UI Plugin/Extension Architecture) | 16 files (6 backend: 1 migration, 1 model, 1 repo, 1 core module, 1 handler, 1 route; 10 frontend: 1 types, 1 hooks, 1 sandbox, 1 api-bridge, 1 panel-integration, 1 context-menu, 1 metadata-renderer, 1 manager, 1 barrel, 1 test) + cross-ref (router.rs, response.rs, MetricsChart.tsx, 4 test files) | 3 HIGH fixed (DRY-138 to DRY-140), 1 MEDIUM flagged (DRY-135), 2 MEDIUM watch (DRY-136, DRY-137), rest CLEAN | **FIXED (HIGH DRY-138):** `enable_extension`/`disable_extension` handlers were 44-line structural duplicates differing only in boolean arg and log message -- extracted shared `toggle_extension(state, id, user_id, enabled)` helper. Eliminated 22 lines. **FIXED (HIGH DRY-139):** Textarea styling 9-line `cn()` block duplicated in `SettingsEditor` and `InstallForm` (same file) -- extracted `TEXTAREA_BASE_CLASSES` array constant + `textareaBorderClass(hasError)` helper. Both textareas now use shared constants. Eliminated 12 duplicate lines. **FIXED (HIGH DRY-140):** Frontend `methodToAccess()` in `ExtensionApiBridge.ts` mapped POST->"create", PUT->"update", DELETE->"delete" but backend `KNOWN_ACCESS_LEVELS` in `core/src/extensions.rs` only defines `["read", "write"]`. Client-side defense-in-depth check would wrongly deny extensions with `write` permission trying to POST/PUT/DELETE. Aligned frontend to use "read"/"write" matching backend. **FLAGGED DRY-135:** `renderWithProviders` test helper identical across 4+ test files (threshold met). **WATCH DRY-136:** `parseError` + JSON try/catch pattern in 2 sub-components (same file, 2 instances). **WATCH DRY-137:** `collectDesignTokens` vs `getCssVar` CSS property access (related to DRY-082). **CLEAN:** Migration (proper trigger, indexes, UNIQUE constraint). Model uses `DbId`/`Timestamp`, clean DTOs with `FromRow`/`Serialize`/`Deserialize`. Repo uses `COLUMNS` + `REGISTRY_COLUMNS` constant pattern. Core module has proper validation with unit tests, constants in leaf crate. Handler correctly uses `DataResponse<T>`, `RequireAdmin`, `AuthUser`, `CoreError::NotFound/Forbidden`. Route file is a thin router with 3 sub-routers. Routes properly registered in `router.rs`. Frontend types mirror backend manifest schema. TanStack Query hooks follow established pattern with query key factory. Barrel export is clean. Test uses proper vitest/react-testing-library patterns. No `serde_json::json!` in handler (uses `DataResponse<T>` throughout). No magic strings (constants in core). Frontend components all under 500 lines. |
| 2026-02-21 | PRD-28, PRD-04, PRD-45 (Pipeline Checkpointing, Workspace Persistence, Audit Logging) | 38 files (12 PRD-28: 2 migrations, 1 core, 1 model, 1 repo, 1 handler, 1 route, 3 frontend, 1 test, 1 hooks; 14 PRD-04: 2 migrations, 1 core, 1 model, 1 repo, 1 handler, 1 route, 5 frontend, 1 test; 12 PRD-45: 2 migrations, 1 core, 1 model, 1 repo, 1 handler, 1 route, 4 frontend, 1 test) | 6 FIXED (DRY-151 to DRY-156), 3 WATCH new (DRY-154, DRY-159, DRY-160), 2 MEDIUM unfixed (DRY-157 inline dates, DRY-158 raw fetch) | **FIXED (CRITICAL DRY-151):** `formatBytes()` duplicated in `checkpoints/types.ts` -- removed local, re-exported from `@/lib/format.ts`. **FIXED (CRITICAL DRY-152):** `find_and_authorize_job()` in `checkpoints.rs` was line-for-line duplicate of `find_and_authorize()` in `jobs.rs` -- made jobs helper `pub`, imported in checkpoints. **FIXED (HIGH DRY-153):** `resume_from_checkpoint` handler hand-rolled `INSERT INTO jobs` with inline 14-column COLUMNS list duplicating `job_repo.rs` -- extracted `JobRepo::resume_from_checkpoint()` method. **FIXED (HIGH DRY-155):** `query()` and `count()` in `audit_repo.rs` had 45+ identical filter-building lines -- extracted `build_audit_filter()` + `bind_audit_values()`/`bind_audit_values_scalar()` helpers. **FIXED (MEDIUM DRY-156):** Ad-hoc `serde_json::json!` in `checkpoints.rs` diagnostics and `audit.rs` query response -- replaced with typed `JobDiagnosticsResponse` struct and `AuditLogPage` struct. DRY-083 reduced. **WATCH DRY-154:** `FailureDiagnostics` (db) vs `FailureDiagnosticData` (core) near-duplicate -- intentional layer separation. **WATCH DRY-159:** `parse_timestamp` in audit vs `parse_from/parse_to` in performance -- 2 consumers, extract at 3rd (DRY-134). **FLAGGED DRY-160:** Debounce timer pattern now at 5 consumers (DRY-112 escalated). **UNFIXED DRY-157:** Inline `new Date().toLocale*` in AuditLogViewer and ResumeDialog -- should use `formatDateTime` from `@/lib/format.ts`. **UNFIXED DRY-158:** `exportAuditLogs` uses raw `fetch` with `localStorage.getItem("access_token")` bypassing shared API client. **VERIFIED:** `cargo check` clean, `npx tsc --noEmit` clean, `npx biome check` clean, all core unit tests pass. CLEAN: All test files use `renderWithProviders` from `@/lib/test-utils.tsx`. All handlers use `DataResponse<T>`. All repos use COLUMNS constant pattern. All core modules have unit tests. No dead imports. |
| 2026-02-21 | Group 5 Phase 2 (PRD-20, PRD-11, PRD-12) | 45 files (15 backend PRD-20: 3 migrations, 1 core search.rs, 1 model, 1 repo, 1 handler, 1 route, 7 frontend; 13 backend PRD-11: 2 migrations, 1 core, 1 model, 1 repo, 1 handler, 1 route, 6 frontend; 17 backend PRD-12: 3 migrations, 1 core api_keys.rs, 2 models, 2 repos, 2 handlers, 1 route, 6 frontend) | 4 FIXED (DRY-163 to DRY-166), 2 WATCH new (DRY-161, DRY-162), 1 FLAGGED updated (DRY-093 to 7 consumers), rest CLEAN | **FIXED (HIGH DRY-163):** `SearchBar.tsx` used inline click-outside implementation (11-line useEffect with addEventListener/removeEventListener on mousedown) instead of shared `useClickOutside` hook from `src/hooks/useClickOutside.ts` (DRY-102/130 pattern) -- replaced with single `useClickOutside(containerRef, () => setIsOpen(false))` call. **FIXED (HIGH DRY-164):** `execute_saved_search` in `handlers/search.rs` duplicated the search+facets+timing+response assembly pattern from `unified_search` (~15 identical lines) -- extracted `run_search(pool, params)` private async helper. Both handlers now delegate to it. **FIXED (HIGH DRY-165):** `build_tsquery` and `build_prefix_tsquery` in `core/src/search.rs` both had identical 5-line term sanitization logic (split_whitespace + trim_matches + filter) -- extracted `sanitize_terms(query) -> Option<Vec<&str>>` private helper. **FIXED (MEDIUM DRY-166):** `webhooks.rs:list_deliveries` used inline `params.limit.unwrap_or(50).min(200)` + `params.offset.unwrap_or(0)` instead of shared `clamp_limit`/`clamp_offset` from `core/src/search.rs` -- replaced with shared imports. DRY-093 now at 7 consumers (webhook is 7th, now fixed). **WATCH DRY-161:** Confirmation dialog UI pattern duplicated across ApiKeyManager (rotate/revoke) and WebhookManager (delete). Same AlertTriangle + description + Cancel/Action button structure. Design system candidate at 3rd consumer. **WATCH DRY-162:** Admin table styling pattern (Card > overflow-x-auto > table > th classes) repeated across 4 components (ApiKeyManager, WebhookManager, DeliveryLog, ExtensionManager). Threshold met but deferred to design system work. **VERIFIED:** `cargo check` clean, `cargo test -p trulience-core -- search` 19 tests + 2 doc tests passed, `npx tsc --noEmit` clean, `npx vitest run SearchBar.test.tsx` 8/8 passed. **NOT DUPLICATED:** SHA-256 in `api_keys.rs:hash_api_key()` vs `audit.rs:compute_integrity_hash()` -- different purposes (simple hash vs chained integrity hash). `collaboration.rs` vs `search.rs` entity type validation -- different registries by design. **CLEAN:** All 8 SQL migrations. All frontend test files use `renderWithProviders` from `@/lib/test-utils.tsx`. All handlers use `DataResponse<T>`. All repos use COLUMNS constant pattern. All frontend components use `formatDateTime` from `@/lib/format.ts`. Core modules have proper unit tests. TanStack Query hooks follow established key factory pattern. No magic strings detected. |
| 2026-02-21 | Group 4 Phase 2b (PRD-13, PRD-16, PRD-66) | 34 files (10 backend PRD-13: 1 core metadata.rs, 1 model, 1 repo, 1 handler, 1 route, 3 frontend, 1 hooks, 1 test; 10 backend PRD-16: 1 core importer.rs, 1 model, 1 repo, 1 handler, 1 route, 3 frontend, 1 hooks, 1 test; 8 backend PRD-66: 1 core metadata_editor.rs, 1 handler, 1 route, 3 frontend, 1 hooks, 1 test; 6 shared: search.rs, api_keys.rs, audit.rs, images.rs, import_status.rs, api.ts, format.ts) | 5 HIGH (DRY-167 to DRY-170, DRY-176), 3 MEDIUM (DRY-171, DRY-172, DRY-173), 2 WATCH (DRY-174, DRY-175), 2 LOW (DRY-177, DRY-178), 0 fixed (read-only audit) | **HIGH DRY-167:** SHA-256 hex digest implemented 3x in core (`metadata.rs:sha256_hex`, `api_keys.rs:hash_api_key`, `audit.rs:compute_integrity_hash`). First two are structurally identical. Extract shared `sha256_hex()` to `core/src/hashing.rs`. **HIGH DRY-168:** Metadata regeneration logic (serialize -> hash -> create -> upsert) duplicated 2x within `metadata.rs` handler at lines 197-215 and 267-279. Extract `upsert_generation()` private helper. **HIGH DRY-169:** `find_stale_characters`/`find_stale_scenes` are 20-line structural duplicates in `metadata_repo.rs` differing only by table name and entity type. Extract generic `find_stale_entities()`. **HIGH DRY-170:** Magic strings `'character'`/`'scene'` hardcoded in 4 SQL queries in `metadata_repo.rs` instead of using constants from `core/src/metadata.rs`. **HIGH DRY-176:** `serde_json::json!` at 3 handler endpoints (`metadata.rs` x2, `importer.rs` x1) instead of typed `DataResponse<T>` (DRY-083 pattern). **FLAGGED DRY-171:** Raw `fetch` with `localStorage.getItem("access_token")` in 2 frontend files (3 instances), bypassing shared `api.ts` client auth. One instance in `use-importer.ts` has NO auth header at all (potential bug). **MEDIUM DRY-172:** `formatValue()`/`formatCellValue()` near-identical in 2 metadata-editor components. **MEDIUM DRY-173:** Inline `toLocaleString()` in `StalenessIndicator.tsx` instead of `formatDateTime`. **WATCH DRY-174:** `IMAGE_EXTENSIONS` in `importer.rs` overlaps `VALID_IMAGE_FORMATS` in `images.rs` (same set, different format). **WATCH DRY-175:** Hardcoded `'uploading'` in SQL instead of `SESSION_STATUS_UPLOADING`. **LOW DRY-177:** Session status vs import status constant overlap (different lifecycles, acceptable). **LOW DRY-178:** `PhysicalAttributes` struct vs field definitions dual representation (intentional). **CLEAN:** All frontend test files use `renderWithProviders` from `@/lib/test-utils.tsx`. All repos use COLUMNS constant pattern. TanStack Query hooks follow established key factory pattern. `character_metadata.rs` handler properly uses `DataResponse<T>`. Core modules (`metadata_editor.rs`, `importer.rs`, `metadata.rs`) are pure logic with zero DB deps. All route files are thin routers. |
| 2026-02-21 | Group 1 Phase 3 (PRD-21, PRD-08) | ~40 files (10 backend new: 2 core modules, 2 models, 2 repos, 2 handlers, 2 routes; 6 backend modified: status.rs, image.rs, image_variant_repo.rs, image_variant.rs, character routes, job routes; 8 SQL migrations; 14 frontend: types, hooks, components, barrel exports for images + queue; 6 test files refactored) | 5 HIGH fixed (DRY-141 to DRY-145), 1 FLAGGED resolved (DRY-135), 5 MEDIUM watch (DRY-146 to DRY-150), rest CLEAN | **RESOLVED (DRY-135):** `renderWithProviders` test helper duplicated across 6 test files -- extracted to shared `src/lib/test-utils.tsx`. All 6 consumers refactored: VariantGallery.test, QueueStatusView.test, ExtensionManager.test, PerformanceDashboard.test, StudioPulse.test, ReclamationDashboard.test. **FIXED (HIGH DRY-141):** `formatFileSize()` in `SourceImageUpload.tsx` was behavioral duplicate of `formatBytes()` from `@/lib/format.ts` -- removed local, replaced with shared import. **FIXED (HIGH DRY-142):** `formatDate()` in `VariantHistory.tsx` was identical to `formatDateTime()` from `@/lib/format.ts` -- removed local, replaced with shared import. **FIXED (HIGH DRY-143):** `"storage/variants"` path literal duplicated 2x in `image_variant.rs` -- extracted `VARIANT_STORAGE_DIR` constant + `ensure_variant_dir()` async helper (following DRY-088 `THUMBNAIL_STORAGE_DIR` pattern). **FIXED (HIGH DRY-145):** All 10 endpoints in `image_variant.rs` returned raw `Json<T>` instead of `DataResponse<T>` -- migrated all to `DataResponse<T>` + `impl IntoResponse` return types. Removed unused `ImageVariant` import. **WATCH DRY-146:** `formatWait()`/`formatSeconds()` in queue components -- similar to `formatDuration` but specialized for queue display. 1 consumer each. **WATCH DRY-147:** `UpdateImageVariant` struct all-None construction repeated 2x in image_variant.rs (reject/export) -- extract `UpdateImageVariant::status_only(status_id)` builder at 3rd consumer. **WATCH DRY-148:** Multipart upload parsing pattern duplicated in `reimport_variant`/`upload_manual_variant` -- extract `parse_image_upload(multipart)` helper at 3rd consumer. **WATCH DRY-149:** `state_machine::status_name()` in `core/src/scheduling.rs` maps same IDs as `JobStatus` enum -- intentional separation (core vs db), no action needed unless they diverge. **WATCH DRY-150:** `"off_peak"` magic string in scheduling model -- 1 consumer, extract at 2nd. **VERIFIED:** `cargo check` clean (0 warnings), `npx tsc --noEmit` clean, `cargo test --lib` all passed, `npx vitest run` 292/292 tests passed across 26 files. |

| 2026-02-21 | Group 5 Phase 2b (PRD-33, PRD-35, PRD-44) | 34 files (11 PRD-33: 1 core, 1 model, 1 repo, 1 handler, 1 route, 6 frontend; 12 PRD-35: 1 core, 1 model, 1 repo, 1 handler, 1 route, 7 frontend; 12 PRD-44: 2 core, 1 model, 1 repo, 2 handlers, 2 routes, 6 frontend) + cross-ref to hashing.rs, audit.rs, search.rs, format.ts, roles.rs, Modal, Spinner | 4 HIGH (DRY-179 to DRY-182), 6 MEDIUM (DRY-183 to DRY-188), 2 LOW (DRY-189, DRY-190), 0 fixed (read-only audit) | **HIGH DRY-179:** Duplicate sensitive-key redaction functions in `audit.rs::redact_sensitive_fields` and `config_export.rs::redact_sensitive` -- overlapping key lists (6 shared keys out of 10 each), different placeholders, different APIs (clone vs mutate). Extract shared `core/src/redaction.rs`. **HIGH DRY-180:** `ensure_segment_exists` pattern (SegmentRepo::find_by_id + NotFound) repeated 3x identically in `approval.rs` (approve/reject/flag). Extract private helper (DRY-097/DRY-121 pattern). **HIGH DRY-181:** Identical `onSuccess` invalidation callbacks in 3 review mutation hooks (`useApproveSegment`/`useRejectSegment`/`useFlagSegment`). Same `mutationFn` shape. Extract `useDecisionMutation<T>(endpoint)` factory. ~40 lines duplicate. **HIGH DRY-182:** ComfyUI workflow parsing duplicated between backend handler (~85 lines) and frontend `comfyui-parser.ts` (~53 lines). Same node/edge extraction logic. Cross-boundary behavioral duplicate. Watch only (2 consumers, different runtimes). **MEDIUM DRY-183:** Inline pagination clamping in `bug_reports.rs` (`unwrap_or(50).min(200)`) instead of `clamp_limit`/`clamp_offset` from `core/src/search.rs`. DRY-093 now at 8 consumers. **MEDIUM DRY-184:** Hardcoded `"admin"` string 2x in `bug_reports.rs` instead of `ROLE_ADMIN` from `core/src/roles.rs`. Same violation as DRY-090 (CRITICAL in PRD-07). **MEDIUM DRY-185:** Magic timing thresholds 1000/5000 in `WorkflowCanvas.tsx` duplicating `TIMING_FAST_MS`/`TIMING_MODERATE_MS` from backend. Extract frontend constants to `types.ts`. **MEDIUM DRY-186:** `RejectionDialog.tsx` hand-rolls modal overlay instead of using `Modal` composite (used by 11+ components). Missing Escape key, focus trapping. **MEDIUM DRY-187:** `WorkflowCanvas.tsx` inline loading spinner instead of `Spinner` primitive (used by 30+ components). **MEDIUM DRY-188:** `BugReportList.tsx` uses `toLocaleDateString()` instead of `formatDate` from `@/lib/format.ts` (DRY-157/DRY-173 pattern). **LOW DRY-189:** State machine pattern structural duplicate in `bug_report.rs` and `scheduling.rs` (same `valid_transitions`/`validate_transition` structure, different types `&str` vs `i16`). 2 consumers, watch. **LOW DRY-190:** Auth extractor inconsistency (`RequireAuth` in workflow_canvas vs `AuthUser` in approval/bug_reports). Style issue, not duplication. **CLEAN:** All test files use `renderWithProviders` from `@/lib/test-utils`. All repos use COLUMNS constant pattern. All handlers use `DataResponse<T>`. All route files are thin routers. All TanStack Query hooks follow key factory pattern. All frontend hooks use shared `api` client. All DB models use `DbId`/`Timestamp`. Core modules have unit tests. No dead imports. No cross-feature type duplication. |

| 2026-02-21 | PRD-53 (First-Run Experience & Onboarding) | 16 files (6 backend: 1 migration, 1 core, 1 model, 1 repo, 1 handler, 1 route; 10 frontend: 1 types, 2 hooks, 4 components, 1 tourPaths, 1 hintDefinitions, 1 barrel) + 2 cross-ref (Tooltip.tsx, workspace_repo.rs) | 5 HIGH fixed (DRY-191/192/194/197/198), 3 MEDIUM fixed (DRY-193/195/196), 2 LOW watch (DRY-199/200), 1 LOW quality (DRY-201) | **FIXED (HIGH DRY-191):** `handleTourComplete`/`handleTourSkip` identical callbacks in OnboardingGate -- merged to single `handleTourEnd`. **FIXED (HIGH DRY-192):** `PLACEMENT_CLASSES` in ContextualHint identical to Tooltip.tsx `POSITION_CLASSES` -- exported `Placement` type + `PLACEMENT_CLASSES` from Tooltip, imported in ContextualHint. **FIXED (HIGH DRY-194):** Redundant plain index duplicating unique index on `user_onboarding(user_id)` -- removed. **FIXED (HIGH DRY-197):** `validate_checklist_item`/`validate_feature_key` structurally identical -- extracted generic `validate_known_key`/`validate_known_keys` private helpers. **FIXED (HIGH DRY-198):** `get_or_create` 2-query pattern (DO NOTHING + SELECT) -- refactored to single-query no-op UPDATE pattern from `workspace_repo.rs`. **FIXED (MEDIUM DRY-193):** Placement union type 4x -- unified to `Placement` from Tooltip. **FIXED (MEDIUM DRY-195):** Dismiss-button styling 3x -- extracted `DISMISS_LINK_CLASSES`. **FIXED (MEDIUM DRY-196):** `HintDefinition` in wrong file -- moved to `types.ts`. **WATCH DRY-199:** Role name strings in tourPaths cross-boundary. **WATCH DRY-200:** TourEngine overlay lacks Escape/focus trap. **LOW DRY-201:** `console.log` stub in OnboardingChecklist. **VERIFIED:** `cargo check` clean, 315 core tests passed, `tsc --noEmit` clean. |

| 2026-02-22 | PRD-23 (Scene Type Configuration) | 16 files (5 backend: 1 core, 1 model, 1 repo, 1 handler, 1 route; 7 frontend: 1 types, 1 hooks, 3 components, 1 barrel, 1 index; 3 tests; 1 migration) + 5 cross-ref (Badge.tsx, StatusBadge.tsx, ActiveTasksWidget.tsx, onboarding.rs, dashboard.rs) | 4 HIGH fixed (DRY-201 to DRY-204), 4 WATCH new (DRY-205 to DRY-208), rest CLEAN | **FIXED (CRITICAL DRY-201):** `regex::Regex::new(r"\{(\w+)\}")` compiled on every call to `resolve_prompt_template()` (line 94) and `extract_placeholders()` (line 182) in `core/src/scene_type_config.rs` -- extracted to `static PLACEHOLDER_RE: LazyLock<regex::Regex>` module-level constant. Compiles once, reused forever. **FIXED (HIGH DRY-202):** `type BadgeVariant` locally redefined in `SceneMatrixView.tsx` (line 31) instead of importing from `Badge.tsx` -- exported `BadgeVariant` from `Badge.tsx`, added to primitives barrel, SceneMatrixView now imports it. Same redefinition exists in `StatusBadge.tsx` (line 3) and `ActiveTasksWidget.tsx` (line 13) -- fix when files are next touched. **FIXED (HIGH DRY-203):** 150-character textarea className string duplicated 3x across `PromptTemplateEditor.tsx` (lines 117, 138) and `SceneTypeEditor.tsx` (line 129) -- extracted `TEXTAREA_CLASSES` constant to `PromptTemplateEditor.tsx`, exported via barrel, imported in `SceneTypeEditor.tsx`. **FIXED (HIGH DRY-204):** Magic `status_id` numbers `1..5` mapped to display strings in `generate_matrix` handler (line 326) -- extracted `scene_status_label()` function using `SceneStatus::*.id()` pattern (follows DRY-094 fix in `dispatcher.rs`). **WATCH DRY-205:** `validate_variant_applicability` in `scene_type_config.rs` structurally duplicates `validate_known_key` in `onboarding.rs`. 2 consumers, different error types. Extract generic at 3rd. **WATCH DRY-206:** Pre-DataResponse CRUD handlers return raw `Json<T>` without envelope. Same pattern as other Phase 1 handlers. **WATCH DRY-207:** Variant constants cross-boundary Rust/TS. Same pattern as DRY-079/DRY-114. **WATCH DRY-208:** `CLIP_POSITIONS` vs `CLIP_TABS` -- same IDs, different purposes. **CLEAN:** Migration (proper UNIQUE index, correct `WHERE` clause for partial index). Model uses `DbId`/`Timestamp`, clean DTOs with `FromRow`/`Serialize`/`Deserialize`. Repo uses `COLUMNS` constant, consistent `format!` query pattern. Handler properly uses `DataResponse<T>` + `impl IntoResponse` for PRD-23 endpoints. Route file is thin router. Frontend hooks follow TanStack Query key factory pattern with `api` client. Tests use `renderWithProviders` from `@/lib/test-utils.tsx`. Core module has comprehensive unit tests (21 tests). No `serde_json::json!` in PRD-23 handlers. No raw `fetch` calls. All imports resolve correctly. **VERIFIED:** `cargo check` clean, `cargo test -p trulience-core -- scene_type_config` 21/21 passed, `npx tsc --noEmit` clean, `npx vitest run src/features/scene-types` 11/11 passed. |

| 2026-02-22 | PRD-46, PRD-76 (Worker Pool Management, Character Identity Embedding) | 40 files (14 backend: 2 core modules, 4 db models, 3 db repos, 2 handlers, 2 routes, 1 error.rs; 19 frontend: 2 types, 2 hooks, 5 components, 2 barrel exports, 6 test files; 7 SQL migrations) + cross-ref (Badge.tsx, format.ts, db lib.rs, models/mod.rs, repos/mod.rs, core lib.rs) | 1 CRITICAL fixed (DRY-209), 5 HIGH fixed (DRY-210 to DRY-213, DRY-216), 3 MEDIUM fixed (DRY-214, DRY-215, DRY-217), 1 WATCH new (DRY-218), rest CLEAN | **FIXED (CRITICAL DRY-209):** `EmbeddingStatus` enum duplicated in `core/src/embedding.rs` (hand-rolled with `from_id`, `label`, `id` + domain logic dependency) and `db/src/models/status.rs` (macro-generated via `define_status_enum!`). Core version is canonical (domain logic `classify_extraction_result` depends on it). Removed db macro version, added explanatory comment. **FIXED (HIGH DRY-210):** Local `formatDate()` in `WorkerDetailPanel.tsx` -- behavioral duplicate of `formatDateTime` from `@/lib/format.ts`. Replaced with `formatDateOrDash()` wrapper using shared import. **FIXED (HIGH DRY-211):** Inline `BadgeVariant` union type in `workers/types.ts` instead of importing from `@/components/primitives/Badge`. Added `WORKER_STATUS` named constants object (IDLE=1, BUSY=2, OFFLINE=3, DRAINING=4) to eliminate magic numbers. **FIXED (HIGH DRY-212):** `find_by_id + ok_or(NotFound)` pattern repeated 9x in `workers.rs` handler. Extracted `ensure_worker_exists(pool, id) -> AppResult<Worker>` + `validate_create_input(input) -> AppResult<()>` helpers. **FIXED (HIGH DRY-213):** Hardcoded `status_id` numbers (1, 3) in `worker_repo.rs` SQL for `register`, `list_available`, `approve`, `decommission`. Replaced with bind parameters using `WorkerStatus::Idle.id()` / `WorkerStatus::Offline.id()`. Fleet stats FILTER clauses left as-is (cannot parameterize SQL aggregate filters). **FIXED (MEDIUM DRY-214):** Inline 7-line SVG close icon in `LowConfidenceWarning.tsx`. Replaced with `<X size={16} />` from `@/tokens/icons`. **FIXED (MEDIUM DRY-215):** Redundant `.map_err(\|e\| AppError::Core(e))` in `embedding.rs` handler -- `#[from] CoreError` on `AppError` provides auto-conversion via `?`. Removed explicit map_err. **FIXED (HIGH DRY-216):** Worker validation block (validate_worker_name + validate_tags) duplicated in `register_worker` and `self_register_worker` -- extracted to `validate_create_input()` helper. **FIXED (MEDIUM DRY-217):** Magic number `4` for draining status in `WorkerDetailPanel.tsx` conditional -- replaced with `WORKER_STATUS.DRAINING` named constant. **WATCH DRY-218:** `formatHeartbeat` relative time formatter in `WorkerCard.tsx` (1 consumer). Extract to `@/lib/format.ts` as `formatRelativeTime(iso)` if a 2nd consumer appears. **CLEAN:** All 6 test files use `renderWithProviders` from `@/lib/test-utils.tsx`. All handlers use `DataResponse<T>`. All repos use COLUMNS constant pattern. All route files are thin routers. TanStack Query hooks follow established key factory pattern with `api` client. `embedding.rs` handler correctly uses `ensure_character_exists` pattern. Core modules (`worker_pool.rs`, `embedding.rs`) are pure validation logic with comprehensive unit tests. Frontend `EmbeddingStatusBadge` correctly imports `BadgeVariant` from primitives. `embedding/types.ts` has proper `EMBEDDING_STATUS` named constants (clean). No `serde_json::json!` in any handler. No raw `fetch` calls. All imports resolve. **VERIFIED:** `cargo check` clean (0 warnings), `cargo test -p trulience-core --lib` 366 passed, `cargo test -p trulience-db --lib` 5 passed, `npx tsc --noEmit` clean, `npx vitest run` 469/469 tests passed across 56 files. |

---

## How to Use This File

### When Starting a New PRD Implementation
1. Read the "Active Watch List" section
2. Check if your PRD is mentioned in any existing DRY entry
3. If yes, check whether a shared utility already exists (see "Resolved" section)
4. If a shared utility exists, use it. If not, build one and resolve the DRY entry.

### After Implementing Code
1. Run `dry-guy` agent on all changed files
2. If new patterns are flagged, add them to the "Active Watch List"
3. If existing patterns are resolved, move them to "Resolved" with the shared location

### When Reviewing PRs
1. Check if the PR introduces code that matches any `watch` or `flagged` entries
2. If so, request that the author use the shared utility or extract one
3. Block merge until DRY-GUY audit passes

---

## Version History

- **v1.0** (2026-02-18): Initial creation with pre-identified watch patterns from PRD analysis
