# DRY Tracker — Components & Functions Under Watch

Ongoing log of components, functions, patterns, and utilities that the DRY-GUY agent has flagged or that developers have identified as candidates for deduplication, extraction, or sharing.

**Purpose:** Prevent duplication before it happens. When implementing a new PRD, check this list first — if something similar already exists, reuse it instead of building from scratch.

**Process:**
1. After every significant implementation, run the `dry-guy` agent
2. Record any flagged patterns, near-duplicates, or extraction candidates here
3. When a shared utility is created from a DRY finding, move the entry to the "Resolved" section
4. Reference this log in PRs that touch flagged areas

---

## Status Legend

| Status | Meaning |
|--------|---------|
| `watch` | Identified as potential duplication risk — monitor as more PRDs are implemented |
| `flagged` | DRY-GUY has flagged active duplication — extraction needed |
| `in-progress` | Shared utility/component is being extracted |
| `resolved` | Shared utility created and all consumers refactored to use it |

---

## Active Watch List

### Database & Backend Patterns

| ID | Pattern / Component | PRDs Involved | Status | Notes |
|----|---------------------|---------------|--------|-------|
| DRY-001 | `DbId` type alias (`i64`) usage consistency | All PRDs | `watch` | Defined in PRD-000. Every module must use `DbId`, not raw `i64` for IDs |
| DRY-002 | Status lookup table query patterns | All PRDs with status FKs | `watch` | Expect repeated `JOIN {domain}_statuses` patterns — candidate for shared query helpers |
| DRY-003 | CRUD handler boilerplate (list/get/create/update/delete) | PRD-01, PRD-02, and all entity PRDs | `watch` | Axum handlers will repeat the same patterns — candidate for macro or generic handler |
| DRY-004 | Pagination query pattern | PRD-20, PRD-42, PRD-73, all list endpoints | `watch` | `LIMIT/OFFSET` or cursor-based pagination will appear in many handlers |
| DRY-005 | `updated_at` trigger creation in migrations | All PRDs with tables | `watch` | Trigger function defined once in PRD-000; each table just adds the trigger. Watch for copy-paste divergence |
| DRY-006 | Error response formatting | PRD-02 and all API PRDs | `watch` | Constraint violation → user-friendly error translation will be needed everywhere |
| DRY-007 | FK index creation pattern in migrations | All PRDs with tables | `watch` | Every FK needs `CREATE INDEX idx_{table}_{col}` — easy to forget or name inconsistently |
| DRY-008 | Soft delete `WHERE deleted_at IS NULL` filter | PRD-109, all entity repos | `watch` | Every repo query (find_by_id, list_*) must include this filter. Missing it = showing deleted records. |
| DRY-009 | `soft_delete` / `restore` / `hard_delete` method pattern | PRD-109, all entity repos | `watch` | All 9+ repos need identical method signatures. Candidate for trait or macro if boilerplate grows. |
| DRY-010 | Version-as-final transactional pattern | PRD-109, PRD-069 | `watch` | Unmark old + mark new in one transaction. Could be reused if other entities get versioning. |
| DRY-011 | Trash entity-type parallel lists (5 locations) | PRD-109 | `watch` | 9 entity type strings appear in 5 parallel match/list sites: `KNOWN_ENTITY_TYPES`, `PURGE_ORDER`, `table_and_name_expr`, `check_parent_trashed` (all in `trash_repo.rs`), and `dispatch_restore` (in `handlers/trash.rs`). Adding a new entity type requires updating all 5. Consider a single `EntityMeta` data array if the codebase grows beyond 12 entity types. |
| DRY-012 | `resolve_role_name` logic duplicated across handlers | PRD-03 | `resolved` | Extracted to `RoleRepo::resolve_name()` in `db/src/repositories/role_repo.rs`. Both `auth.rs` and `admin.rs` now call it. |
| DRY-013 | Role name magic strings (`"admin"`, `"creator"`, `"reviewer"`) | PRD-03 | `resolved` | Constants defined in `core/src/roles.rs` (`ROLE_ADMIN`, `ROLE_CREATOR`, `ROLE_REVIEWER`). `rbac.rs` updated to use them. |
| DRY-014 | Validate-then-hash password 2-step pattern | PRD-03 | `watch` | `validate_password_strength(...)` + `hash_password(...)` with identical `map_err` wrapping appears twice in `admin.rs:64-69` and `admin.rs:177-182`. Extract to `validate_and_hash_password(password, min_len) -> AppResult<String>` if a third occurrence appears (e.g., self-service password change endpoint). |
| DRY-015 | RBAC extractor boilerplate (`RequireAdmin`, `RequireCreator`, `RequireAuth`) | PRD-03 | `watch` | Three `FromRequestParts` impls that differ only in role check logic. If a 4th extractor (e.g., `RequireReviewer`) is added, extract a `require_role!` macro. |
| DRY-016 | `find_by_prompt_id` + event emit pattern in processor.rs | PRD-05 | `watch` | `ComfyUIExecutionRepo::find_by_prompt_id` + `event_tx.send(...)` appears 2x in `processor.rs` (handle_executing completion + handle_execution_error). Different event variants carry different data. Extract to shared helper if a 3rd occurrence appears. |
| DRY-017 | Middleware/router construction duplicated in main.rs and tests/common/mod.rs | PRD-02, PRD-05, PRD-10, PRD-09 | `resolved` | Fully resolved: `build_app_router()` extracted to `trulience_api::router` module. Both `main.rs` and `tests/common/mod.rs` now call the same shared function. Zero middleware duplication. |
| DRY-018 | Broadcast receiver loop pattern (recv + Lagged + Closed) | PRD-10 | `watch` | `persistence.rs` and `notifications/router.rs` share structurally identical `loop { match receiver.recv().await { Ok => handle, Lagged => warn, Closed => break } }`. Two instances with different handler logic. Extract a `run_subscriber(receiver, handler_fn)` utility if a 3rd broadcast subscriber is added. |
| DRY-019 | Channel name magic strings (`"in_app"`, `"digest"`, `"webhook"`, `"email"`) | PRD-10 | `resolved` | Constants defined in `core/src/channels.rs` (`CHANNEL_IN_APP`, `CHANNEL_DIGEST`, `CHANNEL_WEBHOOK`, `CHANNEL_EMAIL`). Router, digest scheduler, and notification handler updated. |

| DRY-074 | Rule type name strings in validation evaluator (`"required"`, `"type_check"`, etc.) | PRD-14 | `watch` | 8 rule type strings matched against in `core/src/validation/evaluator.rs`. They match the seeded `validation_rule_types` names. Currently only one consumer. Extract to `core/src/validation_rule_types.rs` constants if a second consumer (e.g., frontend, seed verification) appears. |
| DRY-075 | Import status magic strings + status_id magic number | PRD-14 | `resolved` | Hardcoded `"preview"`, `"committed"` strings and `status_id != 1` in handler. Extracted to `core/src/import_status.rs` constants (following DRY-013/DRY-019/DRY-072 pattern). |
| DRY-076 | Source type `"api"` magic string in `persist_preview_report` | PRD-14 | `watch` | Single-use string literal in `handlers/validation.rs`. Extract to a constant if a second import source type (e.g., `"csv_upload"`, `"bulk_file"`) is added. |
| DRY-077 | Tracing init boilerplate (dotenvy + registry + EnvFilter + fmt) | All binaries (api, worker, agent) | `flagged` | 3 binaries now share identical 6-line tracing init differing only in default filter string. Extract to `trulience_core::telemetry::init_tracing(default_filter: &str)`. Threshold of 3 met with PRD-06. |
| DRY-078 | Restart status magic `status_id` numbers (e.g., `DEFAULT 1` = initiated) | PRD-06 | `watch` | `restart_logs.status_id DEFAULT 1` relies on seed ordering. Same fragile pattern as DRY-075 (import status). `core/src/restart_status.rs` constants exist but are unused. Extract numeric IDs or resolve by name when status transitions are implemented. |
| DRY-079 | Metric name strings crossing SQL/Rust boundary | PRD-06 | `watch` | Metric names (`temperature_celsius`, `vram_used_percent`, `utilization_percent`) appear in migration seed SQL and `core/src/metric_names.rs`. Same cross-boundary pattern as DRY-070 (QA check types). Acceptable -- SQL migrations can't reference Rust constants. |
| DRY-080 | `DataResponse<T>` typed response envelope | PRD-06+ | `resolved` | Extracted to `api/src/response.rs`. Hardware handlers use it; other handlers still use `serde_json::json!({ "data": ... })`. Existing handlers should migrate to `DataResponse<T>` when touched. |
| DRY-081 | Agent WS reconnect (fixed delay) vs ComfyUI reconnect (exponential backoff) | PRD-05, PRD-06 | `watch` | Agent `sender.rs` uses fixed 5s reconnect delay. ComfyUI `reconnect.rs` uses configurable exponential backoff. Intentionally different -- agent reconnect is simpler. If a 3rd WebSocket client needs reconnect, consider extracting a shared `ReconnectStrategy` enum. |
| DRY-082 | `getCssVar()` runtime CSS custom property resolver | PRD-06 | `watch` | `MetricsChart.tsx:64-67` defines a local `getCssVar(name, fallback)` helper that reads CSS custom properties via `getComputedStyle`. Only 1 consumer now. Extract to `src/lib/css-vars.ts` when a 2nd charting or canvas component needs it. |
| DRY-083 | `DataResponse<T>` adoption in existing handlers | PRD-06+ | `flagged` | `notification.rs` (4 instances) and `validation.rs` (7 instances) still use ad-hoc `serde_json::json!({ "data": ... })` instead of the shared `DataResponse<T>` from `api/src/response.rs`. `reclamation.rs` (11 instances) migrated in PRD-15 audit. Migrate remaining when touched. |
| DRY-084 | Script type name magic strings (`"shell"`, `"python"`, `"binary"`) | PRD-09 | `resolved` | Constants defined in `core/src/script_types.rs` (`SCRIPT_TYPE_SHELL`, `SCRIPT_TYPE_PYTHON`, `SCRIPT_TYPE_BINARY`). `orchestrator.rs` updated to use them. Same pattern as DRY-013, DRY-019, DRY-072. |
| DRY-085 | QA handler `run_python_script` vs scripting subprocess module | PRD-09, PRD-22 | `watch` | `image_qa.rs:232-262` has its own `run_python_script()` (CLI args, no stdin, no timeout, no output cap) that is behaviorally duplicated by the new `core/scripting/subprocess.rs` (stdin-based, timeout, output cap, kill-on-drop). Different interfaces (args vs stdin) prevent direct replacement now. When QA scripts are refactored to accept stdin-based input, migrate to the scripting module's `run_command`. |
| DRY-086 | `VENV_DIR` env var name string | PRD-09 | `watch` | `"VENV_DIR"` literal appears 2x: `orchestrator.rs:101` (sets it) and `python.rs:108` (reads it). Different crates, tightly coupled contract. Extract to `core/src/script_types.rs` constant if a 3rd consumer appears. |
| DRY-090 | `ADMIN_ROLE` constant redefined in `handlers/jobs.rs` | PRD-07 | `resolved` | Hardcoded `const ADMIN_ROLE: &str = "admin"` instead of using `ROLE_ADMIN` from `core/src/roles.rs` (DRY-013). Replaced with import of existing constant. |
| DRY-092 | `list_by_user` / `list_all` structural duplicate in `job_repo.rs` | PRD-07 | `resolved` | Two methods shared identical pagination clamping, status filter logic, and query assembly differing only by `WHERE submitted_by = $1`. Extracted shared `list_jobs(pool, user_id: Option, params)` private method. |
| DRY-093 | `MAX_LIMIT`/`DEFAULT_LIMIT` pagination clamping pattern duplicated | PRD-07, PRD-10, PRD-12, PRD-17, PRD-39, PRD-42, PRD-44, PRD-47 | `flagged` | **9 consumers**: `tag_repo.rs` (100/500), `job_repo.rs` (50/100), `notification.rs` (50/100), `script_execution_repo` (~), `asset_repo.rs` (50/100), `dashboard.rs` handler (`FEED_MAX_LIMIT`/`FEED_DEFAULT_LIMIT`), `webhooks.rs` (50/200, now using `clamp_limit`/`clamp_offset` from core), `bug_reports.rs` (50/200, inline clamping), `delivery.rs` (50/200, fixed -- now uses `clamp_limit`/`clamp_offset`). Also 2x bare `unwrap_or(50)` in `reclamation.rs` handler without MAX_LIMIT cap. Shared `clamp_limit`/`clamp_offset` exists in `core/src/search.rs` -- remaining consumers should migrate. |
| DRY-098 | `validate_entity_type` function duplicated in `tags.rs` and `trash.rs` | PRD-47, PRD-109 | `watch` | Same function name and pattern but different entity registries (singular taggable types vs plural soft-deletable types). If a 3rd handler needs entity type validation, extract shared `validate_entity_type(value, valid_list, kind_label) -> AppResult<()>`. |
| DRY-326 | `can_undo_operation` structural duplicate between `batch_metadata.rs` and `maintenance.rs` core | PRD-88, PRD-18 | `watch` | `batch_metadata::can_undo_operation(&BatchOperationStatus)` and `maintenance::can_undo_operation(&BulkOperationStatus)` are structurally identical (check if status == Completed). Different enum types (BatchOperationStatus vs BulkOperationStatus). 2 consumers. Extract `CanUndo` trait or shared function at 3rd consumer. |
| DRY-327 | `STATUS_PREVIEW`/`STATUS_COMPLETED`/`STATUS_FAILED`/`STATUS_UNDONE` constants duplicated across 2 core modules | PRD-88, PRD-18 | `watch` | `batch_metadata.rs` defines `STATUS_PREVIEW`/`APPLYING`/`COMPLETED`/`FAILED`/`UNDONE` and `maintenance.rs` defines identical status name constants. Different domain contexts, same names. Not actionable yet (different enums). Watch for a 3rd module defining same lifecycle. |
| DRY-328 | `MissingItemType` (readiness.rs) vs `MissingItemCategory` (character_dashboard.rs) conceptual overlap | PRD-107, PRD-108 | `watch` | `readiness::MissingItemType` (6 variants) and `character_dashboard::MissingItemCategory` (5 variants) overlap on images, metadata, embeddings, quality_scores. Different granularity (readiness = per-asset, dashboard = aggregate). 2 consumers. Acceptable conceptual overlap -- different semantics. |
| DRY-329 | Local pagination structs in 6 Phase 8 handler files instead of shared `PaginationParams` | PRD-67, PRD-86, PRD-88, PRD-107, PRD-108, PRD-18 | `watch` | `ReadinessStateFilterParams`, `ListOperationsParams`, `ListRunsParams`, `ListEntityLogParams`, `BulkOperationListParams`, `CriteriaSearchParams` all contain `limit: Option<i64>, offset: Option<i64>` mixed with domain-specific filters. Extends DRY-276 (now 20+ handler files). Shared `PaginationParams` from `api/src/query.rs` covers pure-pagination cases but these mix domain fields. |
| DRY-094 | Magic status_id numbers `1, 2` in `dispatcher.rs` | PRD-07 | `resolved` | Hardcoded `status_id IN (1, 2)` instead of `JobStatus::Pending.id()` / `JobStatus::Running.id()`. Replaced with parameterized binds using the enum. |
| DRY-095 | Job WS message type magic strings in `progress.rs` | PRD-07 | `resolved` | `"job_progress"`, `"job_completed"`, `"job_failed"`, `"job_cancelled"` were inline strings. Extracted to `core/src/job_events.rs` constants (following DRY-079 / metric_names pattern). |
| DRY-096 | `serde_json::json!` + `Message::Text` + `broadcast` repeated 4x in `progress.rs` | PRD-07 | `resolved` | Extracted `broadcast_json(ws_manager, payload)` private helper to deduplicate the serialization + WS wrapping + broadcast pipeline. |
| DRY-097 | Ownership guard pattern (find + authorize) repeated 3x in `jobs.rs` | PRD-07 | `resolved` | `find_by_id` + `NotFound` + ownership check + `Forbidden` was copy-pasted in `get_job`, `cancel_job`, `retry_job`. Extracted `find_and_authorize(pool, job_id, auth, action)` helper. |
| DRY-167 | SHA-256 hex digest implemented 3x in core crate | PRD-13, PRD-12, PRD-45 | `flagged` | Three independent implementations: `metadata.rs:sha256_hex()` (Sha256+hex::encode), `api_keys.rs:hash_api_key()` (Sha256+hex::encode), `audit.rs:compute_integrity_hash()` (chained SHA-256). First two are structurally identical (both `Sha256::digest` + `hex::encode`). Extract shared `sha256_hex(data: &[u8]) -> String` to `core/src/hashing.rs`; keep `compute_integrity_hash` separate (chained/different purpose). 3 consumers, threshold met. |
| DRY-168 | Metadata regeneration logic duplicated within `metadata.rs` handler | PRD-13 | `flagged` | Lines 197-215 and 267-279 in `api/src/handlers/metadata.rs` repeat the same 5-step pipeline: `serialize_metadata` -> `sha256_hex` -> `CreateMetadataGeneration` construction -> `MetadataGenerationRepo::upsert`. Extract `upsert_generation(pool, entity_type, entity_id, project_id, metadata) -> Result<MetadataGeneration>` private helper. 2 call sites in same file. |
| DRY-169 | `find_stale_characters` / `find_stale_scenes` structural duplicates | PRD-13 | `flagged` | `metadata_repo.rs` has two 20-line methods that differ only in table name (`characters` vs `scenes`), join column, and entity type string. Same SELECT, same WHERE logic, same COALESCE pattern. Extract shared `find_stale_entities(pool, project_id, table, join_col, entity_type) -> Vec<StaleMetadata>` or use a generic approach with `&str` table name parameter. |
| DRY-170 | Magic strings `'character'`/`'scene'` in metadata SQL instead of constants | PRD-13 | `flagged` | `metadata_repo.rs` hardcodes `'character'` and `'scene'` in 4 SQL queries instead of using `ENTITY_TYPE_CHARACTER`/`ENTITY_TYPE_SCENE` from `core/src/metadata.rs`. Use `$N` bind params with the existing constants. |
| DRY-174 | `IMAGE_EXTENSIONS` in `importer.rs` overlaps with `VALID_IMAGE_FORMATS` in `images.rs` | PRD-16, PRD-21 | `watch` | `core/src/importer.rs` defines `IMAGE_EXTENSIONS = [".jpg", ".jpeg", ".png", ".webp", ".tiff", ".bmp"]` (with dots) while `core/src/images.rs` defines `VALID_IMAGE_FORMATS = ["jpg", "jpeg", "png", "webp", "tiff", "bmp"]` (without dots). Same set, different format. Consolidate by making `importer.rs` derive from `VALID_IMAGE_FORMATS` with dot prefix, or add a `VALID_IMAGE_EXTENSIONS` to `images.rs`. 2 consumers. |
| DRY-175 | Hardcoded `'uploading'` string in `import_session_repo.rs` SQL | PRD-16 | `watch` | Line 42 uses `'uploading'` string literal instead of `SESSION_STATUS_UPLOADING` constant from `core/src/importer.rs`. 1 SQL consumer. Fix when file is next touched. |
| DRY-176 | `serde_json::json!` responses in `metadata.rs` and `importer.rs` handlers | PRD-13, PRD-16 | `flagged` | `metadata.rs` handler uses `serde_json::json!` at 2 endpoints (regeneration report, staleness preview) and `importer.rs` at 1 endpoint (upload response) instead of typed `DataResponse<T>` structs. Same pattern as DRY-083. Migrate to `DataResponse<T>` with typed response structs. |

| DRY-179 | Duplicate sensitive-key redaction functions in `audit.rs` vs `config_export.rs` | PRD-44, PRD-45 | `flagged` | Two recursive JSON redaction functions with overlapping key lists (6 shared keys), different placeholders (`"[REDACTED]"` vs `"***REDACTED***"`), and different APIs (clone vs mutate-in-place). `audit.rs:SENSITIVE_FIELDS` (10 entries) and `config_export.rs:SENSITIVE_KEYS` (10 entries). Extract shared `core/src/redaction.rs` with unified key list, shared `is_sensitive_key()`, and both mutate/clone variants. |
| DRY-180 | `ensure_segment_exists` pattern repeated 3x in `approval.rs` handler | PRD-35, PRD-38 | `resolved` | Resolved by DRY-227. Extracted `ensure_segment_exists(pool, segment_id)` to `api/src/handlers/segment.rs` as pub function. Both `approval.rs` (3x) and `review_notes.rs` (2x) now import and call it. |
| DRY-182 | ComfyUI workflow parsing duplicated between backend handler and frontend parser | PRD-33 | `watch` | `handlers/workflow_canvas.rs:import_comfyui` (~85 lines) and `comfyui-parser.ts:parseComfyUIWorkflow` (~53 lines) implement the same node/edge extraction from ComfyUI JSON. Cross-boundary behavioral duplicate. Frontend also has `exportToComfyUI` (no backend equivalent). Designate frontend as client-side parser for offline use; if backend handler is the primary import path, consider moving parsing logic to `core/src/workflow_canvas.rs` for testability. 2 consumers (1 Rust, 1 TS). |
| DRY-183 | Inline pagination clamping in `bug_reports.rs` instead of `clamp_limit`/`clamp_offset` | PRD-44 | `flagged` | `params.limit.unwrap_or(50).min(200)` and `params.offset.unwrap_or(0)` inline in handler instead of using shared `clamp_limit`/`clamp_offset` from `core/src/search.rs`. DRY-093 8th consumer. |
| DRY-184 | Hardcoded `"admin"` string in `bug_reports.rs` instead of `ROLE_ADMIN` | PRD-44 | `flagged` | 2x `"admin"` string at lines 73 and 111 instead of `ROLE_ADMIN` from `core/src/roles.rs`. Same violation as DRY-090 (CRITICAL in PRD-07). |
| DRY-189 | State machine pattern structural duplicate (`bug_report.rs` vs `scheduling.rs`) | PRD-44, PRD-08 | `watch` | Both have `valid_transitions(from) -> &[targets]` + `validate_transition(from, to) -> Result<()>` with identical logic but different types (`&str` vs `i16`) and error types (`CoreError` vs `String`). 2 consumers. Extract generic `StateMachine` trait at 3rd consumer. |
| DRY-190 | Auth extractor inconsistency (`RequireAuth` vs `AuthUser`) across handler files | PRD-33, PRD-35, PRD-44 | `watch` | `workflow_canvas.rs` uses `RequireAuth` while `approval.rs` and `bug_reports.rs` use `AuthUser`. Both provide same functionality. Style inconsistency, not duplication. Standardize when files are next touched. |
| DRY-199 | Role name strings `admin`/`creator`/`reviewer` in `tourPaths.ts` cross-boundary | PRD-53 | `watch` | Tour paths keyed by role name strings matching backend `core/src/roles.rs` constants. Same cross-boundary pattern as DRY-114 (preset names). Sync comment added. No frontend role constants exist. Extract at 2nd frontend consumer. |
| DRY-201 | Regex compiled on every call in `scene_type_config.rs` | PRD-23 | `resolved` | `regex::Regex::new(r"\{(\w+)\}")` was compiled on every call to `resolve_prompt_template()` and `extract_placeholders()`. Extracted to `static PLACEHOLDER_RE: LazyLock<regex::Regex>` -- compiled once, reused forever. |
| DRY-202 | `BadgeVariant` type redefined in `SceneMatrixView.tsx` | PRD-23 | `resolved` | `type BadgeVariant` was locally redefined instead of importing from `Badge.tsx`. Exported `BadgeVariant` from `Badge.tsx` + primitives barrel. SceneMatrixView now imports it. StatusBadge.tsx and ActiveTasksWidget.tsx also redefine it (DRY-020 related) -- fix when touched. |
| DRY-203 | Textarea className string duplicated 3x in scene-types feature | PRD-23 | `resolved` | Identical 150-char textarea className string appeared in `PromptTemplateEditor.tsx` (2x) and `SceneTypeEditor.tsx` (1x). Extracted `TEXTAREA_CLASSES` constant to `PromptTemplateEditor.tsx`, imported in `SceneTypeEditor.tsx`. |
| DRY-204 | Magic `status_id` numbers in `generate_matrix` handler | PRD-23 | `resolved` | `match status_id { 1 => "pending", 2 => "generating", ... }` used raw numbers instead of `SceneStatus` enum. Extracted `scene_status_label()` function using `SceneStatus::*.id()` pattern (same as DRY-094 fix in `dispatcher.rs`). |
| DRY-205 | `validate_variant_applicability` structurally duplicates `validate_known_key` | PRD-23, PRD-53 | `watch` | Same contains-check + error-format pattern as `onboarding.rs:validate_known_key()`. 2 consumers with different error types and contexts. Extract generic validator at 3rd consumer. |
| DRY-206 | CRUD handlers in `scene_type.rs` return raw `Json<T>` instead of `DataResponse<T>` | PRD-23, PRD-01 | `watch` | `list_by_project`, `get_by_id`, `update`, `delete`, `create` handlers return `Json(entity)` directly without `DataResponse` envelope. Same pattern as other pre-DataResponse handlers (scenes, segments, source_images, derived_images). Low priority -- matches existing convention for original entity CRUD. Migrate when handlers are next touched. |
| DRY-207 | Variant applicability constants duplicated between Rust and TypeScript | PRD-23 | `watch` | `core/src/scene_type_config.rs` defines `VARIANT_CLOTHED/TOPLESS/BOTH/CLOTHES_OFF` and `VALID_VARIANT_TYPES`. Frontend `types.ts` defines `VARIANT_OPTIONS` with same values. Same cross-boundary pattern as DRY-114 (preset names), DRY-079 (metric names). Acceptable -- different runtimes. |
| DRY-208 | `CLIP_POSITIONS` and `CLIP_TABS` duplicate clip position labels | PRD-23 | `watch` | `types.ts:CLIP_POSITIONS = ["full_clip", "start_clip", "continuation_clip"]` and `PromptTemplateEditor.tsx:CLIP_TABS` duplicate the same 3 position identifiers. `CLIP_TABS` adds human labels. Same file-pair, acceptable -- `CLIP_POSITIONS` is for API params, `CLIP_TABS` is for UI tabs. |
| DRY-209 | `EmbeddingStatus` enum duplicated in `core/src/embedding.rs` and `db/src/models/status.rs` | PRD-76 | `resolved` | Hand-rolled enum in core (with `from_id`, `label`, `id`) and macro-generated enum in db (with only `id`). Core version is canonical because domain logic (`classify_extraction_result`) depends on it. Removed db `define_status_enum!` version, added comment pointing to core as canonical source. Tests moved to core. |
| DRY-212 | `find_by_id + ok_or(NotFound)` repeated 9x in `workers.rs` handler without helper | PRD-46 | `resolved` | Extracted `ensure_worker_exists(pool, id) -> AppResult<Worker>` helper and `validate_create_input(input) -> AppResult<()>` helper, following DRY-097/DRY-121 pattern. Reduced from 9 inline instances to 5 calls to helper + 2 special cases (update returns `Option`, approve returns `Option`). |
| DRY-213 | Hardcoded `status_id` numbers in `worker_repo.rs` SQL | PRD-46 | `resolved` | `status_id = 3` (Offline), `status_id = 1` (Idle) hardcoded in `register`, `list_available`, `approve`, `decommission` methods. Replaced with bind parameters using `WorkerStatus::Idle.id()` / `WorkerStatus::Offline.id()`. Fleet stats FILTER clauses left as-is (cannot easily parameterize SQL aggregate filters). |
| DRY-215 | Redundant `.map_err(\|e\| AppError::Core(e))` in `embedding.rs` handler | PRD-76 | `resolved` | `#[from] CoreError` on `AppError` provides auto-conversion via `?`. Removed explicit `map_err` closure. |
| DRY-216 | Worker validation block duplicated in `register_worker` and `self_register_worker` | PRD-46 | `resolved` | Identical 4-line validation block (validate_worker_name + validate_tags) extracted to `validate_create_input(&input)` helper in same file. |
| DRY-218 | `formatHeartbeat` relative time formatter in `WorkerCard.tsx` | PRD-46 | `watch` | Custom relative time formatter (`Xs ago`, `Xm ago`, `Xh ago`) in `WorkerCard.tsx:28-37`. 1 consumer. Extract to `@/lib/format.ts` as `formatRelativeTime(iso)` if a 2nd consumer appears. |
| DRY-226 | `makeAction()` test helper duplicated between undo test files | PRD-51 | `watch` | `UndoTree.test.ts` defines `makeAction(overrides: Partial<UndoAction>)` (full override object) and `HistoryBrowser.test.tsx` defines `makeAction(label: string)` (shortcut). Same concept, different signatures. 2 consumers in same feature. Extract shared `makeTestAction()` to `features/undo/__tests__/helpers.ts` if a 3rd undo test file appears. |
| DRY-227 | `ensure_segment_exists` duplicated in `approval.rs` and `review_notes.rs` | PRD-35, PRD-38 | `resolved` | Identical 8-line pattern (SegmentRepo::find_by_id + ok_or_else + CoreError::NotFound) duplicated between `approval.rs` (3x inline) and `review_notes.rs` (2x inline). Extracted to public `ensure_segment_exists(pool, segment_id) -> AppResult<()>` in `api/src/handlers/segment.rs`. Both handlers now import and call it. Also resolves DRY-180. |
| DRY-231 | Fully-qualified `trulience_core::error::CoreError::NotFound` in `review_notes.rs` and `approval.rs` | PRD-38, PRD-35 | `resolved` | `review_notes.rs` used fully-qualified `trulience_core::error::CoreError::NotFound` (3x) and `approval.rs` similarly (1x) instead of a `use CoreError;` import alias used by all other handler files. Added `use trulience_core::error::CoreError;` import to both files. |
| DRY-232 | `validate_control_action` called with constant strings always succeeds | PRD-34 | `watch` | `job_debug.rs` handler calls `validate_control_action("pause")`, `validate_control_action("resume")`, `validate_control_action("abort")` -- all hardcoded valid strings, so validation always returns `Ok`. Validation is useful for dynamic input but unnecessary for compile-time constants. 3 call sites. Remove when handler is next touched, or keep as defensive-in-depth. |
| DRY-233 | `validate_recent_limit` reimplements `clamp_limit` pattern | PRD-31 | `watch` | `core/src/command_palette.rs:validate_recent_limit()` implements `limit.min(MAX_RECENT_ITEMS).max(1)` which is a specialized version of `clamp_limit()` from `core/src/search.rs` (uses `unwrap_or(default).min(max)`). Different API (no Option, no default, has min=1 floor). 1 consumer. Consider aligning at 2nd consumer. |
| DRY-264 | `serde_json::json!` in 3 `production_run.rs` handler endpoints instead of `DataResponse<T>` | PRD-57 | `resolved` | Created `SubmitCellsResponse`, `ResubmitResponse`, `DeliverResponse` typed structs in `db/src/models/production_run.rs`. All 3 handler endpoints now use `DataResponse<T>`. |
| DRY-265 | Magic `status_id` numbers in `production_run_repo.rs` and `production_run.rs` handler | PRD-57 | `resolved` | Repo: `mark_completed` and `list_failed_cells` now use `$2` bind param with `RUN_STATUS_ID_COMPLETED`/`RUN_STATUS_ID_FAILED`. Handler: all magic numbers replaced with `RUN_STATUS_ID_*` constants from `core/src/batch_production.rs`. |
| DRY-266 | `validate_unit_range` pattern (`!(0.0..=1.0).contains(&threshold)`) duplicated 5x across core modules | PRD-25, PRD-26, PRD-22 | `resolved` | Extracted `validate_unit_range(value, name)` to `core/src/threshold_validation.rs`. 5 consumers refactored to delegate: `restitching.rs`, `temporal_continuity.rs` (2x), `embedding.rs`, `quality_gate.rs`. |
| DRY-267 | Face detection boilerplate duplicated across Python scripts | PRD-26, PRD-22 | `watch` | Haar cascade init + `detectMultiScale` + largest face selection repeated in `temporal_drift_analysis.py`, `temporal_centering.py`, and `qa_face_detection.py`. Also `GaussianBlur((21,21),0)` grain extraction repeated between `temporal_grain_analysis.py` and `temporal_grain_normalize.py`. Extract `common/face_utils.py` with `detect_largest_face()` and `common/grain_utils.py` with `extract_grain()` at 4th consumer. |
| DRY-268 | `increment_completed`/`increment_failed` structural duplicate in `production_run_repo.rs` | PRD-57 | `watch` | Lines 144-175: two methods differ only in column name (`completed_cells` vs `failed_cells`). Same UPDATE + SET + WHERE + RETURNING pattern. 2 consumers. Extract `increment_counter(pool, run_id, column_name)` if a 3rd counter column is added. |
| DRY-291 | `Regex::new(PLACEHOLDER_PATTERN)` compiled per-call in `prompt_editor.rs` | PRD-63 | `resolved` | `extract_placeholders()` compiled regex on every invocation instead of using `static LazyLock<Regex>` pattern established in `scene_type_config.rs`. Extracted `static PLACEHOLDER_RE: LazyLock<Regex>` module-level constant. Same violation as DRY-201 (scene_type_config.rs, previously fixed). |
| DRY-292 | `serde_json::json!` for diff response in `workflow_import.rs` handler | PRD-75 | `resolved` | `diff_versions` handler built response with `serde_json::json!({...})` (6 fields) instead of typed struct + `DataResponse<T>`. Created `WorkflowDiffResponse` in `db/src/models/workflow_version.rs`. Handler now uses typed struct. Same violation pattern as DRY-083/DRY-264. |
| DRY-293 | Inline pagination clamping in `hook_repo.rs` | PRD-77 | `resolved` | `filter.limit.unwrap_or(100).min(500)` and `filter.offset.unwrap_or(0).max(0)` instead of `clamp_limit`/`clamp_offset` from `core/src/search.rs`. Replaced with `clamp_limit(filter.limit, 100, 500)` and `clamp_offset(filter.offset)`. Extends DRY-093 pattern. |
| DRY-298 | `VersionListParams`/`ListVersionsParams`/`PaginationParams` -- 3 new identical pagination structs | PRD-63, PRD-75, PRD-77 | `watch` | `VersionListParams` in `prompt_editor.rs` handler, `ListVersionsParams` in `workflow_import.rs` handler, and `PaginationParams` in `pipeline_hooks.rs` handler are all `{ limit: Option<i64>, offset: Option<i64> }`. Extends DRY-276 (now 16+ handler files). |
| DRY-299 | Version auto-increment SQL pattern duplicated across 2 repos | PRD-63, PRD-75 | `watch` | `COALESCE((SELECT MAX(version) FROM {table} WHERE {fk} = $1), 0) + 1` structural duplicate in `prompt_version_repo.rs` (line 27) and `workflow_version_repo.rs` (line 30). 2 consumers. Acceptable as repo-specific SQL. Extract generic `next_version_subquery(table, fk_column)` SQL fragment builder at 3rd consumer. |
| DRY-300 | Hook point strings hardcoded in `get_effective_hooks` handler | PRD-77 | `watch` | Lines 366-372: `["post_variant", "pre_segment", "post_segment", "pre_concatenation", "post_delivery"]` as hardcoded string array instead of deriving from `HookPoint` enum variants. The `HookPoint` enum in `core/src/pipeline_hooks.rs` has `as_str()` on each variant but no `all_variants()` method. 1 consumer. Add `HookPoint::all()` method at 2nd consumer. |
| DRY-301 | Enum boilerplate (as_str + from_str + Display) repeated 4x in `pipeline_hooks.rs` | PRD-77 | `watch` | `HookType`, `HookPoint`, `ScopeType`, `FailureMode` each have identical boilerplate: `as_str() -> &str`, `from_str(&str) -> Result`, `Display` impl. 4 enums in 1 module. Currently contained. Extract macro `impl_str_enum!(EnumName, [("variant", "string")]...)` if a 2nd module with 3+ similar enums appears. |

### Frontend Patterns

| ID | Pattern / Component | PRDs Involved | Status | Notes |
|----|---------------------|---------------|--------|-------|
| DRY-020 | Status badge/chip component | PRD-29, PRD-35, PRD-42, PRD-54 | `watch` | Status display (colored badge with lookup name) will appear in many views |
| DRY-021 | Data table with sort/filter/pagination | PRD-29, PRD-20, PRD-42, PRD-73 | `watch` | Reusable table component needed early — many PRDs will need it |
| DRY-022 | Confirmation dialog (destructive actions) | PRD-29, PRD-15, PRD-72 | `watch` | CASCADE deletes require confirmation — shared dialog needed |
| DRY-023 | Image thumbnail/preview component | PRD-21, PRD-62, PRD-83, PRD-96 | `watch` | Multiple PRDs display image/video thumbnails — one component |
| DRY-024 | Progress indicator (job/generation) | PRD-24, PRD-54, PRD-57, PRD-90 | `watch` | Generation progress bars/strips appear across many views |
| DRY-025 | Side-by-side comparison layout | PRD-22, PRD-68, PRD-101 | `watch` | Image and video comparison views share the same layout pattern |
| DRY-026 | Form validation patterns | PRD-14, PRD-23, PRD-66 | `watch` | Input validation with error display will repeat across all forms |
| DRY-099 | `TagSuggestion` type duplicated `TagWithCount` in `TagInput.tsx` | PRD-47 | `resolved` | `TagSuggestion` was structurally identical to `TagWithCount` (`TagInfo + usage_count`). Unified to single `TagWithCount` type in `TagChip.tsx`. |
| DRY-102 | Click-outside pattern duplicated in `TagInput.tsx`, `Dropdown.tsx`, `JobTrayPanel.tsx` | PRD-47, PRD-29, PRD-54 | `resolved` | 3 consumers reached threshold. Extracted `useClickOutside(ref, callback, enabled?)` to `src/hooks/useClickOutside.ts`. All 3 consumers refactored. |
| DRY-103 | Raw `api.*()` calls in tag components instead of TanStack Query hooks | PRD-47 | `watch` | `TagInput.tsx` and `TagFilter.tsx` use `api.get/post/delete` directly. Established pattern is TanStack Query hooks (see `use-hardware.ts`). Extract `useTags`, `useApplyTag`, `useRemoveTag`, `useTagSuggestions` hooks when feature matures. |
| DRY-104 | Taggable entity type string constants | PRD-47 | `watch` | `VALID_ENTITY_TYPES` in `tags.rs:292` -- 1 consumer. Extract to `core/src/entity_types.rs` if a 2nd consumer needs the list. |
| DRY-105 | Inline SVG close icon in `TagChip.tsx` | PRD-47 | `watch` | Hardcoded X icon SVG. 1 consumer. Extract to design system icon token at 2nd inline close icon. |
| DRY-106 | Theme status name `'active'` magic string in `theme_repo.rs` SQL | PRD-29 | `watch` | `list_custom_themes()` uses `WHERE name = 'active'` subquery. 1 consumer. Extract to `core/src/theme_status.rs` constant if a 2nd consumer appears. Same cross-boundary pattern as DRY-079. |
| DRY-107 | `STATUS_OPTIONS` hardcoded status_id numbers in `TokenEditor.tsx` | PRD-29 | `watch` | `{ value: "1", label: "Draft" }` etc. relies on migration seed ordering. 1 consumer. If a 2nd frontend component needs theme status list, fetch from API or define shared constants. |
| DRY-108 | `TokenEditor.tsx` exceeded 500-line threshold (670 lines) | PRD-29 | `resolved` | Extracted 7 section components (Surface/Text/Action/Border/Font/Spacing + Preview) and shared types/constants to `token-editor/TokenSections.tsx` (404 lines). Main component now 298 lines. 6x structurally identical `updateX` functions replaced with generic `updateTokenSection<K>()`. |
| DRY-109 | `TagWithCount` redundantly re-exported from `TagInput.tsx` and `TagFilter.tsx` | PRD-47 | `resolved` | Both files re-exported `TagWithCount` even though they import it from the canonical source `TagChip.tsx`. Removed redundant re-exports to prevent import confusion. |
| DRY-110 | `CATEGORY_LABELS` and `CATEGORY_ORDER` duplicated in `CheatSheet.tsx` and `KeymapEditor.tsx` | PRD-52 | `resolved` | Identical constant declarations in two files. Extracted to `ShortcutRegistry.ts` alongside `groupBindingsByCategory()` utility. |
| DRY-111 | `snapValue()` duplicated in `useSnapGrid.ts` and `usePanelResize.ts` | PRD-30 | `resolved` | Identical function `Math.round(value / gridSize) * gridSize`. Exported from `useSnapGrid.ts`, imported in `usePanelResize.ts`. |
| DRY-112 | Debounce timer pattern across 3 persistence hooks | PRD-29, PRD-30, PRD-32 | `watch` | `useThemePersistence`, `useLayoutPersistence`, and `useProficiencyTracker` all use `useRef<setTimeout>` + `clearTimeout` + `setTimeout` debounce pattern with different delays (500ms, 2000ms, 2000ms). Structurally similar but different callback logic. Extract `useDebouncedCallback(fn, delay)` if a 4th consumer appears. |
| DRY-113 | Proficiency level magic strings in SQL | PRD-32 | `watch` | `'beginner'`, `'intermediate'`, `'expert'` appear in `proficiency_repo.rs` SQL and migration DDL. Same cross-boundary pattern as DRY-079 (metric names in SQL). Acceptable for now. Extract to `core/src/proficiency_levels.rs` if a second Rust consumer appears. |
| DRY-114 | Preset name list duplicated between backend and frontend | PRD-52 | `watch` | Backend `PRESET_NAMES` in `keymaps.rs` and frontend `presets` object in `presets/index.ts` both enumerate `[default, premiere, resolve, avid]`. Cross-boundary duplication. The `GET /keymaps/presets` endpoint serves as single source of truth; frontend presets map is local for offline key resolution. No action needed unless lists diverge. |
| DRY-115 | Raw `api.*()` calls in layout persistence hooks | PRD-30 | `watch` | `useLayoutPersistence.ts` and `PresetSwitcher.tsx` both make raw `api.get/put/post/delete` calls to `/user/layouts`. Same pattern as DRY-103 (tags). Extract TanStack Query hooks when layout feature matures. |
| DRY-127 | `formatTime()` duplicated in `CinemaMode.tsx` and `GridControls.tsx` | PRD-36 | `resolved` | Identical function (seconds to `M:SS`) in 2 cinema files, behaviorally duplicating `formatDuration()` from `video-player/frame-utils.ts`. Removed both locals, replaced with `formatDuration` import from `@/features/video-player`. |
| DRY-128 | Recharts Tooltip `contentStyle` object duplicated 7x across 3 chart components | PRD-41 | `resolved` | Identical 4-property style object in QualityCharts (4x), WorkflowComparison (2x), WorkerBenchmark (1x). Extracted `TOOLTIP_CONTENT_STYLE`, `AXIS_TICK_STYLE`, `GRID_STROKE` to `performance/chartStyles.ts`. |
| DRY-129 | `formatElapsed()` reimplements duration formatting in `ActiveTasksWidget.tsx` | PRD-42 | `resolved` | Behavioral duplicate of `formatDuration()` from `@/lib/format.ts`. Refactored to delegate to `formatDuration(seconds * 1000)` with null guard. |
| DRY-130 | Click-outside pattern at 3 consumers (threshold met) | PRD-47, PRD-29, PRD-54 | `resolved` | See DRY-102 (updated to resolved). Extracted `useClickOutside` hook to `src/hooks/useClickOutside.ts`. Refactored TagInput, Dropdown, JobTrayPanel. |
| DRY-116 | `export_keymap` handler duplicate JSON branches | PRD-52 | `resolved` | Two `serde_json::json!` branches (Some/None) produced identical structure with different values. Extracted shared destructuring with fallback defaults. |
| DRY-117 | `formatFileSize()` duplicated in `AssetBrowser.tsx` and `AssetDetail.tsx` | PRD-17 | `resolved` | Identical function behaviorally duplicating `formatBytes()` from `@/lib/format.ts`. Removed both, replaced with `formatBytes` import. |
| DRY-118 | `formatDate()` inline helper in `AssetDetail.tsx` | PRD-17 | `resolved` | Short-date formatter was local to one file. Extracted to shared `formatDate()` in `@/lib/format.ts` alongside existing `formatDateTime` and `formatCountdown`. |
| DRY-119 | `reclamation.rs` handler uses `serde_json::json!` (11x) instead of `DataResponse<T>` | PRD-15 | `resolved` | Handler imported `DataResponse` but only used it for 2/13 endpoints. Migrated all 11 remaining endpoints to `DataResponse<T>` with `impl IntoResponse` return type. DRY-083 partially improved (reclamation cleared; notification.rs + validation.rs remain). |
| DRY-120 | Column list repeated 15x across `reclamation_repo.rs` (no COLUMNS constants) | PRD-15 | `resolved` | Trash queue columns 5x, protection rule columns 4x, policy columns 3x, run columns 3x. Extracted `RULE_COLUMNS`, `POLICY_COLUMNS`, `TRASH_COLUMNS`, `RUN_COLUMNS` constants following `asset_repo.rs` COLUMNS pattern. |
| DRY-121 | `verify_exists + NotFound` guard repeated 4x in `assets.rs` handler | PRD-17 | `resolved` | Identical 5-line pattern (verify_exists + AppError::Core(CoreError::NotFound)) in add_dependency, get_impact, add_note, rate_asset. Extracted `ensure_asset_exists(pool, id)` private helper (DRY-097 pattern). |
| DRY-122 | Trash queue status_id magic numbers in `reclamation_repo.rs` | PRD-15 | `watch` | `TRASH_STATUS_PENDING = 1`, `TRASH_STATUS_DELETED = 3`, `TRASH_STATUS_RESTORED = 4` are repo-local constants matching seed ordering. Same fragile pattern as DRY-078 (restart status). Extract to `core/src/trash_status.rs` if a second consumer needs these values. |
| DRY-123 | `STATUS_OPTIONS` hardcoded asset status_id numbers in `AssetBrowser.tsx` | PRD-17 | `watch` | `{ value: "1", label: "Active" }` etc. relies on migration seed ordering. Same pattern as DRY-107 (theme STATUS_OPTIONS). 1 consumer. Fetch from API endpoint or share constants at 2nd consumer. |
| DRY-124 | `ASSET_TYPE_OPTIONS` hardcoded asset type_id numbers in `AssetBrowser.tsx` | PRD-17 | `watch` | `{ value: "1", label: "Model" }` etc. relies on migration seed ordering. 1 consumer. `AssetRepo::list_types()` endpoint exists but is not being called. Fetch dynamically if a 2nd consumer needs type list. |
| DRY-125 | `"required"` and `"info"` magic strings as default values in `asset_repo.rs` | PRD-17 | `watch` | `dependency_role.unwrap_or("required")` and `severity.unwrap_or("info")` -- 1 consumer each. Extract to constants if a 2nd consumer appears. |
| DRY-126 | `"manual"` run_type magic string in reclamation handler | PRD-15 | `watch` | `run_type: "manual".to_string()` in handler. 1 consumer. Extract to `core/src/reclamation_types.rs` constant if a 2nd run_type source (e.g., "scheduled") appears. |
| DRY-131 | Workflow aggregation SELECT columns duplicated in `performance_metric_repo.rs` | PRD-41 | `watch` | 9 identical column expressions in `aggregate_by_workflow` vs `aggregate_for_workflows`. Same pattern as DRY-120 (column constants). Extract `WORKFLOW_AGG_COLUMNS` constant if a 3rd consumer appears. |
| DRY-132 | Scope type magic strings (`"global"`, `"workflow"`, `"worker"`) in `performance.rs` handler | PRD-41 | `watch` | 3 magic strings used in threshold create/update handlers + SQL `scope_type` CHECK. 1 Rust consumer. Extract to `core/src/scope_types.rs` if a 2nd consumer appears. |
| DRY-133 | Worker aggregation SELECT columns duplicated in `performance_metric_repo.rs` | PRD-41 | `watch` | 8 identical column expressions in `aggregate_by_worker` vs `aggregate_single_worker`. Same as DRY-131. Extract `WORKER_AGG_COLUMNS` constant if a 3rd consumer appears. |
| DRY-134 | `parse_from`/`parse_to` date parsing helpers in `performance.rs` handler | PRD-41 | `watch` | Extracts optional `from`/`to` query params, parses with `chrono::NaiveDate::parse_from_str`. 1 consumer. Extract to `api/src/util.rs` if a 2nd handler needs date range parsing. |
| DRY-135 | `renderWithProviders` test helper duplicated across 6 test files | PRD-85, PRD-41, PRD-42, PRD-15, PRD-21, PRD-08 | `resolved` | Extracted to `src/lib/test-utils.tsx`. All 6 consumers (ExtensionManager, PerformanceDashboard, StudioPulse, ReclamationDashboard, VariantGallery, QueueStatusView) now import from shared location. |
| DRY-136 | `parseError` + JSON parse try/catch pattern in 2 sub-components of `ExtensionManager.tsx` | PRD-85 | `watch` | `SettingsEditor` and `InstallForm` both use `useState<string \| null>(null)`, `try { JSON.parse } catch { setParseError }`, and identical error `<p>` display. Same file, 2 instances. Extract shared `useJsonParse` hook if a 3rd JSON-editing component appears. |
| DRY-137 | `collectDesignTokens` in `ExtensionSandbox.tsx` vs `getCssVar` in `MetricsChart.tsx` | PRD-85, PRD-06 | `watch` | Both read CSS custom properties via `getComputedStyle(document.documentElement)`. Different purposes (batch collection vs single lookup). Related to DRY-082. Extract shared `src/lib/css-vars.ts` when a 3rd consumer needs CSS var access. |
| DRY-161 | Confirmation dialog pattern (AlertTriangle + description + Cancel/Action buttons) | PRD-12 | `watch` | `ApiKeyManager.tsx` (rotate/revoke key confirmations) and `WebhookManager.tsx` (delete webhook confirmation) share identical dialog structure: AlertTriangle icon, warning description paragraph, Cancel + destructive Action button pair. 2 consumers. Design system `ConfirmDialog` component candidate at 3rd consumer. Related to DRY-022. |
| DRY-162 | Admin table styling pattern (Card + overflow-x-auto + table + th/td classes) | PRD-12, PRD-85 | `watch` | `ApiKeyManager.tsx`, `WebhookManager.tsx`, `DeliveryLog.tsx`, `ExtensionManager.tsx` all repeat identical Card > overflow-x-auto > table > thead > th class pattern. 4 consumers. Design system `AdminTable` component candidate (threshold met but deferred to design system work). |
| DRY-146 | `formatWait()` + `formatSeconds()` seconds-to-human formatters in queue components | PRD-08 | `watch` | `QueueStatusView.tsx:formatWait(secs)` and `QuotaStatusBadge.tsx:formatSeconds(secs)` are structurally similar to `formatDuration(ms)` from `@/lib/format.ts`. Different input units (seconds vs ms) and slightly different output format. 2 consumers. Extract `formatDurationSeconds()` to `@/lib/format.ts` at 3rd consumer. |
| DRY-147 | `UpdateImageVariant` struct with all `None` fields repeated in handler | PRD-21 | `watch` | `reject_variant` and `export_for_editing` both construct `UpdateImageVariant` with 11 `None` fields. Could add `Default` impl. 2 consumers. Extract at 3rd occurrence. |
| DRY-148 | Multipart upload + validate format + store file pattern in image_variant handler | PRD-21 | `watch` | `reimport_variant` and `upload_manual_variant` share ~30 lines of near-identical multipart parsing, format validation, and file storage logic. 2 consumers. Extract `parse_image_upload()` helper at 3rd upload handler (related to DRY-042). |
| DRY-149 | `state_machine::status_name` duplicates `JobStatus` enum variant names | PRD-08 | `watch` | `core/src/scheduling.rs:status_name()` maps status_id to string names ("Pending", "Running", etc.) which are logically the same as `db/models/status.rs:JobStatus` variant names. Intentional: `core` has zero internal deps so cannot reference `db` types. No action needed unless a 3rd mapping appears. |
| DRY-150 | `off_peak` policy_type magic string in `scheduling_repo.rs` SQL | PRD-08 | `watch` | `'off_peak'` string appears in `find_active_off_peak` query. 1 Rust consumer. Extract to `core/src/scheduling.rs` constant at 2nd consumer (e.g., scheduler engine). |
| DRY-154 | `FailureDiagnostics` (db model) vs `FailureDiagnosticData` (core) near-duplicate | PRD-28 | `watch` | Both structs have same 9 fields; differ in `stage_index` type (`i32` vs `u32`) and `timestamp` type (`Timestamp` vs `String`). Intentional layer separation (db types vs domain types). Merge if types ever align or a 3rd struct appears. |
| DRY-159 | `parse_timestamp` in audit handler vs `parse_from`/`parse_to` in performance handler | PRD-45, PRD-42 | `watch` | Both parse `Option<String>` to `chrono::DateTime<Utc>` with fallback. 2 consumers. Extract to shared `api/src/util.rs` at 3rd consumer (DRY-134 escalated). |
| DRY-160 | Debounce timer pattern (useRef+setTimeout) in persistence hooks | PRD-04, PRD-30, PRD-32, PRD-51, PRD-52 | `flagged` | Now 6 consumers: `useThemePersistence`, `useLayoutPersistence`, `useProficiencyTracker`, `useAutoSave`, `TagInput`, `use-entity-undo.ts`. DRY-112 threshold exceeded. Extract `useDebouncedCallback(callback, delayMs)` hook to `src/hooks/`. |
| DRY-171 | Raw `fetch` with `localStorage.getItem("access_token")` bypassing shared `api` client | PRD-66, PRD-16 | `flagged` | `use-metadata-editor.ts` (lines 120, 151) manually reads auth token from localStorage for CSV export/import `fetch` calls. `use-importer.ts` (line 74) uses raw `fetch` with NO auth header at all (potential bug). Shared `api.ts` client already handles auth via `useAuthStore`. These should use `api.post()`/`api.get()` or at minimum import from `useAuthStore` instead of reading localStorage directly. 3 instances across 2 files. |
| DRY-172 | `formatValue()` in `CsvImport.tsx` and `formatCellValue()` in `MetadataSpreadsheet.tsx` | PRD-66 | `watch` | Both functions handle null/undefined/boolean/array/object -> string formatting. `CsvImport.tsx:222-226` and `MetadataSpreadsheet.tsx:301-305` have near-identical logic with minor presentation differences (CsvImport uses `JSON.stringify` for objects, Spreadsheet returns `[Array]`/`[Object]`). 2 consumers in same feature. Extract shared `formatMetadataValue()` to `features/metadata-editor/utils.ts` if a 3rd display context appears. |
| DRY-228 | `statusBadgeVariant()` duplicated in `NoteTimeline.tsx` and `ReviewThread.tsx` | PRD-38 | `resolved` | Identical function mapping note status to Badge variant string ("success"/"warning"/"default") duplicated in both components. Extracted to `features/review-notes/types.ts` alongside existing `noteStatusLabel()`/`noteStatusColor()`. Both consumers now import. |
| DRY-229 | Card panel styling repeated 5x in debugger feature | PRD-34 | `resolved` | Identical 4-class `cn()` block (`bg-surface-primary`, `border-default`, `rounded-lg`, `p-4`) appeared in `JobControls.tsx`, `MidRunParamEditor.tsx`, `LatentPreview.tsx` (2x), `AbortDialog.tsx`. Extracted `DEBUGGER_CARD_CLASSES` array constant to `features/debugger/types.ts`. All 4 component files updated. |
| DRY-230 | Textarea styling duplicated in `MidRunParamEditor.tsx` and `AbortDialog.tsx` | PRD-34 | `resolved` | Identical 8-class textarea `cn()` block (`bg-surface-secondary`, `border-default`, `rounded-md`, `px-3 py-2`, `text-sm`, `text-primary`, `placeholder-muted`, `focus-ring`) duplicated in both components. Extracted `DEBUGGER_TEXTAREA_BASE` array constant to `features/debugger/types.ts`. Both consumers now spread it with `...DEBUGGER_TEXTAREA_BASE`. |
| DRY-234 | `review_note_repo.rs` repeats `rn.` column prefix in cross-table queries | PRD-38 | `watch` | `NOTE_COLUMNS` uses unprefixed column names but cross-table queries with tag joins need `rn.` prefix. Handler writes `rn.id, rn.segment_id, ...` inline instead of using `NOTE_COLUMNS`. 2 query sites. Acceptable: prefixed columns needed for disambiguated JOINs, and creating a second `PREFIXED_NOTE_COLUMNS` constant adds minimal value. |
| DRY-235 | `AbortDialog.tsx` hand-rolls modal overlay instead of `Modal` composite | PRD-34 | `watch` | Custom `fixed inset-0 z-50 bg-black/50` overlay with manual `role="dialog" aria-modal`. Missing Escape key handling, focus trapping. Same pattern as DRY-186 (RejectionDialog). 3rd consumer of hand-rolled modal overlay. Design system `Modal` or `ConfirmDialog` component candidate. Related to DRY-022, DRY-161. |
| DRY-236 | `CommandPalette.tsx` hand-rolls overlay with portal | PRD-31 | `watch` | Custom `fixed inset-0 z-50 bg-black/25` overlay rendered via `createPortal`. Includes Escape handling and click-outside via custom keyboard hook. 4th consumer of hand-rolled overlay. Same pattern as DRY-186/DRY-235. Specialized behavior (command palette UX) may not fit standard `Modal` component. |
| DRY-173 | Inline `new Date().toLocaleString()` instead of `formatDateTime` from `@/lib/format.ts` | PRD-13 | `watch` | `StalenessIndicator.tsx:58` uses `new Date(generatedAt).toLocaleString()` instead of the shared `formatDateTime()` utility. 1 consumer. Fix when file is next touched. |
| DRY-177 | Import status constants overlap between `importer.rs` and `import_status.rs` | PRD-16, PRD-14 | `watch` | `core/src/importer.rs` defines `SESSION_STATUS_UPLOADING/MAPPING/PREVIEWING/COMMITTED/CANCELLED/FAILED` while `core/src/import_status.rs` defines `IMPORT_STATUS_PREVIEW/COMMITTED/PARTIAL/FAILED/CANCELLED`. Different lifecycle stages (session vs import batch) but conceptually related. Watch for confusion. No action needed unless a handler needs both sets. |
| DRY-178 | `PhysicalAttributes` struct in `metadata_editor.rs` vs field definitions | PRD-66, PRD-13 | `watch` | `core/src/metadata_editor.rs` defines `PhysicalAttributes` struct with typed fields and also has `FIELD_DEFINITIONS` array describing the same fields as metadata. Intentional dual representation (typed struct for validation vs field defs for dynamic UI). Watch for divergence if fields are added to one but not the other. |
| DRY-181 | Identical `onSuccess` invalidation in 3 review mutation hooks | PRD-35 | `flagged` | `useApproveSegment`, `useRejectSegment`, `useFlagSegment` in `use-review.ts` have identical `onSuccess` callbacks (invalidate approvals + all review keys) and same `mutationFn` shape `({ segmentId, input }) => api.post(...)`. Extract `useDecisionMutation<TInput>(endpoint)` factory. ~40 lines of duplication. |
| DRY-185 | Magic timing thresholds 1000/5000 in `WorkflowCanvas.tsx` duplicate backend constants | PRD-33 | `flagged` | Inline `executionMs < 1000 ? green : < 5000 ? yellow : red` duplicates `TIMING_FAST_MS`/`TIMING_MODERATE_MS` from `core/src/workflow_canvas.rs`. Extract frontend constants to `types.ts` with sync comment + `timingColorClass()` utility. |
| DRY-186 | `RejectionDialog.tsx` hand-rolls modal overlay instead of `Modal` composite | PRD-35 | `flagged` | Custom `fixed inset-0 z-50 bg-black/50` overlay with manual positioning, missing keyboard handling (Escape), focus trapping. Shared `Modal` component at `@/components/composite/Modal` used by 11+ components. Refactor to use `<Modal>`. |
| DRY-187 | Inline loading spinner in `WorkflowCanvas.tsx` instead of `Spinner` primitive | PRD-33 | `flagged` | `animate-spin rounded-full border-2 border-current border-t-transparent` hand-rolled spinner. Shared `Spinner` component at `@/components/primitives/Spinner` used by 30+ components. Replace with `<Spinner />` import. |
| DRY-188 | Inline `toLocaleDateString()` in `BugReportList.tsx` instead of `formatDate` | PRD-44 | `flagged` | `new Date(report.created_at).toLocaleDateString()` at line 115. Shared `formatDate(iso)` exists in `@/lib/format.ts`. Same violation as DRY-157 and DRY-173. Replace with `formatDate(report.created_at)`. |
| DRY-200 | TourEngine overlay lacks Escape key handler and focus trapping | PRD-53 | `watch` | `TourEngine.tsx` hand-rolls `fixed inset-0 z-50` overlay without keyboard handling (Escape key) or focus trapping, unlike shared `Modal` composite. Tour has specialized behavior (spotlight, step navigation) making `Modal` a poor fit. Add Escape handler when interactive features mature. |
| DRY-210 | Local `formatDate()` in `WorkerDetailPanel.tsx` instead of shared `formatDateTime` | PRD-46 | `resolved` | Custom `formatDate(iso)` function returning `new Date(iso).toLocaleString()` -- behavioral duplicate of `formatDateTime()` from `@/lib/format.ts`. Replaced with `formatDateOrDash()` wrapper using shared `formatDateTime` import. |
| DRY-211 | Inline `BadgeVariant` union type in `workers/types.ts` | PRD-46 | `resolved` | `"success" \| "warning" \| "danger" \| "default"` inline union type in `WORKER_STATUS_VARIANT` Record instead of importing `BadgeVariant` from `@/components/primitives/Badge`. Replaced with import. Also added `WORKER_STATUS` named constants object to eliminate magic status_id numbers in the same file. |
| DRY-214 | Inline SVG close icon in `LowConfidenceWarning.tsx` | PRD-76 | `resolved` | Hand-coded 7-line `<svg>` element for close/dismiss button. Replaced with `<X size={16} />` from `@/tokens/icons`. Same pattern as DRY-105 (TagChip inline SVG). |
| DRY-217 | Magic number `4` for draining status in `WorkerDetailPanel.tsx` | PRD-46 | `resolved` | Hardcoded `worker.status_id !== 4` in conditional rendering. Replaced with `worker.status_id !== WORKER_STATUS.DRAINING` using named constant from `workers/types.ts`. |
| DRY-269 | `badgeVariant` mapping functions proliferating across frontend features | PRD-57, PRD-25, PRD-26, PRD-38, PRD-49, PRD-46, PRD-76 | `watch` | Seven feature modules define their own `*BadgeVariant()` mapper functions: `cellStatusVariant` (production/types.ts), `qualityBadgeVariant` (restitching/types.ts), `driftBadgeVariant` (temporal/types.ts), `grainBadgeVariant` (temporal/types.ts), `statusBadgeVariant` (quality-gates/types.ts), `statusBadgeVariant` (review-notes/types.ts), `embeddingBadgeVariant` (embedding/types.ts). All map domain enum to `BadgeVariant` union. Extract generic `createBadgeVariantMapper<T>(mapping: Record<T, BadgeVariant>)` factory to `@/components/primitives/Badge.tsx` if pattern reaches 10 consumers. |
| DRY-270 | SSIM threshold constants duplicated cross-boundary (Rust and TypeScript) | PRD-25 | `watch` | `DEFAULT_SSIM_THRESHOLD = 0.85` and `SSIM_WARNING_THRESHOLD = 0.92` manually duplicated between `core/src/restitching.rs` and `features/restitching/types.ts`. Same cross-boundary pattern as DRY-114/DRY-207. Different runtimes. Sync comments added pointing to canonical Rust source. |
| DRY-271 | Temporal continuity threshold constants duplicated cross-boundary (Rust and TypeScript) | PRD-26 | `watch` | `DEFAULT_DRIFT_THRESHOLD`, `DEFAULT_GRAIN_THRESHOLD`, `DEFAULT_CENTERING_THRESHOLD` manually duplicated between `core/src/temporal_continuity.rs` and `features/temporal/types.ts`. Same cross-boundary pattern as DRY-270. Sync comments added pointing to canonical Rust source. |
| DRY-272 | `ensure_run_exists` helper pattern correctly applied in `production_run.rs` | PRD-57 | `resolved` | Handler extracted `ensure_run_exists(pool, run_id)` helper following established DRY-097/DRY-121 pattern. No duplication. |
| DRY-273 | `qualityColor` function at 2 consumers in restitching feature | PRD-25 | `watch` | `qualityColor()` in `restitching/types.ts` maps boundary quality to Tailwind color classes. 1 consumer (BoundaryQualityIndicator.tsx). 2nd usage would justify extraction to shared design utilities. Acceptable for now. |
| DRY-274 | Fully-qualified `CoreError::NotFound` in `resolution.rs` handler | PRD-59 | `resolved` | Used 5x without import. Added `use CoreError;`, extracted `ensure_scene_exists` and `ensure_tier_exists` helpers. |
| DRY-275 | Redundant `.map_err(AppError::Core)?` in resolution.rs and estimation.rs | PRD-59, PRD-61 | `resolved` | `AppError` has `#[from] CoreError`, so plain `?` auto-converts. Replaced 5 instances. |
| DRY-276 | `PaginationQuery` struct duplicated across 16+ handler files | PRD-58, PRD-61, PRD-63, PRD-75, PRD-77 | `watch` | `VersionListParams` (PRD-63), `ListVersionsParams` (PRD-75), `PaginationParams` (PRD-77) are 3 new additions. Many have extra domain-specific fields (`project_id`, `scene_type_id`, etc.). Extract generic `PaginationParams` to `api/src/response.rs` when pattern reaches 20+. |
| DRY-277 | `validate_batch_size` / `validate_estimate_count` structural duplicates | PRD-58, PRD-61 | `resolved` | Extracted `validate_count_range(count, max, label)` to `core/src/threshold_validation.rs`. Both callers delegate. |
| DRY-278 | `confidenceBadgeVariant` returned inline union type | PRD-61 | `resolved` | Changed to return `BadgeVariant` imported from primitives for type consistency. |
| DRY-279 | `TestShotButton.tsx` hand-rolled modal overlay (5th consumer) | PRD-58 | `resolved` | Replaced with `Modal` from `@/components/composite`. |
| DRY-280 | Magic `3600` and `1024` in `EstimationCard.tsx` | PRD-61 | `resolved` | Added `SECS_PER_HOUR` / `MB_PER_GB` constants with sync comments pointing to canonical `core/src/estimation.rs`. |
| DRY-281 | `list_by_scene_type`/`list_by_character` structural similarity in test_shot_repo | PRD-58 | `watch` | 2 consumers, differ only in WHERE column. Extract generic `list_by_fk(column)` at 3rd consumer. |
| DRY-282 | Badge variant mapper count at 15 features | PRD-58, PRD-59, PRD-61, PRD-75, PRD-77, PRD-70, PRD-95 | `watch` | +2 new in Phase 7 remainder: `annotationStatusVariant` (PRD-70, annotations), `categoryBadgeVariant` (PRD-95, production-notes). Now 15 total. Domain-specific by design. Approaching extraction threshold. See DRY-302, DRY-308, DRY-319. |
| DRY-283 | `frameToTimecode(frame, fps)` duplicated in `TrimTimeline.tsx` | PRD-78 | `resolved` | Exact duplicate of `frameToTimecode()` from `features/video-player/frame-utils.ts`. Same algorithm (frame -> HH:MM:SS:FF). Removed local copy, replaced with import from shared module. |
| DRY-284 | `clamp(value, min, max)` duplicated in `TrimTimeline.tsx` and `usePanelResize.ts` | PRD-78, PRD-30 | `watch` | Identical 1-line `Math.max(min, Math.min(max, value))` function at 2 consumers. Extract to `@/lib/math-utils.ts` at 3rd consumer. |
| DRY-285 | Inline `toLocaleDateString()` in `VersionHistory.tsx` instead of `formatDate` | PRD-69 | `resolved` | Used inline `new Date(entry.created_at).toLocaleDateString(undefined, { year, month, day })` which is behaviorally identical to `formatDate()` from `@/lib/format.ts`. Replaced with `formatDate` import. Same violation pattern as DRY-157/DRY-173/DRY-188/DRY-223. |
| DRY-286 | `StoryboardParams` pagination struct in storyboard handler duplicates `PaginationQuery` | PRD-62 | `watch` | `StoryboardParams { limit: Option<i64>, offset: Option<i64> }` is structurally identical to `PaginationQuery` in estimation.rs. Extends DRY-276. Now 13+ handler files with identical pagination struct. |
| DRY-287 | `count_for_segment` method structurally duplicated across 3 repos | PRD-62, PRD-69, PRD-78 | `watch` | `KeyframeRepo::count_for_segment`, `GenerationReceiptRepo::count_for_segment`, `SegmentTrimRepo::count_for_segment` are structurally identical (differ only in table name). Same `SELECT COUNT(*) FROM {table} WHERE segment_id = $1` pattern. 3 consumers. Acceptable as thin-adapter repo methods. Watch if more segment-child tables appear. |
| DRY-288 | `formatTimecode(secs)` in storyboard types.ts is a distinct timecode format | PRD-62 | `watch` | `formatTimecode(secs) -> "MM:SS.f"` in `features/storyboard/types.ts` vs `frameToTimecode(frame, fps) -> "HH:MM:SS:FF"` in `features/video-player/frame-utils.ts`. Different input types and output formats (seconds-based with fractional vs frame-based SMPTE). NOT a duplicate -- different purpose. Watch if a 3rd timecode formatter appears; consider unifying under `@/lib/timecodes.ts`. |
| DRY-289 | `validate_receipt_inputs` has 4 sequential positive-value checks | PRD-69 | `watch` | `resolution_width`, `resolution_height`, `steps`, and `cfg_scale` each validated as `> 0` with near-identical code (4x same pattern). Could extract `validate_positive_i32(value, name)` or `validate_positive_f64(value, name)` to `core/src/threshold_validation.rs`. Currently 1 consumer. Extract at 2nd consumer (related to DRY-266 extraction pattern). |
| DRY-290 | Loading/error/empty state triptych repeated across 3 provenance components | PRD-69 | `watch` | `ReceiptPanel.tsx`, `StalenessReport.tsx`, `VersionHistory.tsx` all share identical loading (`Spinner` centered in p-6), error (danger text p-4), and empty state (muted text centered p-4) patterns. 3 consumers in same feature, ~15 lines per component. Extract `QueryStateWrapper<T>({ query, emptyMessage, children })` component if pattern reaches 5+ feature modules. |
| DRY-294 | Inline `new Date().toLocaleString()` in `VersionTimeline.tsx` and `ExecutionLogViewer.tsx` | PRD-63, PRD-77 | `resolved` | `VersionTimeline.tsx` (line 120) and `ExecutionLogViewer.tsx` (line 74) both used `new Date(x).toLocaleString()` instead of `formatDateTime()` from `@/lib/format.ts`. Replaced both with `formatDateTime` import. Same violation pattern as DRY-157/DRY-173/DRY-188/DRY-223/DRY-285. |
| DRY-295 | Cross-boundary constants (MAX_PROMPT_LENGTH, MAX_NEGATIVE_PROMPT_LENGTH, PLACEHOLDER_REGEX) without sync comments | PRD-63 | `resolved` | `features/prompt-editor/types.ts` mirrored 3 constants from `core/src/provenance.rs` and `core/src/prompt_editor.rs` without sync comments. Added JSDoc sync comments pointing to canonical Rust sources. Same cross-boundary pattern as DRY-114/DRY-207/DRY-270/DRY-271. |
| DRY-296 | Cross-boundary `TOKEN_ESTIMATE_MULTIPLIER` without sync comment | PRD-63 | `resolved` | `PromptEditor.tsx` (line 17) mirrored `TOKEN_ESTIMATE_MULTIPLIER = 1.3` from `core/src/prompt_editor.rs` without sync comment. Added JSDoc sync comment. Behavioral duplicate across runtimes is acceptable. |
| DRY-297 | Cross-boundary `WORKFLOW_STATUS` constants without sync comments | PRD-75 | `resolved` | `features/workflow-import/types.ts` mirrored `WORKFLOW_STATUS_ID_*` constants from `core/src/workflow_import.rs` without sync comments. Added JSDoc sync comment. Same pattern as DRY-295. |
| DRY-302 | Badge variant mappers: `workflowStatusVariant`, `failureModeVariant`, `hookTypeVariant` (3 new) | PRD-75, PRD-77 | `watch` | 3 new badge variant mapper functions in Phase 7 Track A: `workflowStatusVariant` (workflow-import/types.ts), `failureModeVariant` (pipeline-hooks/types.ts), `hookTypeVariant` (pipeline-hooks/types.ts). Extends DRY-269/DRY-282 count to 13 feature-level mappers total. All map domain enum to `BadgeVariant`. Domain-specific by design. Approaching extraction threshold. |
| DRY-316 | Shared `useAnnotationInvalidation` callback in annotation mutation hooks | PRD-70 | `resolved` | 3 mutation hooks (`useCreateAnnotation`, `useUpdateAnnotation`, `useDeleteAnnotation`) had identical `onSuccess` callbacks (invalidate bySegment + summary queries). Extracted `useAnnotationInvalidation(segmentId)` private hook returning shared callback. Same pattern as DRY-181 (review mutation hooks). |
| DRY-318 | Color swatch button pattern in `DrawingCanvas.tsx` and `TextLabel.tsx` | PRD-70 | `watch` | Both components render a palette of color swatch buttons with identical structure: `button` with `w-6 h-6 rounded-full border-2` + `ring-2 ring-offset-2` for active state. 2 consumers in same feature. Extract `ColorSwatchPicker` sub-component if a 3rd annotation component needs color selection. |
| DRY-319 | `categoryBadgeVariant` badge variant mapper in `NotesPanel.tsx` | PRD-95 | `watch` | Local `categoryBadgeVariant()` maps note category ("blocker"/"instruction"/"fyi"/"custom") to Badge variant. 15th consumer of badge variant mapper pattern. Extends DRY-269/DRY-282/DRY-302/DRY-308. Domain-specific by design. |
| DRY-303 | Placeholder parsing logic structurally similar in `PromptEditor.tsx` and `LivePreview.tsx` | PRD-63 | `watch` | Both components use same regex (`PLACEHOLDER_REGEX`) to split prompt text into segments for rendering with placeholder highlighting. `highlightPlaceholders()` in PromptEditor (lines 53-73) returns `{ text, isPlaceholder }[]`. `LivePreview` (lines 35-67) returns `{ type, text }[]` with 3 segment types (text/placeholder/resolved). Same split-on-regex pattern, different output shapes. 2 consumers in same feature. Acceptable divergence. |
| DRY-304 | `PaginationParams` struct duplicated across 4 handler files | PRD-74, PRD-43, PRD-10, PRD-77 | `resolved` | Identical `PaginationParams { limit: Option<i64>, offset: Option<i64> }` defined in `project_config.rs`, `integrity.rs`, `webhooks.rs`, `pipeline_hooks.rs`. Extracted to shared `api/src/query.rs`. All 4 consumers refactored to import. Extends DRY-276/DRY-004. |
| DRY-305 | `serde_json::json!` in `project_config_repo.rs` export function | PRD-74 | `watch` | `export_config` method in `project_config_repo.rs` uses `serde_json::json!` to build an export representation. This is data transformation in the repo layer (not an API response envelope), so it's a different use case from DRY-083. Watch for a typed `ExportConfigResponse` DTO if a 2nd consumer appears. |
| DRY-306 | Inline SQL `SELECT COUNT(*)` for segments duplicated 2x in `branching.rs` handler | PRD-50 | `resolved` | `compare_branches` handler had inline `SELECT COUNT(*) FROM segments WHERE branch_id = $1` executed twice with raw `sqlx::query_as`. Extracted to `BranchRepo::count_segments()` repository method. Both calls in handler replaced with repo method. |
| DRY-307 | `validate_config_name` vs `validate_branch_name` structurally similar | PRD-74, PRD-50 | `watch` | Both validate a name string: empty check + length check + regex pattern check. Different patterns and max lengths (config names vs branch names). 2 consumers. Same structural pattern as DRY-242 (`validate_template_name`/`validate_preset_name`). Extract generic `validate_entity_name(name, label, max_len, pattern)` at 3rd consumer. |
| DRY-308 | `effectivenessBadgeVariant` pattern in `PatternDetail.tsx` | PRD-64 | `watch` | Local `effectivenessBadgeVariant()` maps fix effectiveness ("effective"/"partial"/"ineffective") to Badge variant. Extends DRY-269/DRY-282 pattern (now 14 feature-level badge variant mappers). Domain-specific by design. |
| DRY-309 | Frontend `DiffStatus` types not shared between config-templates and branching | PRD-74, PRD-50 | `watch` | `config-templates/types.ts` defines `DiffStatus = "added" \| "changed" \| "unchanged"`. `branching/types.ts` defines `ParameterDiff.status = "added" \| "removed" \| "changed" \| "unchanged"`. Same concept with overlapping values. Backend unified to shared `core/src/diff.rs`. Frontend could share a `DiffStatus` union type from `@/lib/types.ts`. 2 consumers, extract at 3rd. |
| DRY-310 | Diff style/badge mapping structural similarity | PRD-74, PRD-50 | `watch` | `ConfigDiffView.tsx` has `DIFF_STATUS_COLORS` and `DIFF_STATUS_LABELS` maps. `BranchComparison.tsx` has `DIFF_STATUS_COLORS`, `DIFF_STATUS_LABELS`, and `DIFF_STATUS_BADGE_VARIANTS` maps. Same pattern, slightly different keys (branching has "removed"). 2 consumers. If a 3rd diff-display component appears, extract `DIFF_DISPLAY_CONFIG` to shared location. |
| DRY-311 | `validate_frame_number` duplicated in `annotation.rs` and `storyboard.rs` | PRD-70, PRD-62 | `resolved` | Exact copy-paste of `validate_frame_number(frame)` function (8 lines) from `core/src/storyboard.rs` into `core/src/annotation.rs`. Including duplicate unit tests. Resolved by removing duplicate, adding `pub use crate::storyboard::validate_frame_number;` re-export in annotation.rs. |
| DRY-312 | `validate_color_hex` in `annotation.rs` vs `validate_tag_color` in `review.rs` | PRD-70, PRD-38 | `watch` | Both validate hex color strings but with different constraints: `annotation::validate_color_hex` accepts `#RRGGBB` or `#RRGGBBAA` (6 or 8 hex digits after `#`), while `review::validate_tag_color` accepts only `#RRGGBB` (exactly 6). Different error types (`CoreError` vs `String`). 2 consumers. Extract shared `validate_hex_color(color, allow_alpha)` to `core/src/color.rs` at 3rd consumer. Cross-reference comment added to `annotation.rs`. |
| DRY-313 | Fully-qualified `CoreError::NotFound` in `production_notes.rs` handler | PRD-95 | `resolved` | 8 occurrences of `trulience_core::error::CoreError::NotFound` without import alias. Added `use trulience_core::error::CoreError;`, replaced all fully-qualified paths. Same violation as DRY-231/DRY-274. |
| DRY-314 | Hardcoded `"admin"` and `"reviewer"` role strings in `production_notes.rs` core | PRD-95 | `resolved` | `can_view_note()` used hardcoded `"admin"` and `"reviewer"` string literals instead of `ROLE_ADMIN`/`ROLE_REVIEWER` from `core/src/roles.rs`. Same violation as DRY-013/DRY-090/DRY-184. Added `use crate::roles::{ROLE_ADMIN, ROLE_REVIEWER};` import, replaced literals. |
| DRY-315 | `validate_entity_type` function at 3 core modules with different entity lists | PRD-95, PRD-51, PRD-31 | `watch` | `production_notes::validate_entity_type` (project/character/scene/segment/scene_type/workflow), `undo::validate_entity_type` (scene/segment/character/scene_type), and `command_palette::validate_entity_type` (similar). Same function signature, same validation pattern (`VALID_ENTITY_TYPES.contains()`), but genuinely different allowed entity lists. 3 consumers. Extract generic `validate_entity_type_in(value, valid_list, kind_label) -> Result<(), String>` at 4th consumer. Same structural pattern as DRY-098. |
| DRY-317 | Verbose `.map_err(\|e\| AppError::BadRequest(e))` in `production_notes.rs` handler | PRD-95 | `resolved` | 7 occurrences of `.map_err(\|e\| AppError::BadRequest(e))` instead of method reference `.map_err(AppError::BadRequest)`. Simplified all 7 to use method reference syntax. |
| DRY-320 | `DrawingToolType` enum boilerplate (as_str/from_str/Display/as_db) in `annotation.rs` | PRD-70 | `watch` | Same pattern as DRY-301 (`HookType`, `HookPoint`, `ScopeType`, `FailureMode` in `pipeline_hooks.rs`). 5th enum with identical boilerplate structure. 2 modules. Extract `impl_str_enum!` macro at 3rd module. |

### API & Data Fetching

| ID | Pattern / Component | PRDs Involved | Status | Notes |
|----|---------------------|---------------|--------|-------|
| DRY-040 | React Query / data fetching hooks | All frontend PRDs | `watch` | `useQuery`/`useMutation` patterns will repeat — establish hook conventions early |
| DRY-041 | WebSocket event subscription pattern | PRD-05, PRD-10, PRD-11 | `watch` | Real-time updates from event bus will be consumed by many components |
| DRY-042 | File upload handling | PRD-16, PRD-21, PRD-86 | `watch` | Multiple PRDs accept file uploads — shared upload component + backend handler |
| DRY-043 | CSV/report export pattern | PRD-22, PRD-73, PRD-94 | `watch` | Several PRDs export data as CSV — shared export utility |

### Pipeline & Generation

| ID | Pattern / Component | PRDs Involved | Status | Notes |
|----|---------------------|---------------|--------|-------|
| DRY-060 | FFmpeg command builder | PRD-24, PRD-25, PRD-39, PRD-83 | `resolved` | Implemented in `core/src/ffmpeg.rs`. PRD-24/25/39 will reuse `probe_video`, `extract_frame_thumbnail`, `extract_thumbnails_at_interval`. |
| DRY-091 | 10x `.map_err(\|e\| AppError::InternalError(e.to_string()))` in `handlers/video.rs` | PRD-83 | `watch` | Add `From<FfmpegError>` impl to `AppError` to eliminate 6 of 10. Watch for `From<io::Error>` as more file-serving handlers appear. |
| DRY-061 | Image quality scoring | PRD-22, PRD-49, PRD-76 | `watch` | First consumer (PRD-22) now live. `run_python_script` helper, `determine_status`, `compute_overall_status` in `api/src/handlers/image_qa.rs`. Python scripts in `scripts/python/qa/`. Shared runner in `qa/__init__.py`. When PRD-49/PRD-76 arrive, consider extracting `run_python_script` to a shared module. |
| DRY-070 | QA check type name strings across Rust + Python + SQL | PRD-22 | `watch` | Check type names (`"resolution"`, `"format"`, `"face_detection"`, etc.) appear in migration seed data, Rust handler constants (`CHECKS_*`), and Python script output keys. Currently 3 consumers. If a 4th consumer appears (e.g., frontend), extract to `core/src/qa_checks.rs`. |
| DRY-071 | Python QA script status classification pattern | PRD-22 | `watch` | `"pass" if X else ("warn" if Y else "fail")` ternary appears 7x across 3 scripts. Shared `classify_score()` in `qa/__init__.py` is available but scripts not yet refactored to use it (different threshold logic per check). Refactor when adding new QA scripts. |
| DRY-062 | ComfyUI workflow submission pattern | PRD-05, PRD-24, PRD-58 | `watch` | Workflow dispatch to ComfyUI will be called from multiple orchestrators |

---

## Resolved

| ID | Original Pattern | Resolution | Shared Location | Date |
|----|-----------------|------------|-----------------|------|
| DRY-012 | `resolve_role_name` duplicated in auth.rs + admin.rs | Extracted to `RoleRepo::resolve_name()` | `db/src/repositories/role_repo.rs` | 2026-02-20 |
| DRY-013 | Role magic strings hardcoded in rbac.rs | Created `ROLE_ADMIN/CREATOR/REVIEWER` constants | `core/src/roles.rs` | 2026-02-20 |
| DRY-019 | Channel name magic strings in router, digest, handlers | Created `CHANNEL_IN_APP/DIGEST/WEBHOOK/EMAIL` constants | `core/src/channels.rs` | 2026-02-20 |
| DRY-072 | QA status magic strings (`"pass"`, `"warn"`, `"fail"`) in Rust handler | Created `QA_PASS/QA_WARN/QA_FAIL` constants + Python `QA_PASS/QA_WARN/QA_FAIL` | `core/src/qa_status.rs`, `scripts/python/qa/__init__.py` | 2026-02-20 |
| DRY-073 | Python QA script `__main__` boilerplate (13 lines x 3 scripts) | Extracted `run_check_cli()` shared runner | `scripts/python/qa/__init__.py` | 2026-02-20 |
| DRY-075 | Import status magic strings + `status_id != 1` magic number | Created `IMPORT_STATUS_*` constants + `IMPORT_STATUS_PREVIEW_ID` | `core/src/import_status.rs` | 2026-02-20 |
| DRY-080 | `DataResponse<T>` typed response envelope local to `hardware.rs` | Extracted to shared `api/src/response.rs` module | `api/src/response.rs` | 2026-02-21 |
| DRY-084 | Script type name magic strings in orchestrator.rs | Created `SCRIPT_TYPE_SHELL/PYTHON/BINARY` constants | `core/src/script_types.rs` | 2026-02-21 |
| DRY-060 | FFmpeg command builder duplicated across PRDs | Shared `probe_video`, `extract_frame_thumbnail`, `extract_thumbnails_at_interval` | `core/src/ffmpeg.rs` | 2026-02-21 |
| DRY-087 | `AudioTrackInfo` struct duplicated in core + db | Removed duplicate from `db/models/video.rs`, re-export from `core::ffmpeg` | `core/src/ffmpeg.rs` | 2026-02-21 |
| DRY-088 | `"storage/thumbnails"` path literal duplicated 2x in handler | Extracted `THUMBNAIL_STORAGE_DIR` constant + `thumbnail_dir()` helper | `api/src/handlers/video.rs` | 2026-02-21 |
| DRY-089 | "Find first video stream" iteration pattern 5x in ffmpeg.rs | Extracted `first_video_stream()` private helper | `core/src/ffmpeg.rs` | 2026-02-21 |
| DRY-090 | `ADMIN_ROLE` constant redefined in jobs.rs (duplicate of `ROLE_ADMIN`) | Replaced local constant with import of `ROLE_ADMIN` from `core/src/roles.rs` | `core/src/roles.rs` (existing) | 2026-02-21 |
| DRY-092 | `list_by_user` / `list_all` structural duplicate in job_repo.rs | Extracted shared `list_jobs()` private method | `db/src/repositories/job_repo.rs` | 2026-02-21 |
| DRY-094 | Magic status_id numbers `1, 2` in dispatcher.rs SQL | Replaced with `JobStatus::Pending.id()` / `JobStatus::Running.id()` binds | `api/src/engine/dispatcher.rs` | 2026-02-21 |
| DRY-095 | Job WS message type magic strings in progress.rs | Created `MSG_TYPE_JOB_*` constants | `core/src/job_events.rs` | 2026-02-21 |
| DRY-096 | serde_json + Message::Text + broadcast repeated 4x | Extracted `broadcast_json()` helper | `api/src/engine/progress.rs` | 2026-02-21 |
| DRY-097 | Find + authorize ownership pattern 3x in jobs.rs | Extracted `find_and_authorize()` helper | `api/src/handlers/jobs.rs` | 2026-02-21 |
| DRY-099 | `TagSuggestion` structurally identical to `TagWithCount` | Unified to single `TagWithCount` type exported from `TagChip.tsx` | `src/components/domain/TagChip.tsx` | 2026-02-21 |
| DRY-101 | Inline `prefix.trim().to_lowercase()` in `suggest()` | Replaced with call to existing `normalize_tag_name()` | `db/src/repositories/tag_repo.rs` | 2026-02-21 |
| DRY-017 | Middleware/router construction duplicated in main.rs and tests | Extracted `build_app_router()` to `trulience_api::router` module | `api/src/router.rs` | 2026-02-21 |
| DRY-108 | `TokenEditor.tsx` 670-line god component with 7 section components + 6x duplicate updaters | Split sections to `token-editor/TokenSections.tsx`, replaced 6 updaters with generic `updateTokenSection<K>()` | `features/admin/token-editor/TokenSections.tsx` | 2026-02-21 |
| DRY-109 | `TagWithCount` redundantly re-exported from `TagInput.tsx` and `TagFilter.tsx` | Removed re-exports; canonical source is `TagChip.tsx` | `components/domain/TagChip.tsx` (existing) | 2026-02-21 |
| DRY-110 | `CATEGORY_LABELS` + `CATEGORY_ORDER` duplicated in CheatSheet + KeymapEditor | Extracted to `ShortcutRegistry.ts` with `groupBindingsByCategory()` utility | `features/shortcuts/ShortcutRegistry.ts` | 2026-02-21 |
| DRY-111 | `snapValue()` duplicated in `useSnapGrid.ts` + `usePanelResize.ts` | Exported from `useSnapGrid.ts`, imported in `usePanelResize.ts` | `features/layout/useSnapGrid.ts` | 2026-02-21 |
| DRY-116 | `export_keymap` handler duplicate JSON branches | Extracted shared destructuring with fallback defaults | `api/src/handlers/keymaps.rs` | 2026-02-21 |
| DRY-117 | `formatFileSize()` duplicated in AssetBrowser + AssetDetail | Removed duplicate, replaced with `formatBytes` from shared `@/lib/format.ts` | `src/lib/format.ts` (existing) | 2026-02-21 |
| DRY-118 | `formatDate()` inline helper in AssetDetail.tsx | Extracted to shared `formatDate()` in `@/lib/format.ts` | `src/lib/format.ts` | 2026-02-21 |
| DRY-119 | `serde_json::json!` (11x) in reclamation.rs instead of `DataResponse<T>` | Migrated all 11 endpoints to `DataResponse<T>` with `impl IntoResponse` return | `api/src/handlers/reclamation.rs` | 2026-02-21 |
| DRY-120 | Column list repeated 15x in reclamation_repo.rs | Extracted `RULE_COLUMNS`, `POLICY_COLUMNS`, `TRASH_COLUMNS`, `RUN_COLUMNS` constants | `db/src/repositories/reclamation_repo.rs` | 2026-02-21 |
| DRY-121 | `verify_exists + NotFound` guard 4x in assets.rs handler | Extracted `ensure_asset_exists(pool, id)` private helper | `api/src/handlers/assets.rs` | 2026-02-21 |
| DRY-102 | Click-outside pattern 3x (TagInput, Dropdown, JobTrayPanel) | Extracted `useClickOutside(ref, callback, enabled?)` hook | `src/hooks/useClickOutside.ts` | 2026-02-21 |
| DRY-127 | `formatTime()` duplicated in CinemaMode + GridControls | Removed locals, replaced with `formatDuration` from `video-player/frame-utils` | `features/video-player/frame-utils.ts` (existing) | 2026-02-21 |
| DRY-128 | Recharts Tooltip contentStyle 7x across 3 chart components | Extracted `TOOLTIP_CONTENT_STYLE`, `AXIS_TICK_STYLE`, `GRID_STROKE` | `features/dashboard/performance/chartStyles.ts` | 2026-02-21 |
| DRY-129 | `formatElapsed()` reimplements formatDuration logic | Refactored to delegate to shared `formatDuration(seconds*1000)` | `src/lib/format.ts` (existing) | 2026-02-21 |
| DRY-138 | `enable_extension`/`disable_extension` structural duplicate (22 identical lines) | Extracted shared `toggle_extension(state, id, user_id, enabled)` helper | `api/src/handlers/extensions.rs` | 2026-02-21 |
| DRY-139 | Textarea styling 9-line `cn()` block duplicated in SettingsEditor + InstallForm | Extracted `TEXTAREA_BASE_CLASSES` + `textareaBorderClass()` | `features/extensions/ExtensionManager.tsx` | 2026-02-21 |
| DRY-140 | Frontend `methodToAccess` mapped POST/PUT/DELETE to "create"/"update"/"delete" but backend `KNOWN_ACCESS_LEVELS` only defines `["read", "write"]` | Aligned frontend to use "write" for all mutating methods | `features/extensions/ExtensionApiBridge.ts` | 2026-02-21 |
| DRY-141 | `formatFileSize()` in `SourceImageUpload.tsx` duplicated `formatBytes()` from `@/lib/format.ts` | Removed local, replaced with `formatBytes` import | `src/lib/format.ts` (existing) | 2026-02-21 |
| DRY-142 | `formatDate()` local in `VariantHistory.tsx` duplicated `formatDateTime()` from `@/lib/format.ts` | Removed local, replaced with `formatDateTime` import | `src/lib/format.ts` (existing) | 2026-02-21 |
| DRY-143 | `"storage/variants"` path literal duplicated 2x in `image_variant.rs` handler | Extracted `VARIANT_STORAGE_DIR` constant + `ensure_variant_dir()` helper | `api/src/handlers/image_variant.rs` | 2026-02-21 |
| DRY-135 | `renderWithProviders` test helper duplicated across 6 test files | Extracted to shared `src/lib/test-utils.tsx`, all 6 consumers refactored | `src/lib/test-utils.tsx` | 2026-02-21 |
| DRY-145 | `image_variant.rs` handler used raw `Json<T>` instead of `DataResponse<T>` (10 endpoints) | Migrated all endpoints to `DataResponse<T>` with `impl IntoResponse` | `api/src/handlers/image_variant.rs` | 2026-02-21 |
| DRY-151 | `formatBytes()` duplicated in `checkpoints/types.ts` (behavioral duplicate of `@/lib/format.ts`) | Removed local, re-exported from `@/lib/format` | `src/lib/format.ts` (existing) | 2026-02-21 |
| DRY-152 | `find_and_authorize_job` in `checkpoints.rs` -- line-for-line copy of `find_and_authorize` in `jobs.rs` | Made `jobs::find_and_authorize` pub, imported in checkpoints.rs | `api/src/handlers/jobs.rs` (existing) | 2026-02-21 |
| DRY-153 | Raw `INSERT INTO jobs` SQL with inline COLUMNS in `checkpoints.rs` handler | Extracted `JobRepo::resume_from_checkpoint()` method, handler now delegates to repo | `db/src/repositories/job_repo.rs` | 2026-02-21 |
| DRY-155 | Query/count filter duplication (45+ identical lines) in `audit_repo.rs` | Extracted `build_audit_filter()` + `bind_audit_values()` shared helpers | `db/src/repositories/audit_repo.rs` | 2026-02-21 |
| DRY-156 | `serde_json::json!` in `checkpoints.rs` diagnostics + `audit.rs` query response | Replaced with typed `JobDiagnosticsResponse` struct and `AuditLogPage` struct | `api/src/handlers/checkpoints.rs`, `db/src/models/audit.rs` | 2026-02-21 |
| DRY-163 | SearchBar.tsx inline click-outside (addEventListener/removeEventListener) | Replaced with shared `useClickOutside` hook import | `src/hooks/useClickOutside.ts` (existing) | 2026-02-21 |
| DRY-164 | Duplicate search execution logic in `unified_search` + `execute_saved_search` | Extracted `run_search(pool, params)` private async helper | `api/src/handlers/search.rs` | 2026-02-21 |
| DRY-165 | Duplicate term sanitization in `build_tsquery` + `build_prefix_tsquery` | Extracted `sanitize_terms(query)` private helper | `core/src/search.rs` | 2026-02-21 |
| DRY-166 | Webhook handler inline pagination clamping (`unwrap_or(50).min(200)`) | Replaced with `clamp_limit`/`clamp_offset` from core | `core/src/search.rs` (existing) | 2026-02-21 |
| DRY-191 | `handleTourComplete` and `handleTourSkip` identical callbacks in `OnboardingGate.tsx` | Merged into single `handleTourEnd` callback | `features/onboarding/OnboardingGate.tsx` | 2026-02-21 |
| DRY-192 | `PLACEMENT_CLASSES` duplicated in `ContextualHint.tsx` (identical to Tooltip.tsx `POSITION_CLASSES`) | Exported `Placement` type and `PLACEMENT_CLASSES` from `Tooltip.tsx`, imported in ContextualHint | `components/primitives/Tooltip.tsx` | 2026-02-21 |
| DRY-193 | Placement union type `"top"\|"bottom"\|"left"\|"right"` repeated 4x in onboarding | Extracted shared `Placement` type from Tooltip, used in `types.ts`, `ContextualHint.tsx`, `hintDefinitions.ts` | `components/primitives/Tooltip.tsx`, `features/onboarding/types.ts` | 2026-02-21 |
| DRY-194 | Redundant `idx_user_onboarding_user_id` index duplicates unique index on same column | Removed redundant plain index (unique index provides same coverage) | `migrations/20260221000052_create_user_onboarding.sql` | 2026-02-21 |
| DRY-195 | Dismiss-button styling class repeated 3x across onboarding components | Extracted `DISMISS_LINK_CLASSES` constant to `types.ts`, used in TourEngine, OnboardingChecklist, ContextualHint | `features/onboarding/types.ts` | 2026-02-21 |
| DRY-196 | `HintDefinition` interface defined in `hintDefinitions.ts` instead of canonical `types.ts` | Moved type to `types.ts`, re-exported from `hintDefinitions.ts` | `features/onboarding/types.ts` | 2026-02-21 |
| DRY-197 | `validate_checklist_item`/`validate_feature_key` structurally identical validation patterns | Extracted generic `validate_known_key`/`validate_known_keys` private helpers | `core/src/onboarding.rs` | 2026-02-21 |
| DRY-198 | `get_or_create` used 2-query pattern (INSERT DO NOTHING + SELECT fallback) | Refactored to single-query `DO UPDATE SET user_id = user_onboarding.user_id` pattern (matches `workspace_repo.rs`) | `db/src/repositories/onboarding_repo.rs` | 2026-02-21 |
| DRY-219 | `formatBytes()` duplicated locally in `BackendConfigPanel.tsx` and `MigrationProgressView.tsx` | Removed both local copies, replaced with import from `@/lib/format.ts` | `src/lib/format.ts` (existing) | 2026-02-22 |
| DRY-220 | `StorageBackendStatus` and `StorageMigrationStatus` enums duplicated in `core/src/storage.rs` | Removed dead code from core (canonical source is `db/src/models/status.rs` via `define_status_enum!` macro). Added sync comment. | `db/src/models/status.rs` (existing) | 2026-02-22 |
| DRY-221 | 4x `.ok_or(NotFound{entity:"LibraryCharacter"})` inline in `library.rs` handler | Extracted `ensure_library_character_exists(pool, id)` private helper (DRY-097/DRY-121 pattern) | `api/src/handlers/library.rs` | 2026-02-22 |
| DRY-222 | 3x `.ok_or(NotFound{entity:"StorageMigration"})` inline in `storage.rs` handler | Extracted `ensure_migration_exists(pool, id)` private helper (DRY-097/DRY-121 pattern) | `api/src/handlers/storage.rs` | 2026-02-22 |
| DRY-223 | Inline `toLocaleDateString()` in `LibraryUsagePanel.tsx` instead of `formatDate` | Replaced with `formatDate` import from `@/lib/format.ts` | `src/lib/format.ts` (existing) | 2026-02-22 |
| DRY-224 | Inline `toLocaleString()` in `MigrationProgressView.tsx` and `StatePreview.tsx` | Replaced with `formatDateTime` import from `@/lib/format.ts`. StatePreview converts epoch ms to ISO string before passing. | `src/lib/format.ts` (existing) | 2026-02-22 |
| DRY-227 | `ensure_segment_exists` duplicated in `approval.rs` and `review_notes.rs` | Extracted to public function in `segment.rs`, imported by both handlers. Also resolves DRY-180. | `api/src/handlers/segment.rs` | 2026-02-22 |
| DRY-228 | `statusBadgeVariant()` duplicated in `NoteTimeline.tsx` and `ReviewThread.tsx` | Extracted to `review-notes/types.ts`, both consumers import | `features/review-notes/types.ts` | 2026-02-22 |
| DRY-229 | Card panel styling repeated 5x in debugger feature | Extracted `DEBUGGER_CARD_CLASSES` to `debugger/types.ts`, all 4 component files updated | `features/debugger/types.ts` | 2026-02-22 |
| DRY-230 | Textarea styling duplicated in 2 debugger components | Extracted `DEBUGGER_TEXTAREA_BASE` to `debugger/types.ts`, both consumers updated | `features/debugger/types.ts` | 2026-02-22 |
| DRY-231 | Fully-qualified `CoreError::NotFound` in `review_notes.rs` and `approval.rs` | Added `use CoreError` import, replaced fully-qualified paths | `api/src/handlers/review_notes.rs`, `api/src/handlers/approval.rs` | 2026-02-22 |
| DRY-246 | `formatFileSize()` local in `ExportHistory.tsx` duplicated `formatBytes()` from `@/lib/format.ts` | Removed local, replaced with `formatBytes` import | `src/lib/format.ts` (existing) | 2026-02-22 |
| DRY-247 | `formatDate()` local in `ExportHistory.tsx` duplicated `formatDateTime()` from `@/lib/format.ts` | Removed local, replaced with `formatDateTime` import | `src/lib/format.ts` (existing) | 2026-02-22 |
| DRY-248 | Inline pagination clamping in `delivery.rs` handler (`unwrap_or(50).min(200)`) | Replaced with `clamp_limit`/`clamp_offset` from `core/src/search.rs`. Aligned types to i64. | `core/src/search.rs` (existing) | 2026-02-22 |
| DRY-249 | Magic `status_id` numbers 6 and 7 in `delivery_export_repo.rs` SQL | Added `EXPORT_STATUS_ID_COMPLETED`/`EXPORT_STATUS_ID_FAILED` constants to `core/src/assembly.rs`, imported in repo | `core/src/assembly.rs`, `db/src/repositories/delivery_export_repo.rs` | 2026-02-22 |
| DRY-250 | Dead code `QaScoreSummary` in `db/src/models/quality_score.rs` -- identical to `core::quality_gate::QaSummary` | Removed unused struct, added reference comment pointing to canonical `core::quality_gate::QaSummary` | `core/src/quality_gate.rs` (existing) | 2026-02-22 |
| DRY-251 | Inline pagination in `integrity.rs` handler -- local `MAX_LIMIT`/`DEFAULT_LIMIT` instead of `clamp_limit`/`clamp_offset` | Removed local constants, replaced with `clamp_limit`/`clamp_offset` from `core/src/search.rs` | `core/src/search.rs` (existing) | 2026-02-23 |
| DRY-252 | Inline pagination in `duplicates.rs` handler -- no max clamping at all | Replaced with `clamp_limit`/`clamp_offset` from `core/src/search.rs` | `core/src/search.rs` (existing) | 2026-02-23 |
| DRY-253 | Inline pagination in `downloads.rs` handler -- wrong max (200 instead of 100) | Replaced with `clamp_limit`/`clamp_offset` from `core/src/search.rs` | `core/src/search.rs` (existing) | 2026-02-23 |
| DRY-254 | Magic `status_id` numbers 6 and 7 in `model_download_repo.rs` SQL (`mark_completed`, `mark_failed`, `check_duplicate_hash`) | Parameterized SQL, bound `DownloadStatus::Completed.id()` and `DownloadStatus::Failed.id()` | `db/src/models/status.rs` (existing) | 2026-02-23 |
| DRY-255 | Magic `status_id = 2` in `duplicate_check_repo.rs` `list_pending` SQL | Parameterized SQL, bound `duplicate_detection::STATUS_MATCH_FOUND_ID` | `core/src/duplicate_detection.rs` (existing) | 2026-02-23 |
| DRY-256 | Inline byte formatting in `ModelChecksumManager.tsx` (`/ (1024*1024*1024)).toFixed(2) GB`) | Replaced with `formatBytes()` from `@/lib/format.ts` | `src/lib/format.ts` (existing) | 2026-02-23 |
| DRY-257 | Inline `toLocaleString()` in `ScanHistory.tsx` instead of `formatDateTime` | Replaced with `formatDateTime` from `@/lib/format.ts` | `src/lib/format.ts` (existing) | 2026-02-23 |
| DRY-258 | `serde_json::json!` in `get_worker_report` integrity handler | Created typed `WorkerReportResponse` struct, handler returns `DataResponse<Option<WorkerReportResponse>>` | `api/src/handlers/integrity.rs` | 2026-02-23 |
| DRY-259 | 3 repair handlers (`repair_worker`, `sync_models`, `install_nodes`) structurally identical | Extracted shared `trigger_scan(state, auth, worker_id, scan_type)` helper, all 5 scan endpoints use it | `api/src/handlers/integrity.rs` | 2026-02-23 |
| DRY-260 | `start_scan` and `start_worker_scan` near-identical (differ only in worker_id source) | Both now delegate to shared `trigger_scan` helper (DRY-259) | `api/src/handlers/integrity.rs` | 2026-02-23 |

| DRY-261 | `generateSlug` local in `WikiArticleEditor.tsx` duplicated slug generation logic | Extracted to `@/lib/format.ts` as shared `generateSlug()` with sync comment noting backend canonical version in `core/src/wiki.rs` | `src/lib/format.ts` | 2026-02-23 |
| DRY-262 | `DEFAULT_SIMILARITY_THRESHOLD` name collision between `search.rs` (0.5) and `duplicate_detection.rs` (0.90) | Renamed to domain-specific: `DEFAULT_SEARCH_SIMILARITY` (search.rs) and `DEFAULT_DUPLICATE_SIMILARITY` (duplicate_detection.rs). Updated consumer in `search_repo.rs` | `core/src/search.rs`, `core/src/duplicate_detection.rs` | 2026-02-23 |
| DRY-263 | `formatSpeed`/`estimateEta` local helpers in `DownloadItem.tsx` | Extracted to `@/lib/format.ts` as shared `formatSpeed()` and `estimateEta()`. `DownloadItem.tsx` now imports from shared. | `src/lib/format.ts` | 2026-02-23 |
| DRY-264 | `serde_json::json!` in 3 production_run handler endpoints | Created `SubmitCellsResponse`, `ResubmitResponse`, `DeliverResponse` typed structs. All 3 endpoints now use `DataResponse<T>`. | `db/src/models/production_run.rs` | 2026-02-23 |
| DRY-265 | Magic `status_id` numbers in production_run repo and handler | Parameterized SQL and replaced all magic numbers with `RUN_STATUS_ID_*` constants from `core/src/batch_production.rs`. | `core/src/batch_production.rs` | 2026-02-23 |
| DRY-266 | `validate_unit_range` pattern duplicated 5x across core modules | Extracted `validate_unit_range(value, name)` to `core/src/threshold_validation.rs`. 5 consumers refactored to delegate. | `core/src/threshold_validation.rs` | 2026-02-23 |
| DRY-274 | Fully-qualified `CoreError::NotFound` in resolution.rs handler | Added import, extracted `ensure_scene_exists` and `ensure_tier_exists` helpers. | `api/src/handlers/resolution.rs` | 2026-02-23 |
| DRY-275 | Redundant `.map_err(AppError::Core)?` in resolution.rs/estimation.rs | Replaced 5 instances with plain `?` (AppError has `#[from] CoreError`). | `api/src/handlers/resolution.rs`, `estimation.rs` | 2026-02-23 |
| DRY-277 | `validate_batch_size`/`validate_estimate_count` structural duplicates | Extracted `validate_count_range(count, max, label)` to shared threshold_validation.rs. | `core/src/threshold_validation.rs` | 2026-02-23 |
| DRY-278 | `confidenceBadgeVariant` inline union return type | Changed to `BadgeVariant` import from primitives. | `features/estimation/types.ts` | 2026-02-23 |
| DRY-279 | `TestShotButton.tsx` hand-rolled modal overlay | Replaced with `Modal` from `@/components/composite`. | `features/test-shots/TestShotButton.tsx` | 2026-02-23 |
| DRY-280 | Magic `3600`/`1024` in EstimationCard.tsx | Added `SECS_PER_HOUR`/`MB_PER_GB` constants with sync comments to canonical Rust source. | `features/estimation/EstimationCard.tsx` | 2026-02-23 |
| DRY-283 | `frameToTimecode(frame, fps)` exact duplicate in `TrimTimeline.tsx` | Removed local 8-line copy, replaced with import from `@/features/video-player/frame-utils.ts`. | `features/video-player/frame-utils.ts` (existing) | 2026-02-23 |
| DRY-285 | Inline `toLocaleDateString()` in `VersionHistory.tsx` | Replaced with `formatDate(entry.created_at)` from `@/lib/format.ts`. Same pattern as DRY-157/DRY-173/DRY-188/DRY-223. | `src/lib/format.ts` (existing) | 2026-02-23 |
| DRY-302/PaginationParams | `PaginationParams` struct duplicated in 4 handler files | Extracted to shared `api/src/query.rs` module. All 4 consumers (`project_config.rs`, `integrity.rs`, `webhooks.rs`, `pipeline_hooks.rs`) refactored to import. | `api/src/query.rs` | 2026-02-23 |
| DRY-303/DiffStatus | `DiffStatus` enum duplicated in `project_config.rs` and `branching.rs` | Created shared `DiffStatus` enum in `core/src/diff.rs` with 4 variants (Added, Removed, Changed, Unchanged). Both modules import. | `core/src/diff.rs` | 2026-02-23 |
| DRY-304/TrendPointResponse | `serde_json::json!` for trend response in `failure_analytics.rs` | Created typed `TrendPointResponse` DTO in `db/src/models/failure_pattern.rs`. Handler uses struct instead of JSON macro. | `db/src/models/failure_pattern.rs` | 2026-02-23 |
| DRY-306/BranchSegmentCount | Inline `SELECT COUNT(*)` for branch segments 2x in `branching.rs` handler | Added `BranchRepo::count_segments()` repository method. Handler calls repo method. | `db/src/repositories/branch_repo.rs` | 2026-02-23 |
| DRY-311 | `validate_frame_number` exact duplicate in `annotation.rs` (copy-paste from `storyboard.rs`) | Removed duplicate function + 4 duplicate tests. Added `pub use crate::storyboard::validate_frame_number;` re-export. | `core/src/annotation.rs` (re-export from `core/src/storyboard.rs`) | 2026-02-23 |
| DRY-313 | Fully-qualified `CoreError::NotFound` 8x in `production_notes.rs` handler | Added `use trulience_core::error::CoreError;` import, replaced all 8 fully-qualified paths. | `api/src/handlers/production_notes.rs` | 2026-02-23 |
| DRY-314 | Hardcoded `"admin"`/`"reviewer"` in `can_view_note()` instead of role constants | Added `use crate::roles::{ROLE_ADMIN, ROLE_REVIEWER};`, replaced 3 string literals. | `core/src/production_notes.rs` | 2026-02-23 |
| DRY-316 | Identical `onSuccess` invalidation in 3 annotation mutation hooks | Extracted `useAnnotationInvalidation(segmentId)` private hook returning shared callback. | `features/annotations/hooks/use-annotations.ts` | 2026-02-23 |
| DRY-317 | Verbose `.map_err(\|e\| AppError::BadRequest(e))` 7x in `production_notes.rs` handler | Simplified all 7 to method reference `.map_err(AppError::BadRequest)`. | `api/src/handlers/production_notes.rs` | 2026-02-23 |
| DRY-321 | 7x inline `find_by_id + NotFound` in `legacy_import.rs` handler without helper | Extracted `ensure_run_exists(pool, id)` private helper. All 7 handler functions refactored. | `api/src/handlers/legacy_import.rs` | 2026-02-23 |
| DRY-322 | Raw `params.limit`/`params.offset` without clamping in `list_runs`/`list_entity_logs` | Added `clamp_limit`/`clamp_offset` from `core/src/search.rs`. | `api/src/handlers/legacy_import.rs` | 2026-02-23 |
| DRY-323 | 6x verbose `.map_err(\|e\| AppError::BadRequest(e))` in `batch_metadata.rs` handler | Simplified all 6 to method reference `.map_err(AppError::BadRequest)`. | `api/src/handlers/batch_metadata.rs` | 2026-02-23 |
| DRY-324 | `serde_json::json!` for run report response in `legacy_import.rs` handler | Created typed `RunReportResponse`/`ActionCountEntry` DTOs in handler. Uses `DataResponse<T>`. | `api/src/handlers/legacy_import.rs` | 2026-02-23 |
| DRY-325 | `serde_json::json!` for readiness summary in `readiness.rs` handler | Replaced with existing `readiness::ReadinessSummary` typed struct from core. | `api/src/handlers/readiness.rs` | 2026-02-23 |

---

## DRY-GUY Audit Log

Record of every DRY-GUY audit run against the codebase.

| Date | PRD(s) Touched | Files Audited | Findings | Action Taken |
|------|---------------|---------------|----------|--------------|
| 2026-02-20 | Phase -1 scaffold | 33 (11 Rust, 14 Frontend, 8 Infra) | 6 (0 critical, 3 medium, 3 low) | Fixed CI DATABASE_URL dedup, vitest config merge, Storybook color comment. Watch: tracing init, Docker anchors. |
| 2026-02-20 | PRD-00 Database Normalization | 12 (2 Rust lib, 2 Rust test, 1 API, 4 SQL, 2 docs, 1 DRY-TRACKER) | 3 (0 critical, 1 medium, 2 low) | All acceptable/deferred. Medium: tracing init (2 binaries, extract at 3). Low: SQL filter clause in tests (readable as-is), lookup DDL repetition (mitigated by template migration 000003). No code changes needed. |
| 2026-02-20 | PRD-01 Phase 4 (API Endpoints) | 17 (8 handlers, 5 routes, 1 error, 1 lib, 1 test helper, 1 main) | 2 low, rest acceptable | No changes. NotFound construction (19x) and delete-if pattern (8x) are thin-adapter repetition. DRY-003 stays `watch`. scene_type.rs correctly deduplicates dual-scope via inner helpers. |
| 2026-02-20 | PRD-01 Test Files (entity_crud, entity_api, schema_conventions) | 8 test files across db+api crates | 2 HIGH (extracted), 1 MEDIUM (watch), 2 LOW (acceptable) | Extracted `body_json`, `post_json`, `put_json`, `get`, `delete`, `send_json` to `api/tests/common/mod.rs`. Unified `post_json`/`put_json` via `send_json` base. Refactored health.rs + entity_api.rs to use shared helpers. Watch: entity_crud.rs fixtures if second api test needs them. |
| 2026-02-20 | PRD-109 Phases 5-6 (Trash API + Delivery) | 12 (1 trash_repo, 5 entity repos modified, 1 trash handler, 1 trash route, 1 delivery.rs, 1 handlers/mod, 1 routes/mod, 1 repos/mod) | 1 HIGH (dead code), 2 MEDIUM (watch), 2 LOW, 4 CLEAN | HIGH: `find_by_id_include_deleted` on 5 individual repos is dead code (uncalled) — recommend removal. MEDIUM: DRY-009 confirmed (27 identical soft_delete/restore/hard_delete methods across 9 repos), DRY-011 added (5 parallel entity-type lists). LOW: fallback in `table_and_name_expr`, dispatch_restore inherent to architecture. CLEAN: delivery.rs, route file, handler pattern. |
| 2026-02-20 | PRD-03 Phases 1-6 (User Identity & RBAC) | 19 new + 9 modified (3 SQL migrations, 3 db models, 3 db repos, 3 auth modules, 2 middleware modules, 2 handler modules, 2 route modules, 1 config) | 2 flagged (DRY-012, DRY-013), 2 watch (DRY-014, DRY-015), 3 LOW, rest CLEAN | FLAGGED: `resolve_role_name` duplicated between auth.rs and admin.rs (DRY-012); role name magic strings in rbac.rs (DRY-013). WATCH: validate+hash pattern 2x in admin.rs (DRY-014), RBAC extractor boilerplate at 3 impls (DRY-015). LOW: `"Account is deactivated"` 2x in auth.rs (same file, different paths), `UserInfo` vs `UserResponse` (intentionally different scopes), `"unknown"` fallback (resolves with DRY-012). CLEAN: password.rs, jwt.rs, AuthUser extractor, all repos, all routes, all migrations, test config. |
| 2026-02-20 | PRD-05 (ComfyUI WebSocket Bridge) | 8 new + 6 modified (8 comfyui crate files, 2 db model/repo files, 2 db repo files, 2 migration files, 2 Cargo.toml, 1 state.rs, 1 main.rs, 1 tests/common/mod.rs) | 1 FLAGGED (DRY-017), 1 MEDIUM fixed, 1 LOW fixed, 1 MEDIUM watch (DRY-016), 3 LOW acceptable, rest CLEAN | FIXED: `api.rs` internal duplication -- extracted `ensure_success()` helper to deduplicate `parse_response`/`check_status` (eliminated 7 duplicate lines). FIXED: `reqwest` and `tokio-util` not in workspace deps -- moved to `workspace.dependencies` with `workspace = true` in comfyui Cargo.toml. FLAGGED: DRY-017 middleware stack duplication between main.rs and tests/common/mod.rs (worsened by PRD-05 adding comfyui_manager). WATCH: DRY-016 find_by_prompt_id+event pattern (2x in processor.rs). LOW: UUID client_id generation 2x (different purposes), execution status SQL strings (encapsulated behind methods), instance status strings (migration-only). CLEAN: messages.rs, events.rs, reconnect.rs, client.rs, manager.rs structure, db models, db repos, migrations. |
| 2026-02-20 | PRD-10 (Event Bus & Notification System) | 22 files (8 events crate, 5 db models/repos, 4 api handlers/routes, 3 api notification module, 2 migrations) + 7 modified (state, main, test common, ws/manager, lib, routes/mod, handlers/mod) | 1 CRITICAL fixed, 3 HIGH (2 fixed, 1 worsened), 1 MEDIUM fixed, 2 LOW acceptable | FIXED (CRITICAL): `persistence.rs` duplicated `INSERT INTO events` SQL + `SELECT id FROM event_types` -- refactored to call `EventRepo::insert()` and `EventRepo::get_event_type_by_name()`, eliminating 18 lines of duplicate SQL. FIXED (HIGH): `digest.rs` duplicated "users due for digest" query with divergent SQL (hardcoded hourly/daily vs repo's `digest_interval::interval` cast) + raw SQL for marking notifications delivered + updating last-sent timestamp -- refactored to call `NotificationPreferenceRepo::list_users_due_for_digest()`, `NotificationRepo::pending_count_for_channel()`, `NotificationRepo::mark_channel_delivered()`, and `NotificationPreferenceRepo::mark_digest_sent()`. Added 2 new methods to NotificationRepo and 1 to NotificationPreferenceRepo. FIXED (MEDIUM): Channel name magic strings (`"in_app"`, `"digest"`) in 7 locations -- extracted to `core/src/channels.rs` constants (DRY-019 resolved). WORSENED: DRY-017 (middleware/router duplication) now includes `event_bus` in AppState. WATCH: DRY-018 added (broadcast recv loop pattern, 2 instances). LOW: `find_latest_event_id` called 2x in router.rs (internal, different paths), webhook retry vs comfyui reconnect (different purposes). CLEAN: bus.rs, delivery/mod.rs, email.rs, webhook.rs, all db models, all migrations, notification route, notification handler, WsManager.send_to_user. |
| 2026-02-20 | PRD-14 (Data Validation & Import Integrity) | 14 (3 SQL migrations, 5 core validation module files, 2 db repos, 2 db models, 1 handler, 1 route) + 3 modified (core lib.rs, handlers/mod.rs, routes/mod.rs) | 1 HIGH fixed, 2 MEDIUM (1 fixed, 1 watch), 1 LOW watch | FIXED (HIGH): Import status magic strings `"preview"`, `"committed"` and `status_id != 1` magic number in handler — extracted `IMPORT_STATUS_PREVIEW/COMMITTED/PARTIAL/FAILED/CANCELLED` and `IMPORT_STATUS_PREVIEW_ID` to `core/src/import_status.rs` (DRY-075, following DRY-013/DRY-019/DRY-072 pattern). FIXED (MEDIUM): Near-duplicate SQL in `validation_rule_repo.rs` — `load_rules` and `list_by_entity_type` differed only by `AND vr.is_active = true` — extracted shared `query_rules(active_only: bool)` private method. FIXED (MEDIUM): Fragile `ImportAction` serialization using `format!("{:?}", ...)` in handler — added `ImportAction::as_str()` returning stable serde-aligned strings. WATCH: DRY-074 (rule type name strings, 1 consumer), DRY-076 (source_type `"api"` literal, 1 consumer). CLEAN: evaluator.rs unit tests, conflict.rs logic, import_preview.rs types, all SQL migrations, integration test file, route registration. |
| 2026-02-20 | PRD-22 (Source Image Quality Assurance) | 16 (3 SQL migrations, 1 model, 3 repos, 1 handler, 1 route, 3 Python scripts, 1 Python __init__, 3 mod.rs) + cross-ref to core/src | 2 CRITICAL fixed, 1 HIGH fixed, 2 MEDIUM watch (DRY-070, DRY-071), 1 LOW acceptable | FIXED (CRITICAL BUG): Missing UNIQUE constraint on `(project_id, check_type_id)` in migration 000022 -- `ON CONFLICT` upsert would have failed at runtime. Added `COALESCE(project_id, 0)` expression index + matching upsert SQL. FIXED (CRITICAL BUG): Handler parsed Python output as bare array but scripts return `{"results": [...]}` dict -- would have failed with "Expected array". Updated to extract `"results"` key. FIXED (HIGH): QA status magic strings `"pass"/"warn"/"fail"` in 10 locations in `image_qa.rs` -- extracted `QA_PASS/QA_WARN/QA_FAIL` to `core/src/qa_status.rs`, following established pattern (DRY-013 roles, DRY-019 channels). Also added Python-side constants in `qa/__init__.py`. FIXED (HIGH): Python `__main__` boilerplate (13 lines x 3 scripts = 39 lines identical) -- extracted `run_check_cli()` to `qa/__init__.py`. WATCH: DRY-070 (check type name strings across 3 boundaries), DRY-071 (Python status classification ternary 7x). LOW: `list_by_character` vs `list_by_character_source` structural similarity (thin-adapter, acceptable). CLEAN: models, qa_check_type_repo, routes, mod.rs exports, migration 000020, migration 000021. |
| 2026-02-21 | PRD-06 (Hardware Monitoring) -- initial | 24 files (3 SQL migrations, 3 core modules, 1 core hardware submod, 1 core hardware/thresholds, 3 db repos, 1 db model, 1 api handler, 1 api route, 1 api background/mod, 1 api background/metrics_retention, 4 agent crate files, 1 api lib, 1 api response.rs new) + cross-ref to comfyui/reconnect.rs, db/image_qa_threshold_repo | 3 HIGH fixed, 1 FLAGGED (DRY-077), 4 WATCH (DRY-078, DRY-079, DRY-081), rest CLEAN | FIXED (HIGH): `UpdateWorkerThresholdsRequest` and `UpdateGlobalThresholdsRequest` were identical structs -- merged into single `UpdateThresholdsRequest`. FIXED (HIGH): `MetricThresholdRepo::update_global()` was a copy of `upsert()` with `worker_id=NULL` hardcoded (identical SQL, 14 duplicate lines) -- removed, handler now calls `upsert()` with `worker_id: None`. FIXED (HIGH): `DataResponse<T>` response envelope struct was local to `hardware.rs` -- extracted to shared `api/src/response.rs` (DRY-080). FIXED (MEDIUM): INSERT column list duplicated between `GpuMetricRepo::insert()` and `insert_batch()` -- extracted `INSERT_COLUMNS` constant. FIXED (MEDIUM): `"gpu_metrics"` WS message type string duplicated between agent `sender.rs` and API `hardware.rs` -- added `MSG_TYPE_GPU_METRICS` constant to `core/src/metric_names.rs`, API handler now uses it, agent has sync comment. FIXED (LOW): Missing `Default` impl for `MetricsCollector` (clippy warning). FLAGGED: DRY-077 -- tracing init now at 3 binaries (agent is 3rd), extraction threshold met. WATCH: DRY-078 (restart status_id magic numbers), DRY-079 (metric name strings SQL/Rust boundary), DRY-081 (agent vs ComfyUI reconnect strategies). CLEAN: collector.rs, restart.rs, thresholds.rs evaluator, alert.rs, all migrations, routes, background/metrics_retention. |
| 2026-02-21 | PRD-06 (Hardware Monitoring) -- re-audit | 29 PRD-06 files + 9 comparison files (notification.rs, validation.rs, digest.rs, main.rs, tests/common, StatusBadge.tsx, api.ts, worker/main.rs, ThumbnailCard.tsx) | 3 HIGH (2 fixed, 1 flag-only), 4 MEDIUM (1 fixed, 2 watch, 1 pre-existing), 2 LOW acceptable | FIXED (HIGH): Agent `sender.rs` used hardcoded `"gpu_metrics"` + `"restart_result"` strings instead of `MSG_TYPE_GPU_METRICS` constant -- added `trulience-core` dep to agent crate, imported constant, added new `MSG_TYPE_RESTART_RESULT` constant. FIXED (HIGH): `update_worker_thresholds` and `update_global_thresholds` were 19-line structural duplicates differing only in `worker_id` -- extracted shared `upsert_thresholds()` helper. FLAGGED (HIGH): DRY-083 -- `notification.rs` (7x) and `validation.rs` (7x) still use `serde_json::json!` instead of `DataResponse<T>`. FIXED (MEDIUM): WorkerCard.tsx missing `ease-[var(--ease-default)]` in transition class. WATCH: DRY-082 (`getCssVar` utility, 1 consumer). MEDIUM: Test threshold fixture duplication (acceptable -- test isolation). LOW: Power/fan display rows in WorkerCard (2 instances, same component), centering divs in MetricsChart (2 instances, same component). CLEAN: all repos, all migrations, routes, background tasks, all other frontend components. |
| 2026-02-21 | PRD-09 (Multi-Runtime Script Orchestrator) | 16 new + 2 migrations + 2 modified (main.rs, state.rs) + cross-ref to image_qa.rs, tests/common/mod.rs, response.rs | 1 HIGH fixed (DRY-084), 1 MEDIUM fixed (test helper), 2 WATCH (DRY-085, DRY-086), rest CLEAN | FIXED (HIGH): Script type name magic strings `"shell"`, `"python"`, `"binary"` in 4 locations in `orchestrator.rs` -- extracted `SCRIPT_TYPE_SHELL/PYTHON/BINARY` to `core/src/script_types.rs` (DRY-084, following DRY-013/DRY-019/DRY-072 pattern). FIXED (MEDIUM): `default_input()` test helper duplicated identically in `shell.rs` and `binary.rs` -- extracted to shared `scripting::test_helpers::default_input()` in `scripting/mod.rs`. WATCH: DRY-085 (QA handler `run_python_script` vs scripting subprocess -- behavioral duplicate, different interfaces prevent direct merge). WATCH: DRY-086 (`"VENV_DIR"` env var name literal in 2 files, 2 crates). CLEAN: executor.rs (well-factored trait + types), subprocess.rs (single `run_command`), python.rs (venv management), status.rs (numeric constants matching established pattern), all DB models, both repos (clean COLUMNS/JOIN pattern), all handlers (properly use `DataResponse<T>`), routes, migrations, orchestrator lifecycle logic, mod.rs exports. DRY-017 worsened (AppState now has `script_orchestrator` field requiring parallel update in tests/common). |
| 2026-02-21 | PRD-09 (Multi-Runtime Script Orchestrator) -- re-audit | 21 files (16 PRD-09 + cross-ref to auth_api.rs, hardware_api.rs, common/mod.rs, image_qa.rs, notification.rs) | 2 HIGH fixed, 1 MEDIUM fixed, 3 MEDIUM watch, rest CLEAN | FIXED (HIGH): `build_app_with_orchestrator()` in `script_api.rs` was 60-line copy of `build_test_app()` -- extracted `build_test_app_with()` to `common/mod.rs` with optional orchestrator parameter. Both `build_test_app()` and `build_test_app_with_orchestrator()` now delegate to single builder (DRY-017 partially resolved). FIXED (HIGH): `create_admin()` + `login()` test helpers duplicated across `script_api.rs`, `auth_api.rs`, `hardware_api.rs` (3 independent user creation helpers) -- extracted `create_test_user()`, `login_user()`, `login_for_token()` to `common/mod.rs`. `script_api.rs` refactored to use shared helpers. FIXED (MEDIUM): `scripts.rs` used fully-qualified `trulience_core::error::CoreError::NotFound` (4 locations) instead of imported alias used by all other handlers -- added `use trulience_core::error::CoreError;` import. WATCH: DRY-004 (2nd pagination query struct `ExecutionListQuery`), DRY-085 (QA run_python_script vs subprocess), DRY-086 (VENV_DIR string). |
| 2026-02-21 | PRD-83 (Video Playback Engine & Codec Support) | 27 files (7 backend new, 6 backend modified, 12 frontend new, 2 frontend tests) | 3 HIGH fixed, 2 MEDIUM (1 pre-existing DRY-083, 1 watch DRY-091), rest CLEAN | FIXED (HIGH): DRY-087 `AudioTrackInfo` struct duplicated in `core/src/ffmpeg.rs` and `db/src/models/video.rs` -- removed duplicate from db, re-export from core, eliminated 8-line field-by-field mapper in handler. FIXED (HIGH): DRY-088 `"storage/thumbnails"` path literal duplicated 2x in `handlers/video.rs` -- extracted `THUMBNAIL_STORAGE_DIR` constant + `thumbnail_dir()` helper. FIXED (MEDIUM): DRY-089 "find first video stream" iteration repeated 5x in `core/src/ffmpeg.rs` -- extracted `first_video_stream()` private helper. FIXED (LOW): Hardcoded `'segment' or 'version'` error message -- now uses `VALID_SOURCE_TYPES` constant. RESOLVED: DRY-060 (FFmpeg command builder) -- shared utility now lives in `core/src/ffmpeg.rs`. WORSENED: DRY-083 (DataResponse not used by `get_metadata` and `generate_thumbnails` -- 3rd handler module skipping envelope). WATCH: DRY-091 (10x `.map_err` in handler, add `From<FfmpegError>` when pattern reaches 4th handler). CLEAN: all frontend files (types, codec-detector, frame-utils, hooks, components, barrel export, tests), all repos, migration, routes, constants. |
| 2026-02-21 | PRD-07 (Parallel Task Execution Engine) | 14 files (8 new: migration, model, repo, engine/mod, dispatcher, progress, handler, route; 6 modified: db models/mod, db repos/mod, api lib, handlers/mod, routes/mod, comfyui manager) + cross-ref to core/roles.rs, notification.rs, scripts.rs, response.rs, metric_names.rs | 1 CRITICAL fixed, 2 HIGH fixed, 3 MEDIUM fixed, 1 MEDIUM watch (DRY-093), rest CLEAN | FIXED (CRITICAL DRY-090): `ADMIN_ROLE` constant redefined as `"admin"` in `jobs.rs` -- exact duplicate of `ROLE_ADMIN` from `core/src/roles.rs`. Replaced with import. FIXED (HIGH DRY-092): `list_by_user`/`list_all` in `job_repo.rs` were 30-line structural duplicates -- extracted shared `list_jobs(pool, user_id: Option, params)` private method with dynamic WHERE clause builder. FIXED (HIGH DRY-097): Ownership guard (find_by_id + NotFound + ownership check + Forbidden) repeated 3x in handlers -- extracted `find_and_authorize(pool, job_id, auth, action)` helper. FIXED (MEDIUM DRY-094): Magic status_id numbers `1, 2` in `dispatcher.rs` SQL -- replaced with `JobStatus::Pending.id()`/`JobStatus::Running.id()` parameterized binds. FIXED (MEDIUM DRY-095): Job WS message type magic strings 4x in `progress.rs` -- created `core/src/job_events.rs` with `MSG_TYPE_JOB_PROGRESS/COMPLETED/FAILED/CANCELLED` constants. FIXED (MEDIUM DRY-096): `serde_json::json! + Message::Text + broadcast` pipeline repeated 4x -- extracted `broadcast_json()` helper. WATCH: DRY-093 (`MAX_LIMIT`/`DEFAULT_LIMIT` pagination constants now at 3 consumers). CLEAN: migration (proper trigger, indexes, FK constraints), model (uses DbId/Timestamp), route file, engine/mod.rs, DataResponse used correctly throughout, JobStatus enum properly defined in status.rs. |
| 2026-02-21 | Group 1 Phase 2 (PRD-07, PRD-47, PRD-02 DRY fix, PRD-29 deferred) | 46 files (20 backend: 4 migrations, 3 models, 3 repos, 3 handlers, 3 routes, 1 router, 1 engine/mod, 1 dispatcher, 1 progress; 6 frontend: 3 domain components, 1 TokenEditor, 1 TokenEditor.test, 1 useThemePersistence; 2 modified: main.rs, tests/common/mod.rs) + cross-ref to DRY-TRACKER, notification.rs, trash.rs, response.rs, Dropdown.tsx, use-hardware.ts | 1 HIGH fixed (DRY-108), 2 MEDIUM fixed (DRY-109, 6x duplicate updaters), 1 RESOLVED (DRY-017), 3 WATCH new (DRY-106, DRY-107, DRY-093 status updated), rest CLEAN | **DRY-017 RESOLVED**: `build_app_router()` in `api/src/router.rs` now single source of truth; both `main.rs` and `tests/common/mod.rs` call it with zero duplication. **DRY-108 FIXED**: `TokenEditor.tsx` was 670 lines (over 500-line threshold) with 7 inlined section components and 6 structurally identical `updateX` functions; extracted sections to `token-editor/TokenSections.tsx` (404 lines), main component now 298 lines, 6 updaters replaced with single generic `updateTokenSection<K>()`. **DRY-109 FIXED**: `TagWithCount` redundantly re-exported from `TagInput.tsx` and `TagFilter.tsx`; removed, canonical source is `TagChip.tsx`. **DRY-093 CONFIRMED**: 4th consumer (`tag_repo.rs`) confirmed, extraction threshold met, status updated to flagged. **NEW WATCH**: DRY-106 (theme status `'active'` magic string, 1 consumer), DRY-107 (`STATUS_OPTIONS` hardcoded status_id numbers in TokenEditor, 1 consumer). **CLEAN**: All 3 handler files properly use `DataResponse<T>`, `AuthUser`, `ROLE_ADMIN` import, `CoreError::NotFound`. All 3 repo files use `COLUMNS` constant pattern, `DbId`/`Timestamp` types. All 3 route files are thin routers. `router.rs` cleanly extracts DRY-017. Job model uses `JobStatus` enum, no magic numbers. Tag model types well-structured with `TagInfo`/`TagWithCount` hierarchy. Theme model follows established CRUD patterns. `dispatcher.rs` uses `JobStatus::*.id()` (DRY-094 pattern). `progress.rs` uses `MSG_TYPE_JOB_*` constants and `broadcast_json` helper (DRY-095/096 resolved). `jobs.rs` uses `find_and_authorize` helper (DRY-097 resolved). Frontend `TagChip/TagInput/TagFilter` follow design token conventions. `useThemePersistence` properly isolated from `ThemeProvider`. |
| 2026-02-21 | PRD-47 (Tagging & Custom Labels) | 9 new (2 migrations, 1 model, 1 repo, 1 handler, 1 route, 3 frontend components) + 12 cross-ref (scripts.rs, hardware.rs, jobs.rs, trash.rs, trash_repo.rs, response.rs, job_repo.rs, notification.rs, StatusBadge.tsx, ThumbnailCard.tsx, Dropdown.tsx, use-hardware.ts) | 1 HIGH fixed (DRY-099), 1 MEDIUM fixed (DRY-101), 1 HIGH watch (DRY-098), 3 MEDIUM watch (DRY-093 worsened, DRY-102, DRY-103), 2 LOW watch (DRY-104, DRY-105), rest CLEAN | FIXED (HIGH DRY-099): `TagSuggestion` in `TagInput.tsx` was structurally identical to `TagWithCount` (`TagInfo + usage_count`) -- unified to single `TagWithCount` type exported from `TagChip.tsx`, eliminated 8-line duplicate interface. FIXED (MEDIUM DRY-101): Inline `prefix.trim().to_lowercase()` in `tag_repo.rs:suggest()` duplicated existing `normalize_tag_name()` helper -- replaced with function call. WORSENED: DRY-093 now at 4 consumers (tag_repo.rs is 4th), extraction threshold met. WATCH: DRY-098 (validate_entity_type function in 2 handlers with different registries), DRY-102 (click-outside pattern at 2 consumers), DRY-103 (raw API calls instead of TanStack Query hooks), DRY-104 (taggable entity type constants, 1 consumer), DRY-105 (inline SVG close icon, 1 consumer). CLEAN: both migrations (proper trigger, indexes, UNIQUE constraints), model DTOs (uses DbId/Timestamp, proper projection types), handler (correctly uses DataResponse<T>, AuthUser, RequireAdmin, CoreError::NotFound), route file, TagChip.tsx (focused single-responsibility), TagFilter.tsx (proper TagInfo extension). |
| 2026-02-21 | Group 3 Phase 2 (PRD-15, PRD-17) | 28 files (8 backend new: 2 models, 2 repos, 2 handlers, 2 routes; 4 backend core: 2 reclamation, 2 assets submodules; 8 SQL migrations; 10 frontend: 6 components, 2 hook files, 1 format utility, 1 CompatibilityWarning) | 5 HIGH fixed (DRY-117 to DRY-121), 1 FLAGGED worsened (DRY-093), 5 WATCH new (DRY-122 to DRY-126), rest CLEAN | **FIXED (HIGH DRY-117):** `formatFileSize()` identically defined in `AssetBrowser.tsx:38` and `AssetDetail.tsx:23` -- behaviorally duplicated `formatBytes()` from `@/lib/format.ts`. Removed both (18 lines), replaced with `formatBytes` import. **FIXED (HIGH DRY-118):** `formatDate()` local helper in `AssetDetail.tsx` -- extracted to shared `formatDate()` in `@/lib/format.ts`. **FIXED (HIGH DRY-119):** `reclamation.rs` handler imported `DataResponse` but used `serde_json::json!` for 11 of 13 endpoints -- migrated all to `DataResponse<T>` with `impl IntoResponse` return types. DRY-083 partially reduced (reclamation cleared). **FIXED (HIGH DRY-120):** Column lists repeated 15x across `reclamation_repo.rs` -- extracted 4 COLUMNS constants (`RULE_COLUMNS`, `POLICY_COLUMNS`, `TRASH_COLUMNS`, `RUN_COLUMNS`) following established `asset_repo.rs` pattern. Eliminated ~60 lines of duplicate column strings. **FIXED (HIGH DRY-121):** `verify_exists + NotFound` guard repeated 4x identically in `assets.rs` handler (add_dependency, get_impact, add_note, rate_asset) -- extracted `ensure_asset_exists(pool, id)` helper, following DRY-097 (find_and_authorize) pattern. Eliminated 20 lines. **WORSENED DRY-093:** `asset_repo.rs` (50/100) is 5th consumer of pagination clamping pattern; `reclamation.rs` has 2x bare `unwrap_or(50)` without MAX_LIMIT cap. **WATCH:** DRY-122 (trash queue status_id magic numbers), DRY-123 (asset STATUS_OPTIONS hardcoded ids), DRY-124 (ASSET_TYPE_OPTIONS hardcoded ids), DRY-125 (`"required"`/`"info"` default strings in repo), DRY-126 (`"manual"` run_type string). **CLEAN:** All 8 SQL migrations (proper triggers, indexes, UNIQUE constraints, FK indexes). Both models (use DbId/Timestamp, clean DTOs). Both route files (thin routers). Core modules (pure logic, no DB deps, proper unit tests). All frontend hooks (TanStack Query with proper query key factories). Frontend components all under 500 lines. `ProtectedBadge` is a thin intentional wrapper. `CompatibilityWarning` well-structured. |
| 2026-02-21 | Group 2 Phase 2 (PRD-30, PRD-32, PRD-52) | 53 files (15 backend: 3 migrations, 3 models, 3 repos, 3 handlers, 3 routes; 38 frontend: 14 layout, 10 progressive-disclosure, 13 shortcuts, 1 AdvancedDrawer) + 3 cross-ref (themes.rs, theme_repo.rs, useThemePersistence.ts) | 3 HIGH fixed (DRY-110, DRY-111, DRY-116), 5 WATCH new (DRY-112 to DRY-115), rest CLEAN | **FIXED (HIGH DRY-110):** `CATEGORY_LABELS` and `CATEGORY_ORDER` identically declared in `CheatSheet.tsx` and `KeymapEditor.tsx` -- extracted to `ShortcutRegistry.ts` alongside new `groupBindingsByCategory()` utility; both consumers refactored to import. Eliminated 20 duplicate lines. **FIXED (HIGH DRY-111):** `snapValue()` identically defined in `useSnapGrid.ts` and `usePanelResize.ts` (same `Math.round(value/gridSize)*gridSize` body) -- exported from `useSnapGrid.ts`, imported in `usePanelResize.ts`. Eliminated 3 duplicate lines. **FIXED (HIGH DRY-116):** `export_keymap` handler had two identical `serde_json::json!` branches (Some/None) producing same JSON shape -- extracted shared destructuring with fallback defaults. Eliminated 7 duplicate lines. **WATCH DRY-112:** Debounce timer pattern at 3 persistence hooks (theme, layout, proficiency). Extract `useDebouncedCallback` at 4th consumer. **WATCH DRY-113:** Proficiency level strings in SQL (beginner/intermediate/expert). Same cross-boundary pattern as DRY-079. **WATCH DRY-114:** Preset name list cross-boundary duplication (backend PRESET_NAMES vs frontend presets map). **WATCH DRY-115:** Raw `api.*()` calls in layout persistence (same pattern as DRY-103 for tags). **CLEAN:** All 3 migrations (proper triggers, indexes, UNIQUE constraints, FK indexes). All 3 models use `DbId`/`Timestamp`, proper `FromRow`/`Serialize`/`Deserialize` derives. All 3 repos use `COLUMNS` constant pattern, clean SQL. All 3 handlers use `DataResponse<T>`, `RequireAuth`/`RequireAdmin`, `CoreError::NotFound` pattern. All 3 route files are thin routers. Frontend: all components under 500 lines, design token CSS variables used consistently, proper Zustand store patterns, barrel exports. No cross-feature type duplication. DRY-003 (CRUD handler boilerplate) remains `watch` -- handlers are thin-adapter, no macro warranted yet. DRY-004 (pagination) not impacted -- no list endpoints use pagination in this batch. DRY-093 (pagination clamping) not impacted. |
| 2026-02-21 | Group 4 Phase 2 (PRD-41, PRD-42, PRD-54, PRD-36, PRD-37) | 52 files (9 backend: 2 models, 2 repos, 2 handlers, 2 routes, 1 migration; 43 frontend: 7 dashboard/performance, 5 dashboard/widgets, 3 dashboard hooks/base, 7 cinema, 10 qa-aids, 8 job-tray, 1 hooks/useEventBus, 1 lib/format, 1 video-player/index) | 4 HIGH fixed (DRY-127 to DRY-130), 4 MEDIUM watch (DRY-131 to DRY-134), 1 FLAGGED worsened (DRY-093 to 6 consumers), rest CLEAN | **FIXED (HIGH DRY-127):** `formatTime(seconds)` identically defined in `CinemaMode.tsx` and `GridControls.tsx` -- behavioral duplicate of `formatDuration()` from `video-player/frame-utils.ts`. Removed both locals (16 lines), added barrel export to `video-player/index.ts`, replaced with `formatDuration` import. **FIXED (HIGH DRY-128):** Recharts Tooltip `contentStyle` object duplicated 7x across `QualityCharts.tsx` (4x), `WorkflowComparison.tsx` (2x), `WorkerBenchmark.tsx` (1x). Also axis tick style duplicated 14x and grid stroke 7x. Created `performance/chartStyles.ts` with `TOOLTIP_CONTENT_STYLE`, `AXIS_TICK_STYLE`, `GRID_STROKE`. All 3 files refactored. Eliminated ~70 lines. **FIXED (HIGH DRY-129):** `formatElapsed(seconds)` in `ActiveTasksWidget.tsx` reimplemented `formatDuration` logic from `@/lib/format.ts`. Refactored to delegate: `formatDuration(seconds * 1000)` with null guard. **FIXED (HIGH DRY-130):** Click-outside pattern reached 3-consumer threshold (TagInput, Dropdown, JobTrayPanel). Extracted `useClickOutside(ref, callback, enabled?)` to `src/hooks/useClickOutside.ts`. All 3 consumers refactored. DRY-102 resolved. **WATCH DRY-131:** Workflow aggregation SELECT duplication in `performance_metric_repo.rs` (2 methods). **WATCH DRY-132:** Scope type magic strings (`"global"`, `"workflow"`, `"worker"`) in performance handler. 1 Rust consumer. **WATCH DRY-133:** Worker aggregation SELECT duplication in `performance_metric_repo.rs` (2 methods). **WATCH DRY-134:** `parse_from`/`parse_to` date parsing helpers. 1 consumer. **DRY-093 WORSENED:** Dashboard handler adds 6th consumer (`FEED_MAX_LIMIT`/`FEED_DEFAULT_LIMIT`). **CLEAN:** All backend handlers use `DataResponse<T>`, `RequireAuth`/`RequireAdmin`, `CoreError::NotFound`. Both repos use `COLUMNS`/`INSERT_COLUMNS` pattern. All SQL migrations have proper triggers, indexes, FK indexes. Job tray uses shared `formatDuration` from `@/lib/format.ts`. All dashboard widgets under 500 lines. QA aids are well-factored (pure geometry helpers, physics engine class, audio scrub class all cleanly separated). Cinema mode properly reuses `useVideoPlayer`, `useVideoMetadata`, `formatDuration` from shared video-player module. No cross-feature type duplication. No unused imports detected. |
| 2026-02-21 | PRD-85 (UI Plugin/Extension Architecture) | 16 files (6 backend: 1 migration, 1 model, 1 repo, 1 core module, 1 handler, 1 route; 10 frontend: 1 types, 1 hooks, 1 sandbox, 1 api-bridge, 1 panel-integration, 1 context-menu, 1 metadata-renderer, 1 manager, 1 barrel, 1 test) + cross-ref (router.rs, response.rs, MetricsChart.tsx, 4 test files) | 3 HIGH fixed (DRY-138 to DRY-140), 1 MEDIUM flagged (DRY-135), 2 MEDIUM watch (DRY-136, DRY-137), rest CLEAN | **FIXED (HIGH DRY-138):** `enable_extension`/`disable_extension` handlers were 44-line structural duplicates differing only in boolean arg and log message -- extracted shared `toggle_extension(state, id, user_id, enabled)` helper. Eliminated 22 lines. **FIXED (HIGH DRY-139):** Textarea styling 9-line `cn()` block duplicated in `SettingsEditor` and `InstallForm` (same file) -- extracted `TEXTAREA_BASE_CLASSES` array constant + `textareaBorderClass(hasError)` helper. Both textareas now use shared constants. Eliminated 12 duplicate lines. **FIXED (HIGH DRY-140):** Frontend `methodToAccess()` in `ExtensionApiBridge.ts` mapped POST->"create", PUT->"update", DELETE->"delete" but backend `KNOWN_ACCESS_LEVELS` in `core/src/extensions.rs` only defines `["read", "write"]`. Client-side defense-in-depth check would wrongly deny extensions with `write` permission trying to POST/PUT/DELETE. Aligned frontend to use "read"/"write" matching backend. **FLAGGED DRY-135:** `renderWithProviders` test helper identical across 4+ test files (threshold met). **WATCH DRY-136:** `parseError` + JSON try/catch pattern in 2 sub-components (same file, 2 instances). **WATCH DRY-137:** `collectDesignTokens` vs `getCssVar` CSS property access (related to DRY-082). **CLEAN:** Migration (proper trigger, indexes, UNIQUE constraint). Model uses `DbId`/`Timestamp`, clean DTOs with `FromRow`/`Serialize`/`Deserialize`. Repo uses `COLUMNS` + `REGISTRY_COLUMNS` constant pattern. Core module has proper validation with unit tests, constants in leaf crate. Handler correctly uses `DataResponse<T>`, `RequireAdmin`, `AuthUser`, `CoreError::NotFound/Forbidden`. Route file is a thin router with 3 sub-routers. Routes properly registered in `router.rs`. Frontend types mirror backend manifest schema. TanStack Query hooks follow established pattern with query key factory. Barrel export is clean. Test uses proper vitest/react-testing-library patterns. No `serde_json::json!` in handler (uses `DataResponse<T>` throughout). No magic strings (constants in core). Frontend components all under 500 lines. |
| 2026-02-21 | PRD-28, PRD-04, PRD-45 (Pipeline Checkpointing, Workspace Persistence, Audit Logging) | 38 files (12 PRD-28: 2 migrations, 1 core, 1 model, 1 repo, 1 handler, 1 route, 3 frontend, 1 test, 1 hooks; 14 PRD-04: 2 migrations, 1 core, 1 model, 1 repo, 1 handler, 1 route, 5 frontend, 1 test; 12 PRD-45: 2 migrations, 1 core, 1 model, 1 repo, 1 handler, 1 route, 4 frontend, 1 test) | 6 FIXED (DRY-151 to DRY-156), 3 WATCH new (DRY-154, DRY-159, DRY-160), 2 MEDIUM unfixed (DRY-157 inline dates, DRY-158 raw fetch) | **FIXED (CRITICAL DRY-151):** `formatBytes()` duplicated in `checkpoints/types.ts` -- removed local, re-exported from `@/lib/format.ts`. **FIXED (CRITICAL DRY-152):** `find_and_authorize_job()` in `checkpoints.rs` was line-for-line duplicate of `find_and_authorize()` in `jobs.rs` -- made jobs helper `pub`, imported in checkpoints. **FIXED (HIGH DRY-153):** `resume_from_checkpoint` handler hand-rolled `INSERT INTO jobs` with inline 14-column COLUMNS list duplicating `job_repo.rs` -- extracted `JobRepo::resume_from_checkpoint()` method. **FIXED (HIGH DRY-155):** `query()` and `count()` in `audit_repo.rs` had 45+ identical filter-building lines -- extracted `build_audit_filter()` + `bind_audit_values()`/`bind_audit_values_scalar()` helpers. **FIXED (MEDIUM DRY-156):** Ad-hoc `serde_json::json!` in `checkpoints.rs` diagnostics and `audit.rs` query response -- replaced with typed `JobDiagnosticsResponse` struct and `AuditLogPage` struct. DRY-083 reduced. **WATCH DRY-154:** `FailureDiagnostics` (db) vs `FailureDiagnosticData` (core) near-duplicate -- intentional layer separation. **WATCH DRY-159:** `parse_timestamp` in audit vs `parse_from/parse_to` in performance -- 2 consumers, extract at 3rd (DRY-134). **FLAGGED DRY-160:** Debounce timer pattern now at 5 consumers (DRY-112 escalated). **UNFIXED DRY-157:** Inline `new Date().toLocale*` in AuditLogViewer and ResumeDialog -- should use `formatDateTime` from `@/lib/format.ts`. **UNFIXED DRY-158:** `exportAuditLogs` uses raw `fetch` with `localStorage.getItem("access_token")` bypassing shared API client. **VERIFIED:** `cargo check` clean, `npx tsc --noEmit` clean, `npx biome check` clean, all core unit tests pass. CLEAN: All test files use `renderWithProviders` from `@/lib/test-utils.tsx`. All handlers use `DataResponse<T>`. All repos use COLUMNS constant pattern. All core modules have unit tests. No dead imports. |
| 2026-02-21 | Group 5 Phase 2 (PRD-20, PRD-11, PRD-12) | 45 files (15 backend PRD-20: 3 migrations, 1 core search.rs, 1 model, 1 repo, 1 handler, 1 route, 7 frontend; 13 backend PRD-11: 2 migrations, 1 core, 1 model, 1 repo, 1 handler, 1 route, 6 frontend; 17 backend PRD-12: 3 migrations, 1 core api_keys.rs, 2 models, 2 repos, 2 handlers, 1 route, 6 frontend) | 4 FIXED (DRY-163 to DRY-166), 2 WATCH new (DRY-161, DRY-162), 1 FLAGGED updated (DRY-093 to 7 consumers), rest CLEAN | **FIXED (HIGH DRY-163):** `SearchBar.tsx` used inline click-outside implementation (11-line useEffect with addEventListener/removeEventListener on mousedown) instead of shared `useClickOutside` hook from `src/hooks/useClickOutside.ts` (DRY-102/130 pattern) -- replaced with single `useClickOutside(containerRef, () => setIsOpen(false))` call. **FIXED (HIGH DRY-164):** `execute_saved_search` in `handlers/search.rs` duplicated the search+facets+timing+response assembly pattern from `unified_search` (~15 identical lines) -- extracted `run_search(pool, params)` private async helper. Both handlers now delegate to it. **FIXED (HIGH DRY-165):** `build_tsquery` and `build_prefix_tsquery` in `core/src/search.rs` both had identical 5-line term sanitization logic (split_whitespace + trim_matches + filter) -- extracted `sanitize_terms(query) -> Option<Vec<&str>>` private helper. **FIXED (MEDIUM DRY-166):** `webhooks.rs:list_deliveries` used inline `params.limit.unwrap_or(50).min(200)` + `params.offset.unwrap_or(0)` instead of shared `clamp_limit`/`clamp_offset` from `core/src/search.rs` -- replaced with shared imports. DRY-093 now at 7 consumers (webhook is 7th, now fixed). **WATCH DRY-161:** Confirmation dialog UI pattern duplicated across ApiKeyManager (rotate/revoke) and WebhookManager (delete). Same AlertTriangle + description + Cancel/Action button structure. Design system candidate at 3rd consumer. **WATCH DRY-162:** Admin table styling pattern (Card > overflow-x-auto > table > th classes) repeated across 4 components (ApiKeyManager, WebhookManager, DeliveryLog, ExtensionManager). Threshold met but deferred to design system work. **VERIFIED:** `cargo check` clean, `cargo test -p trulience-core -- search` 19 tests + 2 doc tests passed, `npx tsc --noEmit` clean, `npx vitest run SearchBar.test.tsx` 8/8 passed. **NOT DUPLICATED:** SHA-256 in `api_keys.rs:hash_api_key()` vs `audit.rs:compute_integrity_hash()` -- different purposes (simple hash vs chained integrity hash). `collaboration.rs` vs `search.rs` entity type validation -- different registries by design. **CLEAN:** All 8 SQL migrations. All frontend test files use `renderWithProviders` from `@/lib/test-utils.tsx`. All handlers use `DataResponse<T>`. All repos use COLUMNS constant pattern. All frontend components use `formatDateTime` from `@/lib/format.ts`. Core modules have proper unit tests. TanStack Query hooks follow established key factory pattern. No magic strings detected. |
| 2026-02-21 | Group 4 Phase 2b (PRD-13, PRD-16, PRD-66) | 34 files (10 backend PRD-13: 1 core metadata.rs, 1 model, 1 repo, 1 handler, 1 route, 3 frontend, 1 hooks, 1 test; 10 backend PRD-16: 1 core importer.rs, 1 model, 1 repo, 1 handler, 1 route, 3 frontend, 1 hooks, 1 test; 8 backend PRD-66: 1 core metadata_editor.rs, 1 handler, 1 route, 3 frontend, 1 hooks, 1 test; 6 shared: search.rs, api_keys.rs, audit.rs, images.rs, import_status.rs, api.ts, format.ts) | 5 HIGH (DRY-167 to DRY-170, DRY-176), 3 MEDIUM (DRY-171, DRY-172, DRY-173), 2 WATCH (DRY-174, DRY-175), 2 LOW (DRY-177, DRY-178), 0 fixed (read-only audit) | **HIGH DRY-167:** SHA-256 hex digest implemented 3x in core (`metadata.rs:sha256_hex`, `api_keys.rs:hash_api_key`, `audit.rs:compute_integrity_hash`). First two are structurally identical. Extract shared `sha256_hex()` to `core/src/hashing.rs`. **HIGH DRY-168:** Metadata regeneration logic (serialize -> hash -> create -> upsert) duplicated 2x within `metadata.rs` handler at lines 197-215 and 267-279. Extract `upsert_generation()` private helper. **HIGH DRY-169:** `find_stale_characters`/`find_stale_scenes` are 20-line structural duplicates in `metadata_repo.rs` differing only by table name and entity type. Extract generic `find_stale_entities()`. **HIGH DRY-170:** Magic strings `'character'`/`'scene'` hardcoded in 4 SQL queries in `metadata_repo.rs` instead of using constants from `core/src/metadata.rs`. **HIGH DRY-176:** `serde_json::json!` at 3 handler endpoints (`metadata.rs` x2, `importer.rs` x1) instead of typed `DataResponse<T>` (DRY-083 pattern). **FLAGGED DRY-171:** Raw `fetch` with `localStorage.getItem("access_token")` in 2 frontend files (3 instances), bypassing shared `api.ts` client auth. One instance in `use-importer.ts` has NO auth header at all (potential bug). **MEDIUM DRY-172:** `formatValue()`/`formatCellValue()` near-identical in 2 metadata-editor components. **MEDIUM DRY-173:** Inline `toLocaleString()` in `StalenessIndicator.tsx` instead of `formatDateTime`. **WATCH DRY-174:** `IMAGE_EXTENSIONS` in `importer.rs` overlaps `VALID_IMAGE_FORMATS` in `images.rs` (same set, different format). **WATCH DRY-175:** Hardcoded `'uploading'` in SQL instead of `SESSION_STATUS_UPLOADING`. **LOW DRY-177:** Session status vs import status constant overlap (different lifecycles, acceptable). **LOW DRY-178:** `PhysicalAttributes` struct vs field definitions dual representation (intentional). **CLEAN:** All frontend test files use `renderWithProviders` from `@/lib/test-utils.tsx`. All repos use COLUMNS constant pattern. TanStack Query hooks follow established key factory pattern. `character_metadata.rs` handler properly uses `DataResponse<T>`. Core modules (`metadata_editor.rs`, `importer.rs`, `metadata.rs`) are pure logic with zero DB deps. All route files are thin routers. |
| 2026-02-21 | Group 1 Phase 3 (PRD-21, PRD-08) | ~40 files (10 backend new: 2 core modules, 2 models, 2 repos, 2 handlers, 2 routes; 6 backend modified: status.rs, image.rs, image_variant_repo.rs, image_variant.rs, character routes, job routes; 8 SQL migrations; 14 frontend: types, hooks, components, barrel exports for images + queue; 6 test files refactored) | 5 HIGH fixed (DRY-141 to DRY-145), 1 FLAGGED resolved (DRY-135), 5 MEDIUM watch (DRY-146 to DRY-150), rest CLEAN | **RESOLVED (DRY-135):** `renderWithProviders` test helper duplicated across 6 test files -- extracted to shared `src/lib/test-utils.tsx`. All 6 consumers refactored: VariantGallery.test, QueueStatusView.test, ExtensionManager.test, PerformanceDashboard.test, StudioPulse.test, ReclamationDashboard.test. **FIXED (HIGH DRY-141):** `formatFileSize()` in `SourceImageUpload.tsx` was behavioral duplicate of `formatBytes()` from `@/lib/format.ts` -- removed local, replaced with shared import. **FIXED (HIGH DRY-142):** `formatDate()` in `VariantHistory.tsx` was identical to `formatDateTime()` from `@/lib/format.ts` -- removed local, replaced with shared import. **FIXED (HIGH DRY-143):** `"storage/variants"` path literal duplicated 2x in `image_variant.rs` -- extracted `VARIANT_STORAGE_DIR` constant + `ensure_variant_dir()` async helper (following DRY-088 `THUMBNAIL_STORAGE_DIR` pattern). **FIXED (HIGH DRY-145):** All 10 endpoints in `image_variant.rs` returned raw `Json<T>` instead of `DataResponse<T>` -- migrated all to `DataResponse<T>` + `impl IntoResponse` return types. Removed unused `ImageVariant` import. **WATCH DRY-146:** `formatWait()`/`formatSeconds()` in queue components -- similar to `formatDuration` but specialized for queue display. 1 consumer each. **WATCH DRY-147:** `UpdateImageVariant` struct all-None construction repeated 2x in image_variant.rs (reject/export) -- extract `UpdateImageVariant::status_only(status_id)` builder at 3rd consumer. **WATCH DRY-148:** Multipart upload parsing pattern duplicated in `reimport_variant`/`upload_manual_variant` -- extract `parse_image_upload(multipart)` helper at 3rd consumer. **WATCH DRY-149:** `state_machine::status_name()` in `core/src/scheduling.rs` maps same IDs as `JobStatus` enum -- intentional separation (core vs db), no action needed unless they diverge. **WATCH DRY-150:** `"off_peak"` magic string in scheduling model -- 1 consumer, extract at 2nd. **VERIFIED:** `cargo check` clean (0 warnings), `npx tsc --noEmit` clean, `cargo test --lib` all passed, `npx vitest run` 292/292 tests passed across 26 files. |

| 2026-02-21 | Group 5 Phase 2b (PRD-33, PRD-35, PRD-44) | 34 files (11 PRD-33: 1 core, 1 model, 1 repo, 1 handler, 1 route, 6 frontend; 12 PRD-35: 1 core, 1 model, 1 repo, 1 handler, 1 route, 7 frontend; 12 PRD-44: 2 core, 1 model, 1 repo, 2 handlers, 2 routes, 6 frontend) + cross-ref to hashing.rs, audit.rs, search.rs, format.ts, roles.rs, Modal, Spinner | 4 HIGH (DRY-179 to DRY-182), 6 MEDIUM (DRY-183 to DRY-188), 2 LOW (DRY-189, DRY-190), 0 fixed (read-only audit) | **HIGH DRY-179:** Duplicate sensitive-key redaction functions in `audit.rs::redact_sensitive_fields` and `config_export.rs::redact_sensitive` -- overlapping key lists (6 shared keys out of 10 each), different placeholders, different APIs (clone vs mutate). Extract shared `core/src/redaction.rs`. **HIGH DRY-180:** `ensure_segment_exists` pattern (SegmentRepo::find_by_id + NotFound) repeated 3x identically in `approval.rs` (approve/reject/flag). Extract private helper (DRY-097/DRY-121 pattern). **HIGH DRY-181:** Identical `onSuccess` invalidation callbacks in 3 review mutation hooks (`useApproveSegment`/`useRejectSegment`/`useFlagSegment`). Same `mutationFn` shape. Extract `useDecisionMutation<T>(endpoint)` factory. ~40 lines duplicate. **HIGH DRY-182:** ComfyUI workflow parsing duplicated between backend handler (~85 lines) and frontend `comfyui-parser.ts` (~53 lines). Same node/edge extraction logic. Cross-boundary behavioral duplicate. Watch only (2 consumers, different runtimes). **MEDIUM DRY-183:** Inline pagination clamping in `bug_reports.rs` (`unwrap_or(50).min(200)`) instead of `clamp_limit`/`clamp_offset` from `core/src/search.rs`. DRY-093 now at 8 consumers. **MEDIUM DRY-184:** Hardcoded `"admin"` string 2x in `bug_reports.rs` instead of `ROLE_ADMIN` from `core/src/roles.rs`. Same violation as DRY-090 (CRITICAL in PRD-07). **MEDIUM DRY-185:** Magic timing thresholds 1000/5000 in `WorkflowCanvas.tsx` duplicating `TIMING_FAST_MS`/`TIMING_MODERATE_MS` from backend. Extract frontend constants to `types.ts`. **MEDIUM DRY-186:** `RejectionDialog.tsx` hand-rolls modal overlay instead of using `Modal` composite (used by 11+ components). Missing Escape key, focus trapping. **MEDIUM DRY-187:** `WorkflowCanvas.tsx` inline loading spinner instead of `Spinner` primitive (used by 30+ components). **MEDIUM DRY-188:** `BugReportList.tsx` uses `toLocaleDateString()` instead of `formatDate` from `@/lib/format.ts` (DRY-157/DRY-173 pattern). **LOW DRY-189:** State machine pattern structural duplicate in `bug_report.rs` and `scheduling.rs` (same `valid_transitions`/`validate_transition` structure, different types `&str` vs `i16`). 2 consumers, watch. **LOW DRY-190:** Auth extractor inconsistency (`RequireAuth` in workflow_canvas vs `AuthUser` in approval/bug_reports). Style issue, not duplication. **CLEAN:** All test files use `renderWithProviders` from `@/lib/test-utils`. All repos use COLUMNS constant pattern. All handlers use `DataResponse<T>`. All route files are thin routers. All TanStack Query hooks follow key factory pattern. All frontend hooks use shared `api` client. All DB models use `DbId`/`Timestamp`. Core modules have unit tests. No dead imports. No cross-feature type duplication. |

| 2026-02-21 | PRD-53 (First-Run Experience & Onboarding) | 16 files (6 backend: 1 migration, 1 core, 1 model, 1 repo, 1 handler, 1 route; 10 frontend: 1 types, 2 hooks, 4 components, 1 tourPaths, 1 hintDefinitions, 1 barrel) + 2 cross-ref (Tooltip.tsx, workspace_repo.rs) | 5 HIGH fixed (DRY-191/192/194/197/198), 3 MEDIUM fixed (DRY-193/195/196), 2 LOW watch (DRY-199/200), 1 LOW quality (DRY-201) | **FIXED (HIGH DRY-191):** `handleTourComplete`/`handleTourSkip` identical callbacks in OnboardingGate -- merged to single `handleTourEnd`. **FIXED (HIGH DRY-192):** `PLACEMENT_CLASSES` in ContextualHint identical to Tooltip.tsx `POSITION_CLASSES` -- exported `Placement` type + `PLACEMENT_CLASSES` from Tooltip, imported in ContextualHint. **FIXED (HIGH DRY-194):** Redundant plain index duplicating unique index on `user_onboarding(user_id)` -- removed. **FIXED (HIGH DRY-197):** `validate_checklist_item`/`validate_feature_key` structurally identical -- extracted generic `validate_known_key`/`validate_known_keys` private helpers. **FIXED (HIGH DRY-198):** `get_or_create` 2-query pattern (DO NOTHING + SELECT) -- refactored to single-query no-op UPDATE pattern from `workspace_repo.rs`. **FIXED (MEDIUM DRY-193):** Placement union type 4x -- unified to `Placement` from Tooltip. **FIXED (MEDIUM DRY-195):** Dismiss-button styling 3x -- extracted `DISMISS_LINK_CLASSES`. **FIXED (MEDIUM DRY-196):** `HintDefinition` in wrong file -- moved to `types.ts`. **WATCH DRY-199:** Role name strings in tourPaths cross-boundary. **WATCH DRY-200:** TourEngine overlay lacks Escape/focus trap. **LOW DRY-201:** `console.log` stub in OnboardingChecklist. **VERIFIED:** `cargo check` clean, 315 core tests passed, `tsc --noEmit` clean. |

| 2026-02-22 | PRD-23 (Scene Type Configuration) | 16 files (5 backend: 1 core, 1 model, 1 repo, 1 handler, 1 route; 7 frontend: 1 types, 1 hooks, 3 components, 1 barrel, 1 index; 3 tests; 1 migration) + 5 cross-ref (Badge.tsx, StatusBadge.tsx, ActiveTasksWidget.tsx, onboarding.rs, dashboard.rs) | 4 HIGH fixed (DRY-201 to DRY-204), 4 WATCH new (DRY-205 to DRY-208), rest CLEAN | **FIXED (CRITICAL DRY-201):** `regex::Regex::new(r"\{(\w+)\}")` compiled on every call to `resolve_prompt_template()` (line 94) and `extract_placeholders()` (line 182) in `core/src/scene_type_config.rs` -- extracted to `static PLACEHOLDER_RE: LazyLock<regex::Regex>` module-level constant. Compiles once, reused forever. **FIXED (HIGH DRY-202):** `type BadgeVariant` locally redefined in `SceneMatrixView.tsx` (line 31) instead of importing from `Badge.tsx` -- exported `BadgeVariant` from `Badge.tsx`, added to primitives barrel, SceneMatrixView now imports it. Same redefinition exists in `StatusBadge.tsx` (line 3) and `ActiveTasksWidget.tsx` (line 13) -- fix when files are next touched. **FIXED (HIGH DRY-203):** 150-character textarea className string duplicated 3x across `PromptTemplateEditor.tsx` (lines 117, 138) and `SceneTypeEditor.tsx` (line 129) -- extracted `TEXTAREA_CLASSES` constant to `PromptTemplateEditor.tsx`, exported via barrel, imported in `SceneTypeEditor.tsx`. **FIXED (HIGH DRY-204):** Magic `status_id` numbers `1..5` mapped to display strings in `generate_matrix` handler (line 326) -- extracted `scene_status_label()` function using `SceneStatus::*.id()` pattern (follows DRY-094 fix in `dispatcher.rs`). **WATCH DRY-205:** `validate_variant_applicability` in `scene_type_config.rs` structurally duplicates `validate_known_key` in `onboarding.rs`. 2 consumers, different error types. Extract generic at 3rd. **WATCH DRY-206:** Pre-DataResponse CRUD handlers return raw `Json<T>` without envelope. Same pattern as other Phase 1 handlers. **WATCH DRY-207:** Variant constants cross-boundary Rust/TS. Same pattern as DRY-079/DRY-114. **WATCH DRY-208:** `CLIP_POSITIONS` vs `CLIP_TABS` -- same IDs, different purposes. **CLEAN:** Migration (proper UNIQUE index, correct `WHERE` clause for partial index). Model uses `DbId`/`Timestamp`, clean DTOs with `FromRow`/`Serialize`/`Deserialize`. Repo uses `COLUMNS` constant, consistent `format!` query pattern. Handler properly uses `DataResponse<T>` + `impl IntoResponse` for PRD-23 endpoints. Route file is thin router. Frontend hooks follow TanStack Query key factory pattern with `api` client. Tests use `renderWithProviders` from `@/lib/test-utils.tsx`. Core module has comprehensive unit tests (21 tests). No `serde_json::json!` in PRD-23 handlers. No raw `fetch` calls. All imports resolve correctly. **VERIFIED:** `cargo check` clean, `cargo test -p trulience-core -- scene_type_config` 21/21 passed, `npx tsc --noEmit` clean, `npx vitest run src/features/scene-types` 11/11 passed. |

| 2026-02-22 | PRD-46, PRD-76 (Worker Pool Management, Character Identity Embedding) | 40 files (14 backend: 2 core modules, 4 db models, 3 db repos, 2 handlers, 2 routes, 1 error.rs; 19 frontend: 2 types, 2 hooks, 5 components, 2 barrel exports, 6 test files; 7 SQL migrations) + cross-ref (Badge.tsx, format.ts, db lib.rs, models/mod.rs, repos/mod.rs, core lib.rs) | 1 CRITICAL fixed (DRY-209), 5 HIGH fixed (DRY-210 to DRY-213, DRY-216), 3 MEDIUM fixed (DRY-214, DRY-215, DRY-217), 1 WATCH new (DRY-218), rest CLEAN | **FIXED (CRITICAL DRY-209):** `EmbeddingStatus` enum duplicated in `core/src/embedding.rs` (hand-rolled with `from_id`, `label`, `id` + domain logic dependency) and `db/src/models/status.rs` (macro-generated via `define_status_enum!`). Core version is canonical (domain logic `classify_extraction_result` depends on it). Removed db macro version, added explanatory comment. **FIXED (HIGH DRY-210):** Local `formatDate()` in `WorkerDetailPanel.tsx` -- behavioral duplicate of `formatDateTime` from `@/lib/format.ts`. Replaced with `formatDateOrDash()` wrapper using shared import. **FIXED (HIGH DRY-211):** Inline `BadgeVariant` union type in `workers/types.ts` instead of importing from `@/components/primitives/Badge`. Added `WORKER_STATUS` named constants object (IDLE=1, BUSY=2, OFFLINE=3, DRAINING=4) to eliminate magic numbers. **FIXED (HIGH DRY-212):** `find_by_id + ok_or(NotFound)` pattern repeated 9x in `workers.rs` handler. Extracted `ensure_worker_exists(pool, id) -> AppResult<Worker>` + `validate_create_input(input) -> AppResult<()>` helpers. **FIXED (HIGH DRY-213):** Hardcoded `status_id` numbers (1, 3) in `worker_repo.rs` SQL for `register`, `list_available`, `approve`, `decommission`. Replaced with bind parameters using `WorkerStatus::Idle.id()` / `WorkerStatus::Offline.id()`. Fleet stats FILTER clauses left as-is (cannot parameterize SQL aggregate filters). **FIXED (MEDIUM DRY-214):** Inline 7-line SVG close icon in `LowConfidenceWarning.tsx`. Replaced with `<X size={16} />` from `@/tokens/icons`. **FIXED (MEDIUM DRY-215):** Redundant `.map_err(\|e\| AppError::Core(e))` in `embedding.rs` handler -- `#[from] CoreError` on `AppError` provides auto-conversion via `?`. Removed explicit map_err. **FIXED (HIGH DRY-216):** Worker validation block (validate_worker_name + validate_tags) duplicated in `register_worker` and `self_register_worker` -- extracted to `validate_create_input()` helper. **FIXED (MEDIUM DRY-217):** Magic number `4` for draining status in `WorkerDetailPanel.tsx` conditional -- replaced with `WORKER_STATUS.DRAINING` named constant. **WATCH DRY-218:** `formatHeartbeat` relative time formatter in `WorkerCard.tsx` (1 consumer). Extract to `@/lib/format.ts` as `formatRelativeTime(iso)` if a 2nd consumer appears. **CLEAN:** All 6 test files use `renderWithProviders` from `@/lib/test-utils.tsx`. All handlers use `DataResponse<T>`. All repos use COLUMNS constant pattern. All route files are thin routers. TanStack Query hooks follow established key factory pattern with `api` client. `embedding.rs` handler correctly uses `ensure_character_exists` pattern. Core modules (`worker_pool.rs`, `embedding.rs`) are pure validation logic with comprehensive unit tests. Frontend `EmbeddingStatusBadge` correctly imports `BadgeVariant` from primitives. `embedding/types.ts` has proper `EMBEDDING_STATUS` named constants (clean). No `serde_json::json!` in any handler. No raw `fetch` calls. All imports resolve. **VERIFIED:** `cargo check` clean (0 warnings), `cargo test -p trulience-core --lib` 366 passed, `cargo test -p trulience-db --lib` 5 passed, `npx tsc --noEmit` clean, `npx vitest run` 469/469 tests passed across 56 files. |

| 2026-02-22 | PRD-48, PRD-51, PRD-60 (External & Tiered Storage, Undo/Redo Architecture, Character Library) | 45 files (9 backend core/db/handler/route per PRD: 3 core modules, 3 db models, 3 db repos, 3 handlers, 3 routes; 24 frontend: 6 storage, 8 undo, 8 library + barrel exports; 9 test files) + cross-ref (@/lib/format.ts, db/src/models/status.rs, Badge.tsx, ensure_*_exists patterns) | 2 CRITICAL fixed (DRY-219, DRY-220), 4 HIGH fixed (DRY-221 to DRY-224), 1 MEDIUM updated (DRY-160 to 6 consumers), 1 LOW watch new (DRY-226), rest CLEAN | **FIXED (CRITICAL DRY-219):** `formatBytes()` duplicated locally in `BackendConfigPanel.tsx` (line 9, 8 lines) and `MigrationProgressView.tsx` (line 10, 8 lines) -- behavioral duplicate of `formatBytes()` from `@/lib/format.ts`. Removed both locals (16 lines total), replaced with shared import. **FIXED (CRITICAL DRY-220):** `StorageBackendStatus` and `StorageMigrationStatus` enums duplicated in `core/src/storage.rs` (hand-rolled with `id()`, `label()`, `from_id()`, `from_name()`) and `db/src/models/status.rs` (canonical source via `define_status_enum!` macro). The core versions were dead code -- only used by internal unit tests, never imported by handlers (handlers correctly import from `db::models::status`). Removed enums + 16 unit tests from core. Added comment: `// NOTE: StorageBackendStatus and StorageMigrationStatus live in trulience_db::models::status (DRY-220).` **FIXED (HIGH DRY-221):** 4x `.ok_or_else(\|\| AppError::Core(CoreError::NotFound { entity: "LibraryCharacter", id }))` scattered across `library.rs` (get, usage, import, update). Extracted `ensure_library_character_exists(pool, id) -> AppResult<LibraryCharacter>` private helper, following DRY-097/DRY-121 pattern. **FIXED (HIGH DRY-222):** 3x `.ok_or_else(\|\| AppError::Core(CoreError::NotFound { entity: "StorageMigration", id }))` in `storage.rs` (get_migration, rollback_migration x2). Extracted `ensure_migration_exists(pool, id) -> AppResult<StorageMigration>` private helper. `ensure_backend_exists` already existed for StorageBackend -- now both entity types have helpers. **FIXED (HIGH DRY-223):** `LibraryUsagePanel.tsx` used inline `new Date(entry.imported_at).toLocaleDateString()` instead of shared `formatDate()` from `@/lib/format.ts`. Replaced with `formatDate(entry.imported_at)`. Same violation pattern as DRY-157/DRY-173/DRY-188. **FIXED (HIGH DRY-224):** `MigrationProgressView.tsx` used `new Date(migration.started_at).toLocaleString()` and `StatePreview.tsx` used `new Date(node.timestamp).toLocaleString()` (where `node.timestamp` is epoch ms). Both replaced with `formatDateTime()` from `@/lib/format.ts`. StatePreview converts epoch ms to ISO string first: `new Date(node.timestamp).toISOString()`. **UPDATED DRY-160 (MEDIUM):** `use-entity-undo.ts` is the 6th consumer of the debounce timer pattern (useRef+setTimeout). DRY-160 status remains `flagged`. **NEW WATCH DRY-226 (LOW):** `makeAction()` test helper duplicated between `UndoTree.test.ts` (full override object) and `HistoryBrowser.test.tsx` (label-only shortcut). Same concept, different signatures. 2 consumers in same feature. **NOT DUPLICATED:** `UndoTree.ts` class (199 lines) is unique -- no similar tree data structure exists in the codebase. `StorageBackendType` enum in `core/src/storage.rs` is NOT a duplicate of `define_status_enum!` -- it maps type names/labels/IDs, not status lifecycle. `validate_tier()`, `validate_backend_config()`, `validate_entity_type()`, `validate_linked_fields()` are all domain-specific validators with different logic. All 3 frontend hook files properly use TanStack Query with key factories. All test files use `renderWithProviders` from `@/lib/test-utils.tsx`. **CLEAN:** All 3 handler files properly use `DataResponse<T>` + `impl IntoResponse`. All route files are thin routers. All core modules have unit tests. All repos use COLUMNS constant pattern. No `serde_json::json!` in any handler. No raw `fetch` calls. No magic status_id numbers. No dead imports. **VERIFIED:** `cargo check` clean, `cargo test -p trulience-core --lib` 401 passed, `npx tsc --noEmit` clean, `npx vitest run` 504/504 tests passed across 65 files. |

| 2026-02-22 | PRD-31, PRD-34, PRD-38 (Command Palette, Interactive Debugger, Collaborative Review) | 42 files (15 backend: 3 core modules, 3 models, 3 repos, 3 handlers, 3 routes; 21 frontend: 3 types, 3 hooks, 10 components, 3 barrel exports, 2 keyboard hooks; 6 test files) + cross-ref (segment.rs, approval.rs, format.ts, search.rs, Badge.tsx) | 1 CRITICAL fixed (DRY-227), 4 HIGH fixed (DRY-228 to DRY-231), 2 MEDIUM watch (DRY-232, DRY-233), 1 MEDIUM watch (DRY-234), 2 LOW watch (DRY-235, DRY-236), rest CLEAN | **FIXED (CRITICAL DRY-227):** `ensure_segment_exists` pattern (SegmentRepo::find_by_id + ok_or_else + CoreError::NotFound) duplicated identically in `approval.rs` (3 inline instances) and `review_notes.rs` (2 inline instances). Extracted to public `ensure_segment_exists(pool, segment_id) -> AppResult<()>` in `api/src/handlers/segment.rs`. Both handlers now import and call it. Also resolves DRY-180 (previously flagged). **FIXED (HIGH DRY-228):** `statusBadgeVariant()` function identically defined in `NoteTimeline.tsx` and `ReviewThread.tsx` -- maps note status to Badge variant ("success"/"warning"/"default"). Extracted to `features/review-notes/types.ts` alongside existing `noteStatusLabel()`/`noteStatusColor()`. Both consumers import. **FIXED (HIGH DRY-229):** Card panel styling (4 CSS classes: surface-primary bg, border-default, rounded-lg, p-4) repeated 5x across 4 debugger components (`JobControls.tsx`, `MidRunParamEditor.tsx`, `LatentPreview.tsx` 2x, `AbortDialog.tsx`). Extracted `DEBUGGER_CARD_CLASSES` array constant to `features/debugger/types.ts`. All 4 component files updated to spread `...DEBUGGER_CARD_CLASSES`. **FIXED (HIGH DRY-230):** Textarea styling (8 CSS classes: surface-secondary bg, border, rounded-md, padding, text-sm, text color, placeholder color, focus ring) duplicated in `MidRunParamEditor.tsx` and `AbortDialog.tsx`. Extracted `DEBUGGER_TEXTAREA_BASE` array constant to `features/debugger/types.ts`. Both consumers updated. **FIXED (HIGH DRY-231):** Fully-qualified `trulience_core::error::CoreError::NotFound` used 3x in `review_notes.rs` and 1x in `approval.rs` instead of imported alias. All other handler files use `use trulience_core::error::CoreError;`. Added import to both files, replaced all fully-qualified paths. **WATCH DRY-232:** `validate_control_action("pause"/"resume"/"abort")` called with hardcoded valid strings in `job_debug.rs` handler -- validation always succeeds. Defensive-in-depth, acceptable. **WATCH DRY-233:** `validate_recent_limit` in `command_palette.rs` is a specialized `clamp_limit` (no Option, has min=1 floor). 1 consumer. **WATCH DRY-234:** `review_note_repo.rs` repeats `rn.`-prefixed columns in JOIN queries vs `NOTE_COLUMNS` (unprefixed). Acceptable for disambiguated JOINs. **WATCH DRY-235:** `AbortDialog.tsx` hand-rolls modal overlay (3rd consumer with DRY-186/DRY-161). Design system candidate. **WATCH DRY-236:** `CommandPalette.tsx` hand-rolls overlay with portal (4th consumer). Specialized behavior (command palette UX). **NOT DUPLICATED:** All `formatDateTime` usages correctly import from `@/lib/format.ts`. All TanStack Query hooks use proper key factories and `api` client. All test files use `renderWithProviders` from `@/lib/test-utils.tsx`. All handlers use `DataResponse<T>`. All repos use COLUMNS constant pattern. `frecencyScorer.ts` mirrors backend frecency logic intentionally (cross-boundary, different runtimes). `CommandRegistry` is unique. `VoiceMemoRecorder` is unique. **CLEAN:** All 3 core modules have unit tests (command_palette: 6, job_debug: 9, review: 14). All 3 repos use COLUMNS constant pattern. All 3 handlers use `DataResponse<T>` + `impl IntoResponse`. All 3 route files are thin routers. All frontend hooks follow TanStack Query key factory pattern. All test files (6) use `renderWithProviders`. No `serde_json::json!` in any handler. No raw `fetch` calls. No magic status_id numbers. No dead imports. No inline date formatting. **VERIFIED:** `cargo check` clean, `cargo test -p trulience-core --lib` 439/439 passed, `npx tsc --noEmit` clean, `npx vitest run` 537/537 passed across 74 files. |

| 2026-02-23 | PRD-43, PRD-56, PRD-79, PRD-104 (System Integrity & Repair Tools, Studio Wiki & Contextual Help, Character Duplicate Detection, Model & LoRA Download Manager) | 43 files (4 core modules, 9 db models, 9 db repos, 4 handlers, 4 routes; 4 frontend features: integrity, wiki, duplicates, downloads; 12 test files; 9 SQL migrations) | 6 HIGH fixed (DRY-251 to DRY-256), 4 MEDIUM fixed (DRY-257 to DRY-260), 3 LOW watch (DRY-261 to DRY-263), rest CLEAN | **FIXED (HIGH DRY-251/252/253):** Inline pagination in `integrity.rs` (local `MAX_LIMIT`/`DEFAULT_LIMIT` constants), `duplicates.rs` (no clamping at all), and `downloads.rs` (wrong max 200). All replaced with `clamp_limit`/`clamp_offset` from `core/src/search.rs`. Extends DRY-093 pattern. **FIXED (HIGH DRY-254):** Magic `status_id = 6` (Completed) and `status_id = 7` (Failed) in `model_download_repo.rs` SQL (`mark_completed`, `mark_failed`, `check_duplicate_hash`). Parameterized SQL with `DownloadStatus::Completed.id()` / `DownloadStatus::Failed.id()`. **FIXED (HIGH DRY-255):** Magic `status_id = 2` in `duplicate_check_repo.rs` `list_pending`. Parameterized with `duplicate_detection::STATUS_MATCH_FOUND_ID`. **FIXED (HIGH DRY-256):** Inline `(bytes / (1024*1024*1024)).toFixed(2) GB` in `ModelChecksumManager.tsx`. Replaced with `formatBytes()` from `@/lib/format.ts`. **FIXED (MEDIUM DRY-257):** Inline `toLocaleString()` in `ScanHistory.tsx`. Replaced with `formatDateTime` from `@/lib/format.ts`. **FIXED (MEDIUM DRY-258):** `serde_json::json!` in `get_worker_report`. Created typed `WorkerReportResponse` struct. **FIXED (MEDIUM DRY-259/260):** 5 scan/repair handlers (`start_scan`, `start_worker_scan`, `repair_worker`, `sync_models`, `install_nodes`) shared identical body. Extracted `trigger_scan(state, auth, worker_id, scan_type)` helper. All 5 now delegate. **WATCH DRY-261:** `generateSlug` cross-boundary (frontend preview vs backend canonical). Different runtimes. **WATCH DRY-262:** `DEFAULT_SIMILARITY_THRESHOLD` name collision (search 0.5 vs duplicate 0.90). Different domains. **WATCH DRY-263:** `formatSpeed`/`estimateEta` local helpers (1 consumer). **CLEAN:** Wiki handler correctly uses `clamp_limit`/`clamp_offset`. All repos use COLUMNS constant. All handlers use `DataResponse<T>`. Frontend hooks follow TanStack Query key factory pattern. `download_manager.rs` re-exports `MODEL_TYPE_*` from `integrity.rs` (no duplication). Constants properly centralized in `core/src/`. **VERIFIED:** `cargo check` clean, `cargo test -p trulience-core --lib` 591/591 passed, `npx tsc --noEmit` clean, `npx vitest run` 612/612 passed across 97 files. |
| 2026-02-22 | PRD-39, PRD-49 (Scene Assembler & Delivery Packaging, Automated Quality Gates) | 32 files (14 PRD-39: 1 core assembly.rs, 3 db models, 3 db repos, 1 handler, 1 route, 6 frontend; 12 PRD-49: 1 core quality_gate.rs, 2 db models, 2 db repos, 1 handler, 1 route, 5 frontend; 6 cross-ref: qa_status.rs, ffmpeg.rs, response.rs, format.ts, image_qa.rs, review-notes/types.ts) | 2 CRITICAL fixed (DRY-246, DRY-247), 2 HIGH fixed (DRY-248, DRY-249), 1 MEDIUM fixed (DRY-250), rest CLEAN | **FIXED (CRITICAL DRY-246):** Local `formatFileSize()` in `ExportHistory.tsx` (11 lines) -- behavioral duplicate of `formatBytes()` from `@/lib/format.ts`. Same algorithm, different null handling. Removed local, replaced with `formatBytes` import + null guard. **FIXED (CRITICAL DRY-247):** Local `formatDate()` in `ExportHistory.tsx` (5 lines) -- uses bare `toLocaleString()` instead of standardized `formatDateTime()` from `@/lib/format.ts`. Removed local, replaced with `formatDateTime` import + null guard. **FIXED (HIGH DRY-248):** Delivery handler `list_exports` used inline `params.limit.unwrap_or(50).min(200)` and `params.offset.unwrap_or(0)` -- extends DRY-093 pattern. Replaced with `clamp_limit`/`clamp_offset` from `core/src/search.rs`. Also aligned `ListExportsParams` and `delivery_export_repo::list_by_project` from `i32` to `i64` for consistency with shared pagination utilities. **FIXED (HIGH DRY-249):** `delivery_export_repo.rs` used magic `status_id = 6` (completed) and `status_id = 7` (failed) in SQL. Added `EXPORT_STATUS_ID_COMPLETED`/`EXPORT_STATUS_ID_FAILED` (and all 7 status IDs) to `core/src/assembly.rs`. Repo now imports and uses named constants. **FIXED (MEDIUM DRY-250):** `QaScoreSummary` struct in `db/src/models/quality_score.rs` had identical fields to `QaSummary` in `core/src/quality_gate.rs` (total_checks, passed, warned, failed -- all usize) and was never used anywhere (dead code). Removed struct, added comment pointing to canonical `core::quality_gate::QaSummary`. **NOT DUPLICATED:** `statusBadgeVariant()` exists in both `quality-gates/types.ts` and `review-notes/types.ts` -- different domains (QA pass/warn/fail vs note open/resolved/wont_fix), different return types. `parse_resolution_str` (assembly.rs, parses string) vs `parse_resolution` (ffmpeg.rs, parses ffprobe JSON) -- different inputs and purposes. `ValidationResult`/`ValidationIssue` (assembly.rs) vs QA scoring types -- different domain concepts (pre-export validation vs QA scoring). `ensure_*_exists` helpers (3 in delivery.rs) follow established project pattern (DRY-097/DRY-121), per-entity by design. `QaScoreSummary` (frontend) is a legitimate TS interface mirroring API response, not a duplicate of backend struct. Image QA `determine_status` (image_qa.rs) structurally similar to core `evaluate_score` -- pre-existing code, different signatures (Option wrapping), noted for future DRY-093-style migration. SQL status strings `'pass'`/`'warn'`/`'fail'` in `quality_score_repo.rs` -- cannot parameterize SQL aggregate CASE expressions, acceptable. **CLEAN:** All PRD-39 and PRD-49 handlers use `DataResponse<T>` + `impl IntoResponse`. All repos use COLUMNS constant pattern. Core modules (`assembly.rs`, `quality_gate.rs`) have comprehensive unit tests. `quality_gate.rs` correctly imports from `qa_status.rs`. Frontend hooks follow TanStack Query key factory pattern with `api` client. No `serde_json::json!` in any handler (delete_threshold uses `DataResponse { data: serde_json::Value::Null }` -- valid for DELETE). No raw `fetch` calls. No inline date formatting (after fix). No magic strings in new code. All route files are thin routers. **VERIFIED:** `cargo check` clean, `npx tsc --noEmit` clean, `npx @biomejs/biome lint` clean. |
| 2026-02-22 | PRD-24, PRD-27 (Recursive Video Generation Loop, Template & Preset System) | 26 files (8 backend: 2 core modules, 4 db models, 4 db repos, 2 handlers, 2 routes; 14 frontend: 2 types, 2 hooks, 5 components, 2 barrel exports, 5 test files) + cross-ref (response.rs, format.ts, scene_type_config.rs, search.rs, CsvImport.tsx) | 1 CRITICAL fixed (DRY-237), 3 HIGH fixed (DRY-238, DRY-239, DRY-240), 1 HIGH fixed (DRY-241 via DRY-237 refactor), 3 MEDIUM watch (DRY-242, DRY-243, DRY-244), 1 LOW watch (DRY-245), rest CLEAN | **FIXED (CRITICAL DRY-237):** Generation handler `generation.rs` used `serde_json::json!` with ad-hoc JSON 3x (`start_generation`, `select_boundary_frame`, `batch_generate`) instead of `DataResponse<T>`. Created 4 typed response structs (`StartGenerationResponse`, `SelectBoundaryFrameResponse`, `BatchGenerateResponse`, `BatchGenerateError`) in `db/src/models/generation.rs`. Migrated all 4 handler functions to `DataResponse<T>` + `impl IntoResponse`. Removed unused `StatusCode` import. **FIXED (HIGH DRY-238):** Local `formatDuration(secs)` in `GenerationProgressBar.tsx` (line 34, 4 lines) -- behavioral duplicate of `formatDuration(ms)` from `@/lib/format.ts`. Replaced with `formatSecs()` thin wrapper that converts seconds to ms and delegates to shared `formatDuration`. Eliminated 4 lines of duplicate formatting logic. **FIXED (HIGH DRY-239):** `SegmentRepo::list_by_scene_for_generation()` (14 lines) was an EXACT duplicate of `SegmentRepo::list_by_scene()` -- identical SQL query, identical parameters, identical return type. Confirmed zero callers. Removed dead code. **FIXED (HIGH DRY-240):** Local `formatValue(value)` in `OverridePreviewDialog.tsx` (9 lines) was a near-duplicate of the same function in `CsvImport.tsx`. Extracted shared `formatValue()` to `@/lib/format.ts` with unified null/array/object/primitive handling. `OverridePreviewDialog` now imports from shared. CsvImport uses slightly different null text ("(empty)"), will migrate when next touched. Resolves DRY-172 partially. **FIXED (HIGH DRY-241):** `batch_generate` handler body (70+ lines) duplicated the entire init-scene-for-generation sequence from `start_generation` -- load scene, load scene type, validate, estimate segments, create UpdateSceneGeneration, update_generation_state. Extracted shared `init_scene_generation(state, scene_id, boundary_mode) -> AppResult<(u32, String)>` private async helper. Both `start_generation` and `batch_generate` now call it. Batch handler went from ~70 lines to ~20 lines. **WATCH DRY-242 (MEDIUM):** `validate_template_name` and `validate_preset_name` in `core/src/preset.rs` are structural duplicates -- same empty check + length check pattern, different entity label and max constant. 2 consumers. Extract generic `validate_entity_name(name, label, max_len)` at 3rd consumer. **WATCH DRY-243 (MEDIUM):** Scope-visibility WHERE clause `(scope = 'personal' AND owner_id = $1) OR (scope = 'project' AND project_id = $2) OR scope = 'studio'` duplicated in `template_repo::list_for_user` and `preset_repo::list_for_user`. 2 consumers. If a 3rd scope-aware repo appears, extract SQL fragment builder. **WATCH DRY-244 (MEDIUM):** Marketplace handler `presets.rs` uses inline pagination `unwrap_or(25).min(100)` with i32 instead of `clamp_limit`/`clamp_offset` from `core/src/search.rs` (i64). Different types and page-based (page->offset conversion) vs raw offset. Extends DRY-093. **WATCH DRY-245 (LOW):** `formatValue` shared function uses `"(none)"` for null, but CsvImport.tsx uses `"(empty)"`. Context-dependent null display text. If a 3rd consumer appears, consider making null text configurable: `formatValue(value, { nullText: "(none)" })`. **NOT DUPLICATED:** `core/src/generation.rs` correctly imports `ClipPosition` from `scene_type_config` rather than redefining it. `determine_clip_position()` is unique generation-specific logic. `should_stop_generation()` is unique. `compute_override_diff()` in `core/src/preset.rs` is unique. All frontend hooks use TanStack Query key factories with `api` client. All test files use `renderWithProviders` from `@/lib/test-utils.tsx`. `generation.rs` core module doc comment explicitly states FFmpeg utilities are NOT re-exported to avoid duplication. Preset `validate_scope`/`validate_scope_project_consistency` are unique domain validators. **CLEAN:** Both core modules have comprehensive unit tests (generation: 16 tests, preset: 14 tests). All repos use COLUMNS constant pattern. All handler files use `DataResponse<T>` + `impl IntoResponse`. All route files are thin routers. TanStack Query hooks follow established key factory pattern. No `serde_json::json!` in any handler. No raw `fetch` calls. No magic status_id numbers. No dead imports. No inline date formatting. Marketplace handler properly uses `ensure_preset_exists` pattern. `generate_scene_router`/`generate_segment_router` properly merge into existing route nests. **VERIFIED:** `cargo check` clean, `cargo test -p trulience-core --lib` 475/475 passed, `npx tsc --noEmit` clean, `npx vitest run` 556/556 passed across 79 files. |

| 2026-02-23 | PRD-57, PRD-25, PRD-26 (Batch Production Orchestrator, Incremental Re-stitching & Smoothing, Temporal Continuity) | 46 files (15 backend: 3 core modules, 3 db models, 3 db repos, 3 handlers, 3 routes; 15 frontend: 3 types, 3 hooks, 6 components, 3 barrel exports; 6 test files; 3 SQL migrations; 4 Python scripts; 7 modified shared files) + cross-ref (response.rs, format.ts, chartStyles.ts, segment.rs, search.rs, Badge.tsx, test-utils.tsx) | 3 HIGH fixed (DRY-264 to DRY-266), 4 MEDIUM watch (DRY-267 to DRY-270, DRY-271), 2 LOW (DRY-272 resolved, DRY-273 watch) | **HIGH DRY-264:** `serde_json::json!` in 3 `production_run.rs` handler endpoints (`submit_cells`, `resubmit_failed`, `deliver_run`) instead of typed `DataResponse<T>` -- same violation as DRY-083. Create typed response DTOs. **HIGH DRY-265:** Magic `status_id` numbers in `production_run_repo.rs` (`status_id = 3` in `mark_completed`, `status_id = 4` in `list_failed_cells`) and handler (`2`, `1`, `3`/`4`/`1` in `get_progress`). `RUN_STATUS_ID_*` constants exist in `core/src/batch_production.rs` but are unused. Parameterize SQL. **HIGH DRY-266:** `validate_unit_range` pattern (`!(0.0..=1.0).contains(&threshold)`) duplicated 5x across core modules: `restitching.rs`, `temporal_continuity.rs` (2x), `quality_gate.rs`, and `image_qa.rs`. 5 consumers, threshold exceeded. Extract `validate_unit_range(value, name)` to `core/src/validation_helpers.rs`. **MEDIUM DRY-267:** Face detection boilerplate (Haar cascade + detectMultiScale + largest face) duplicated across 3 Python scripts, grain extraction duplicated between 2 scripts. 3 consumers. **MEDIUM DRY-268:** `increment_completed`/`increment_failed` structural duplicate in `production_run_repo.rs` (differ only in column name). 2 consumers. **MEDIUM DRY-269:** `badgeVariant` mapper functions now at 7 feature modules. Watch pattern. **MEDIUM DRY-270/271:** SSIM thresholds (0.85, 0.92) and temporal thresholds cross-boundary duplicated between Rust and TypeScript. Same pattern as DRY-114/DRY-207. Add sync comments. **LOW DRY-272:** `ensure_run_exists` correctly follows DRY-097/DRY-121 pattern -- clean. **LOW DRY-273:** `qualityColor` function at 1 consumer -- acceptable. **CORRECTLY FOLLOWED (10+ patterns):** DataResponse<T> in PRD-25/26 handlers. `clamp_limit`/`clamp_offset` in production_run handler. `ensure_segment_exists` reused from shared `segment.rs`. COLUMNS constants in all 3 repos. `renderWithProviders` in all test files. `chartStyles.ts` imports (TOOLTIP_CONTENT_STYLE, AXIS_TICK_STYLE, GRID_STROKE) in DriftTrendChart. `formatDateTime` from `@/lib/format.ts` in SegmentVersionComparison. Modal composite used (not hand-rolled). `api` client used (no raw fetch). `BadgeVariant` imported from primitives. **FIXED (HIGH DRY-264):** Created `SubmitCellsResponse`, `ResubmitResponse`, `DeliverResponse` typed structs in `db/src/models/production_run.rs`. Replaced `serde_json::json!` in 3 handler endpoints with `DataResponse<T>`. **FIXED (HIGH DRY-265):** Parameterized SQL in `mark_completed` and `list_failed_cells` with `RUN_STATUS_ID_*` constants. Handler: replaced all magic `1`, `2`, `3`, `4` with named constants. **FIXED (HIGH DRY-266):** Created `core/src/threshold_validation.rs` with `validate_unit_range(value, name)`. Refactored `restitching.rs`, `temporal_continuity.rs` (2x), `embedding.rs`, `quality_gate.rs` to delegate. 651 core tests pass. **SYNC COMMENTS:** Added cross-boundary sync comments to `features/restitching/types.ts` (DRY-270) and `features/temporal/types.ts` (DRY-271) pointing to canonical Rust sources. **VERIFIED:** `cargo check` clean, `cargo test -p trulience-core --lib` 651/651 passed, `npx tsc --noEmit` clean. |

| 2026-02-23 | PRD-58, PRD-59, PRD-61 (Scene Preview & Quick Test, Multi-Resolution Pipeline, Cost & Resource Estimation) | 33 files (3 core modules, 3 db models, 3 db repos, 3 handlers, 3 routes; 3 frontend features: test-shots, resolution, estimation; 3 test files; 4 SQL migrations) + cross-ref (threshold_validation.rs, search.rs, Badge.tsx, test-utils.tsx, Modal.tsx, format.ts) | 2 HIGH fixed (DRY-274, DRY-275), 4 MEDIUM fixed (DRY-277, DRY-278, DRY-279, DRY-280), 2 MEDIUM watch (DRY-276, DRY-282), 1 LOW watch (DRY-281), rest CLEAN | **FIXED (HIGH DRY-274):** `resolution.rs` handler used fully-qualified `trulience_core::error::CoreError::NotFound` 5 times instead of importing `CoreError` -- same violation as DRY-231. Added `use trulience_core::error::CoreError;` import. Extracted `ensure_scene_exists(pool, id) -> AppResult<Scene>` and `ensure_tier_exists(pool, id) -> AppResult<ResolutionTier>` private helpers following DRY-097/DRY-121 pattern. Replaced all 5 inline NotFound constructions. Also used `DbId` type for Path parameters instead of raw `i64`. **FIXED (HIGH DRY-275):** `.map_err(AppError::Core)?` used 4x in `resolution.rs` and 1x in `estimation.rs` handlers -- redundant because `AppError` has `#[from] CoreError`, so plain `?` auto-converts. Replaced all 5 instances with plain `?`. Same pattern as DRY-215. **FIXED (MEDIUM DRY-277):** `validate_batch_size` (test_shot.rs) and `validate_estimate_count` (estimation.rs) were structural duplicates -- identical pattern: check > 0, check <= max, different label and max constant. Extracted shared `validate_count_range(count, max, label)` to `core/src/threshold_validation.rs` alongside existing `validate_unit_range`. Both callers now delegate with 1-line implementations. 3 new unit tests added. **FIXED (MEDIUM DRY-278):** `confidenceBadgeVariant` in `estimation/types.ts` returned inline union `"success" \| "warning" \| "danger" \| "default"` instead of importing `BadgeVariant` from `@/components`. Added import, changed return type to `BadgeVariant`. Consistent with `testShotStatusVariant` and `tierBadgeVariant` in same batch. **FIXED (MEDIUM DRY-279):** `TestShotButton.tsx` hand-rolled modal overlay (`fixed inset-0 z-50 bg-black/40` + manual click-outside) -- 5th consumer of pattern (DRY-161/DRY-235/DRY-236). Replaced with `Modal` component from `@/components/composite`. Gets proper focus trapping, Escape key handling, scroll lock, and portal rendering for free. **FIXED (MEDIUM DRY-280):** `EstimationCard.tsx` used magic numbers `3600` (seconds per hour) and `1024` (MB per GB) in template literals. Backend has named constants `SECS_PER_HOUR`/`MB_PER_GB` in `core/src/estimation.rs`. Added matching frontend constants `SECS_PER_HOUR`/`MB_PER_GB` with cross-boundary sync comments pointing to Rust canonical source. **WATCH DRY-276 (MEDIUM):** `PaginationQuery` struct (`limit: Option<i64>, offset: Option<i64>`) duplicated in 12+ handler files. Extends DRY-004. Many have extra domain-specific fields mixed in. Extract shared `PaginationParams` to `api/src/response.rs` if count reaches 15+. **WATCH DRY-281 (LOW):** `test_shot_repo.rs` has `list_by_scene_type` and `list_by_character` which are structurally identical (differ only in WHERE column). `list_gallery` subsumes `list_by_scene_type` when `character_id = None`. 2 consumers -- acceptable. **WATCH DRY-282 (LOW):** Badge variant mapper count now at 10 feature modules (extends DRY-269). Each maps different domain status to Badge variants. Domain-specific by design. Watch but below extraction threshold. **NOT DUPLICATED:** `serde_json::json!({})` used in test_shot.rs handler as default JSONB parameter value -- this is the correct pattern for optional JSONB fields, not a response envelope violation (DRY-083). `test_shot::validate_quality_score` correctly delegates to shared `validate_unit_range`. `estimation::incremental_mean` is unique domain logic. `TestShotStatus` enum in core and TS are legitimate cross-boundary types (different runtimes). `resolution::can_upscale` is unique directional validation. All 3 `ensure_*_exists` helpers follow established pattern. **CORRECTLY FOLLOWED (12+ patterns):** `DataResponse<T>` in all 3 handlers. `clamp_limit`/`clamp_offset` in test_shot and estimation handlers. COLUMNS constants in all 3 repos. `renderWithProviders` in all 3 test files. TanStack Query key factory pattern in all 3 hook files. `api` client (no raw fetch). `BadgeVariant` imported from primitives/components. `formatDateTime`/`formatBytes` not needed (new features use domain-specific display). Thin router files. Core modules have comprehensive unit tests (test_shot: 13 tests, resolution: 13 tests, estimation: 22 tests). No `serde_json::json!` as response envelope. No magic status_id numbers. No dead imports. **VERIFIED:** `cargo check` clean (0 warnings), `cargo test -p trulience-core --lib` 708/708 passed, `npx tsc --noEmit` clean, `npx vitest run` 662/662 passed across 104 test files. |

| 2026-02-23 | PRD-62, PRD-69, PRD-78 (Storyboard View & Scene Thumbnails, Generation Provenance & Asset Versioning, Segment Trimming & Frame-Level Editing) | 36 files (3 core modules, 3 db models, 3 db repos, 3 handlers, 3 routes; 3 frontend features: storyboard (6 files), provenance (6 files), trimming (7 files); 4 SQL migrations) + cross-ref (video-player/frame-utils.ts, lib/format.ts, search.rs, threshold_validation.rs, hashing.rs) | 2 HIGH fixed (DRY-283, DRY-285), 6 MEDIUM/LOW watch (DRY-284, DRY-286, DRY-287, DRY-288, DRY-289, DRY-290), rest CLEAN | **FIXED (HIGH DRY-283):** `frameToTimecode(frame, fps)` in `TrimTimeline.tsx` (line 35, 8 lines) was an exact duplicate of `frameToTimecode()` from `features/video-player/frame-utils.ts`. Same algorithm: frame number -> HH:MM:SS:FF timecode. Removed local copy, replaced with import from shared module. **FIXED (MEDIUM DRY-285):** `VersionHistory.tsx` used inline `new Date(entry.created_at).toLocaleDateString(undefined, { year, month, day })` which is behaviorally identical to `formatDate()` from `@/lib/format.ts`. Replaced date portion with `formatDate(entry.created_at)` import. Same violation pattern as DRY-157/DRY-173/DRY-188/DRY-223. **WATCH DRY-284 (LOW):** `clamp(value, min, max)` identical 1-line function at 2 consumers (`TrimTimeline.tsx`, `usePanelResize.ts`). Extract to `@/lib/math-utils.ts` at 3rd consumer. **WATCH DRY-286 (MEDIUM):** `StoryboardParams` pagination struct in storyboard handler is structurally identical to `PaginationQuery` in estimation.rs. Extends DRY-276 (now 13+ handler files with identical struct). **WATCH DRY-287 (LOW):** `count_for_segment` method structurally duplicated across 3 new repos (keyframe, generation_receipt, segment_trim). Same `SELECT COUNT(*) FROM {table} WHERE segment_id = $1` pattern. Acceptable as thin-adapter repo methods. **WATCH DRY-288 (LOW):** `formatTimecode(secs)` in `storyboard/types.ts` vs `frameToTimecode(frame, fps)` in `video-player/frame-utils.ts`. Different input types and output formats (seconds -> MM:SS.f vs frame -> HH:MM:SS:FF). NOT a duplicate. Watch if a 3rd timecode formatter appears. **WATCH DRY-289 (LOW):** `validate_receipt_inputs` in `provenance.rs` has 4 sequential positive-value checks with near-identical code. Could extract `validate_positive_i32(value, name)` to `threshold_validation.rs`. Currently 1 consumer. **WATCH DRY-290 (MEDIUM):** Loading/error/empty state triptych repeated across 3 provenance components (ReceiptPanel, StalenessReport, VersionHistory). ~15 identical lines per component. Extract `QueryStateWrapper<T>` at 5+ feature modules. **NOT DUPLICATED:** `ensure_trim_exists` in `trimming.rs` correctly follows DRY-097/DRY-121 pattern. `CopyableHash` and `FieldRow` sub-components in `ReceiptPanel.tsx` are unique to provenance display and not duplicated elsewhere. `formatTimecode` in storyboard is a distinct seconds-based formatter (not frame-based). `compute_inputs_hash` in `provenance.rs` correctly delegates to `sha256_hex` from shared `hashing.rs` (DRY-167). `validate_batch_trim_size` in `trimming.rs` correctly delegates to `validate_count_range` from shared `threshold_validation.rs` (DRY-277). All `LoraConfig` types are legitimate cross-boundary type mirrors (Rust vs TypeScript, different runtimes). Provenance hooks use `URLSearchParams` for query string building -- same pattern as wiki hooks, 2 consumers (acceptable). **CORRECTLY FOLLOWED (15+ patterns):** `DataResponse<T>` in all 3 handlers. `clamp_limit`/`clamp_offset` from `core/src/search.rs` in storyboard handler. COLUMNS constants in all 3 repos. All frontend hooks follow TanStack Query key factory pattern with `api` client. `sha256_hex` from shared `core/src/hashing.rs` used in provenance (not reimplemented). `validate_count_range` from shared `threshold_validation.rs` used in trimming. All 3 route files are thin routers. No `serde_json::json!` in any handler. No raw `fetch` calls. No magic status_id numbers. No dead imports. No inline SVGs. Storyboard handler correctly uses `AuthUser` for mutations and public GET for reads. Trimming handler `#[allow(dead_code)]` on unused `ensure_trim_exists` is acceptable (built ahead of use). Core modules have comprehensive unit tests (storyboard: 11 tests, provenance: 15 tests, trimming: 25 tests). All 3 barrel exports (index.ts) are clean. Frontend test files use test utilities properly. SQL migrations follow project conventions (BIGSERIAL PK, FK indexes, updated_at trigger). **VERIFIED:** `cargo check` clean (0 warnings), `npx tsc --noEmit` clean, `npx vitest run` TrimTimeline 7/7 + VersionHistory 6/6 passed. |

| 2026-02-23 | PRD-63, PRD-75, PRD-77 (Prompt Editor & Versioning, ComfyUI Workflow Import & Validation, Pipeline Stage Hooks) | 36 files (3 core modules, 6 db models, 6 db repos, 3 handlers, 3 routes; 3 frontend features: prompt-editor (8 files), workflow-import (7 files), pipeline-hooks (7 files); 3 SQL migrations) + cross-ref (search.rs, format.ts, Badge.tsx, provenance.rs, scene_type_config.rs pattern) | 3 HIGH fixed (DRY-291, DRY-292, DRY-293), 4 MEDIUM fixed (DRY-294, DRY-295, DRY-296, DRY-297), 2 MEDIUM updated (DRY-276 to 16+, DRY-282 to 13), 6 LOW/MEDIUM watch (DRY-298 to DRY-303), rest CLEAN | **FIXED (HIGH DRY-291):** `Regex::new(PLACEHOLDER_PATTERN)` compiled per-call in `core/src/prompt_editor.rs:extract_placeholders()` (line 121) instead of `static LazyLock<Regex>` established in `scene_type_config.rs` (DRY-201). Extracted `static PLACEHOLDER_RE: LazyLock<Regex>` module-level constant. 31 prompt_editor tests pass. **FIXED (HIGH DRY-292):** `serde_json::json!({...})` for diff response in `workflow_import.rs` handler (line 417-424) instead of typed struct + `DataResponse<T>`. Created `WorkflowDiffResponse` struct in `db/src/models/workflow_version.rs`. Same violation as DRY-083/DRY-264. **FIXED (HIGH DRY-293):** Inline `filter.limit.unwrap_or(100).min(500)` / `filter.offset.unwrap_or(0).max(0)` in `hook_repo.rs` (lines 78-79) instead of `clamp_limit`/`clamp_offset` from `core/src/search.rs`. Replaced with shared functions. Extends DRY-093. **FIXED (MEDIUM DRY-294):** `new Date(x).toLocaleString()` in `VersionTimeline.tsx` (line 120) and `ExecutionLogViewer.tsx` (line 74) instead of `formatDateTime()` from `@/lib/format.ts`. Replaced both with `formatDateTime` import. Same violation as DRY-157/DRY-173/DRY-188/DRY-223/DRY-285. **FIXED (MEDIUM DRY-295):** Cross-boundary constants (`MAX_PROMPT_LENGTH`, `MAX_NEGATIVE_PROMPT_LENGTH`, `PLACEHOLDER_REGEX`) in `prompt-editor/types.ts` lacked sync comments pointing to canonical Rust sources (`core/src/provenance.rs`, `core/src/prompt_editor.rs`). Added JSDoc sync comments. **FIXED (MEDIUM DRY-296):** `TOKEN_ESTIMATE_MULTIPLIER = 1.3` in `PromptEditor.tsx` lacked sync comment pointing to `core/src/prompt_editor.rs`. Added. **FIXED (MEDIUM DRY-297):** `WORKFLOW_STATUS` constants in `workflow-import/types.ts` lacked sync comment pointing to `WORKFLOW_STATUS_ID_*` in `core/src/workflow_import.rs`. Added. **UPDATED DRY-276:** Now 16+ handler files with identical pagination struct. DRY-298 tracks the 3 new additions from this audit. **UPDATED DRY-282:** Badge variant mapper count now 13 (was 10). DRY-302 tracks the 3 new additions. **WATCH DRY-298:** 3 new pagination struct duplicates (`VersionListParams`, `ListVersionsParams`, `PaginationParams`). Extends DRY-276. **WATCH DRY-299:** Version auto-increment `COALESCE((SELECT MAX(version)...), 0) + 1` SQL pattern in 2 repos. Extract at 3rd consumer. **WATCH DRY-300:** Hook point strings hardcoded in handler instead of deriving from `HookPoint` enum. 1 consumer. **WATCH DRY-301:** Enum boilerplate (`as_str`/`from_str`/`Display`) x4 in `pipeline_hooks.rs`. Extract macro at 2nd module. **WATCH DRY-302:** 3 new badge variant mappers (`workflowStatusVariant`, `failureModeVariant`, `hookTypeVariant`). Extends DRY-269/282 to 13 total. **WATCH DRY-303:** Placeholder parsing structurally similar in `PromptEditor.tsx` and `LivePreview.tsx`. 2 consumers, different output shapes. **NOT DUPLICATED:** `MAX_PROMPT_LENGTH` correctly imported from `crate::provenance` in `prompt_editor.rs` -- no backend duplication. `sha256_hex` correctly used from shared `core/src/hashing.rs` in `workflow_import.rs`. `ensure_*_exists` helpers in all 3 handlers follow established DRY-097/DRY-121 pattern. `HookType`/`HookPoint`/`ScopeType`/`FailureMode` enums are unique to pipeline hooks domain. `serde_json::json!(null)` for null fallback in `get_validation_report` is acceptable. All COLUMNS constants follow established repo pattern. No raw `fetch` calls. No magic status_id numbers. No dead imports. No inline SVGs. **CORRECTLY FOLLOWED (15+ patterns):** `DataResponse<T>` in all 3 handlers (except 1 `serde_json::json!` fixed). `clamp_limit`/`clamp_offset` in `prompt_editor.rs` and `workflow_import.rs` handlers. COLUMNS constants in all 6 repos. All 3 route files are thin routers. All frontend hooks follow TanStack Query key factory pattern with `api` client. `BadgeVariant` imported from `@/components` in `workflow-import/types.ts` and `pipeline-hooks/types.ts`. `AuthUser` used for mutations. Core modules have comprehensive unit tests (prompt_editor: 31, workflow_import: 24, pipeline_hooks: 19). All 3 barrel exports (index.ts) clean. Frontend components use `Badge` from design system. SQL migrations follow project conventions (BIGSERIAL PK, FK indexes, updated_at trigger, status lookup tables). **VERIFIED:** `cargo check` clean (0 warnings), `cargo test -p trulience-core -- prompt_editor` 31/31 passed, `npx tsc --noEmit` clean. |

| 2026-02-23 | PRD-74, PRD-64, PRD-50 (Project Configuration Templates, Failure Pattern Tracking, Content Branching) | 33 files (3 core modules, 4 db models, 4 db repos, 3 handlers, 3 routes; 3 frontend features: config-templates (5 files), failure-analytics (5 files), branching (5 files); 3 SQL migrations) + cross-ref (query.rs, diff.rs, search.rs, response.rs, Badge.tsx, format.ts) | 1 CRITICAL fixed (DRY-304), 3 HIGH fixed (DRY-303/DiffStatus, DRY-304/TrendPoint, DRY-306), 5 MEDIUM/LOW watch (DRY-305, DRY-307, DRY-308, DRY-309, DRY-310), rest CLEAN | **FIXED (CRITICAL DRY-304):** `PaginationParams` struct (`limit: Option<i64>, offset: Option<i64>`) duplicated identically in 4 handler files (`project_config.rs`, `integrity.rs`, `webhooks.rs`, `pipeline_hooks.rs`). Created shared `api/src/query.rs` module with single definition. All 4 consumers refactored to `use crate::query::PaginationParams`. Extends DRY-276/DRY-004. **FIXED (HIGH DRY-303/DiffStatus):** `DiffStatus` enum defined independently in `core/src/project_config.rs` (3 variants: Added, Changed, Unchanged with Display impl and tests) and `core/src/branching.rs` (4 variants: Added, Removed, Changed, Unchanged with serde rename). Created shared `core/src/diff.rs` with superset enum (4 variants). Both modules import. 50 core tests pass. **FIXED (HIGH DRY-304/TrendPoint):** `failure_analytics.rs:get_trends` mapped trend data to `serde_json::json!` inline -- same violation as DRY-083/DRY-264. Created typed `TrendPointResponse` struct in `db/src/models/failure_pattern.rs`. Handler now constructs struct directly. **FIXED (MEDIUM DRY-306):** `compare_branches` handler had inline `SELECT COUNT(*) FROM segments WHERE branch_id = $1` executed via raw `sqlx::query_as` 2x in same handler. Added `BranchRepo::count_segments()` repository method. Both calls now delegate to repo. **WATCH DRY-305:** `serde_json::json!` in `project_config_repo.rs` export function -- data transformation, not API envelope violation. **WATCH DRY-307:** `validate_config_name` vs `validate_branch_name` structural similarity (same pattern as DRY-242). 2 consumers. **WATCH DRY-308:** `effectivenessBadgeVariant` in `PatternDetail.tsx`. Extends DRY-269/DRY-282 to 14 badge variant mappers. **WATCH DRY-309:** Frontend `DiffStatus` types not shared between config-templates and branching. Backend unified. 2 consumers. **WATCH DRY-310:** Diff style/badge mapping structural similarity between `ConfigDiffView.tsx` and `BranchComparison.tsx`. 2 consumers. **CORRECTLY FOLLOWED (12+ patterns):** `DataResponse<T>` in all 3 handlers (except 1 `serde_json::json!` fixed). `clamp_limit`/`clamp_offset` in project_config handler. COLUMNS constants in all 4 repos. All 3 route files are thin routers. All frontend hooks follow TanStack Query key factory pattern with `api` client. `BadgeVariant` imported from `@/components/primitives/Badge`. `formatDateTime`/`formatValue` from `@/lib/format.ts`. `ensure_*_exists` helpers in branching and project_config handlers. Core modules have unit tests (project_config: 24, branching: 23, diff: 3). No raw `fetch` calls. No magic status_id numbers. No dead imports. No inline date formatting. **VERIFIED:** `cargo check` clean (0 warnings), `cargo test -p trulience-core -- diff` 3/3 + `branching` 23/23 + `project_config` 24/24 passed, `npx tsc --noEmit` clean. |

| 2026-02-23 | PRD-70, PRD-95 (On-Frame Annotation & Markup, Production Notes & Internal Comments) | 26 files (2 core modules: annotation.rs, production_notes.rs; 3 db models: frame_annotation.rs, note_category.rs, production_note.rs; 3 db repos: frame_annotation_repo.rs, note_category_repo.rs, production_note_repo.rs; 2 handlers: annotation.rs, production_notes.rs; 2 routes: annotation.rs, production_notes.rs; 2 frontend types: annotations/types.ts, production-notes/types.ts; 2 hooks: use-annotations.ts, use-production-notes.ts; 8 components: DrawingCanvas, TextLabel, AnnotationLayers, AnnotationSummary, exportAnnotation, NoteEditor, NotesPanel, PinnedNoteBanner, NoteThread, VisibilitySelector) + cross-ref (storyboard.rs, review.rs, roles.rs, query.rs, search.rs, format.ts, Badge.tsx) | 1 CRITICAL fixed (DRY-311), 2 HIGH fixed (DRY-313, DRY-314), 2 MEDIUM fixed (DRY-316, DRY-317), 5 WATCH new (DRY-312, DRY-315, DRY-318, DRY-319, DRY-320), rest CLEAN | **FIXED (CRITICAL DRY-311):** `validate_frame_number(frame)` exact copy-paste from `core/src/storyboard.rs` into `core/src/annotation.rs` (8-line function body + 4 duplicate unit tests). Removed duplicate, added `pub use crate::storyboard::validate_frame_number;` re-export. **FIXED (HIGH DRY-313):** 8x fully-qualified `trulience_core::error::CoreError::NotFound` in `production_notes.rs` handler. Added `use CoreError;` import, replaced all 8. **FIXED (HIGH DRY-314):** Hardcoded `"admin"`/`"reviewer"` in `can_view_note()`. Replaced with `ROLE_ADMIN`/`ROLE_REVIEWER` from `core/src/roles.rs`. **FIXED (MEDIUM DRY-316):** 3 identical `onSuccess` callbacks in annotation mutation hooks. Extracted `useAnnotationInvalidation(segmentId)`. **FIXED (MEDIUM DRY-317):** 7x verbose `.map_err(\|e\| AppError::BadRequest(e))`. Simplified to `.map_err(AppError::BadRequest)`. **WATCH DRY-312:** `validate_color_hex` vs `validate_tag_color` -- different contracts, 2 consumers. **WATCH DRY-315:** `validate_entity_type` at 3 core modules with different entity lists. **WATCH DRY-318:** Color swatch pattern in DrawingCanvas/TextLabel. **WATCH DRY-319:** 15th badge variant mapper (`categoryBadgeVariant`). **WATCH DRY-320:** `DrawingToolType` enum boilerplate (5th enum, 2nd module). **CLEAN:** All handlers use `DataResponse<T>`. All repos use COLUMNS constant. `clamp_limit`/`clamp_offset` used in production_note_repo. `formatDateTime` from shared format.ts. `BadgeVariant` imported from primitives. Core modules have 61 unit tests total. No `serde_json::json!`, no raw `fetch`, no magic status_id numbers. **VERIFIED:** `cargo check` clean, `cargo test` annotation 32/32 + production_notes 29/29 passed, `npx tsc --noEmit` clean. |

| 2026-02-23 | Phase 8: PRD-67, PRD-86, PRD-88, PRD-107, PRD-108, PRD-18 (Bulk Onboarding, Legacy Import, Batch Metadata, Character Readiness, Character Dashboard, Bulk Maintenance) | ~50 files (6 core modules: onboarding_wizard.rs, legacy_import.rs, batch_metadata.rs, readiness.rs, character_dashboard.rs, maintenance.rs; 7 db models: onboarding_session.rs, legacy_import_run.rs, legacy_import_entity_log.rs, readiness_criteria.rs, readiness_cache.rs, batch_metadata_operation.rs, bulk_operation.rs; 7 db repos: matching repos; 6 handlers: onboarding_wizard.rs, legacy_import.rs, batch_metadata.rs, readiness.rs, character_dashboard.rs, maintenance.rs; 4 routes: legacy_import.rs, onboarding_wizard.rs, readiness.rs + existing; 6 frontend features: legacy-import, onboarding-wizard, readiness, batch-metadata, character-dashboard, maintenance; 7 SQL migrations) + cross-ref (search.rs, response.rs, query.rs, roles.rs, format.ts, Badge.tsx) | 2 HIGH fixed (DRY-321, DRY-322), 1 HIGH fixed (DRY-324), 1 HIGH fixed (DRY-325), 1 MEDIUM fixed (DRY-323), 4 WATCH new (DRY-326 to DRY-329), rest CLEAN | **FIXED (HIGH DRY-321):** 7x inline `LegacyImportRunRepo::find_by_id + ok_or_else(NotFound)` in `legacy_import.rs` handler (`get_run`, `scan_folder`, `preview_import`, `commit_import`, `get_run_report`, `get_gap_report`, `import_csv`). Extracted `ensure_run_exists(pool, id) -> AppResult<LegacyImportRun>` private helper following DRY-097/DRY-121 pattern. All 7 handlers refactored. **FIXED (HIGH DRY-322):** `list_runs` and `list_entity_logs` in `legacy_import.rs` passed raw `params.limit`/`params.offset` without clamping. Added `clamp_limit`/`clamp_offset` from `core/src/search.rs`. Extends DRY-093 pattern. **FIXED (MEDIUM DRY-323):** 6x verbose `.map_err(\|e\| AppError::BadRequest(e))` closure form in `batch_metadata.rs` handler. Simplified to `.map_err(AppError::BadRequest)` method reference. Same pattern as DRY-317. **FIXED (HIGH DRY-324):** `get_run_report` in `legacy_import.rs` built response with `serde_json::json!` instead of typed struct. Created `RunReportResponse`/`ActionCountEntry` DTOs. Handler now returns `DataResponse<RunReportResponse>`. Extends DRY-083 resolution pattern. **FIXED (HIGH DRY-325):** `get_readiness_summary` in `readiness.rs` built response with `serde_json::json!` instead of existing `readiness::ReadinessSummary` typed struct from core. Replaced with `DataResponse<ReadinessSummary>`. Zero new structs needed -- reused existing core type. **WATCH DRY-326:** `can_undo_operation` structural duplicate between `batch_metadata.rs` and `maintenance.rs` core modules. Same logic, different enum types. 2 consumers. **WATCH DRY-327:** `STATUS_PREVIEW/COMPLETED/FAILED/UNDONE` constants duplicated across 2 core modules (batch_metadata + maintenance). Different domain contexts, same lifecycle names. **WATCH DRY-328:** `MissingItemType` (readiness.rs) vs `MissingItemCategory` (character_dashboard.rs) conceptual overlap. Different semantics (per-asset vs aggregate). 2 consumers. **WATCH DRY-329:** Local pagination structs in 6 Phase 8 handlers extend DRY-276 to 20+ files. Domain-specific fields mixed with pagination fields prevent direct extraction. **NOT DUPLICATED:** `onboarding_wizard.rs` core has unique wizard step validation with complex step dependency graph. `character_dashboard.rs` inline SQL queries are dashboard-specific aggregation (no COLUMNS pattern applicable). `maintenance.rs` handler properly uses `clamp_limit`/`clamp_offset`. `onboarding_wizard.rs` handler already has `ensure_session_exists` helper. All 6 frontend features follow TanStack Query key factory pattern, no cross-feature duplication detected. `define_status_enum!` macro correctly used for all new status enums. **CORRECTLY FOLLOWED (12+ patterns):** `DataResponse<T>` in all 6 handlers (after fixes). `clamp_limit`/`clamp_offset` in batch_metadata and maintenance handlers. COLUMNS constants in all 7 repos. All frontend hooks follow TanStack Query key factory with `api` client. `AuthUser`/`RequireAdmin` used consistently. `CoreError::NotFound` imported (not fully-qualified). All route files are thin routers. Core modules have validation functions. No `serde_json::json!` as response envelope (after fixes). No raw `fetch` calls. No magic status_id numbers. No dead imports. **VERIFIED:** `cargo check` clean, `npx tsc --noEmit` clean. |

---

## How to Use This File

### When Starting a New PRD Implementation
1. Read the "Active Watch List" section
2. Check if your PRD is mentioned in any existing DRY entry
3. If yes, check whether a shared utility already exists (see "Resolved" section)
4. If a shared utility exists, use it. If not, build one and resolve the DRY entry.

### After Implementing Code
1. Run `dry-guy` agent on all changed files
2. If new patterns are flagged, add them to the "Active Watch List"
3. If existing patterns are resolved, move them to "Resolved" with the shared location

### When Reviewing PRs
1. Check if the PR introduces code that matches any `watch` or `flagged` entries
2. If so, request that the author use the shared utility or extract one
3. Block merge until DRY-GUY audit passes

---

## Version History

- **v1.0** (2026-02-18): Initial creation with pre-identified watch patterns from PRD analysis
