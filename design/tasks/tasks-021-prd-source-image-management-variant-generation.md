# Task List: Source Image Management & Variant Generation

**PRD Reference:** `design/prds/021-prd-source-image-management-variant-generation.md`
**Scope:** Manage source image upload with automatic face embedding extraction, generate derived image variants via ComfyUI workflows, support variant selection/approval and an iterative external edit loop, and track variant provenance.

## Overview

The source image is the single point of truth for a character's likeness. This feature manages the full lifecycle: upload with automatic QA and embedding extraction, variant generation via ComfyUI (e.g., clothed from topless), variant review and hero selection, external edit round-trips (export, Photoshop, re-import), and provenance tracking. Approved variants become the seed images for all downstream scene generation, so quality control at this stage prevents cascading errors.

### What Already Exists
- PRD-000: Database conventions (BIGSERIAL, TIMESTAMPTZ, DbId)
- PRD-001: Character entity and data model
- PRD-005: ComfyUI WebSocket bridge for generation dispatch
- PRD-007: Parallel task execution engine for background jobs
- PRD-022: Source Image QA (quality checks run on upload)
- PRD-076: Character identity embedding (face extraction on upload)

### What We're Building
1. Source image upload handler with automatic trigger chain (QA + embedding)
2. `image_variants` table and variant lifecycle management
3. Variant generation orchestrator dispatching to ComfyUI
4. Variant selection and hero approval workflow
5. External edit loop (export, re-import, re-QA)
6. Provenance tracking (generated vs. manually edited vs. manual upload)

### Key Design Decisions
1. **One source image per character** — The source is the ground truth reference. Variants derive from it.
2. **Hero variant per type** — Each variant type (clothed, topless) has at most one approved "hero" variant per character.
3. **Provenance as enum** — Each variant tracks how it was created: `generated`, `manually_edited`, `manual_upload`.
4. **External edit preserves version history** — Re-importing an edited variant creates a new version, not an overwrite.

---

## Phase 1: Database Schema

### Task 1.1: Variant Status Lookup Table
**File:** `migrations/YYYYMMDD_create_variant_statuses.sql`

```sql
CREATE TABLE variant_statuses (
    id BIGSERIAL PRIMARY KEY,
    name TEXT NOT NULL UNIQUE,
    description TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
CREATE TRIGGER set_updated_at BEFORE UPDATE ON variant_statuses
    FOR EACH ROW EXECUTE FUNCTION trigger_set_updated_at();

INSERT INTO variant_statuses (name, description) VALUES
    ('pending', 'Variant generation requested but not yet started'),
    ('generating', 'Variant is being generated by ComfyUI'),
    ('generated', 'Variant generation complete, awaiting review'),
    ('editing', 'Variant exported for external editing'),
    ('approved', 'Variant approved as hero for its type'),
    ('rejected', 'Variant rejected by reviewer');
```

**Acceptance Criteria:**
- [ ] Six variant statuses seeded
- [ ] Standard conventions: BIGSERIAL PK, TIMESTAMPTZ, trigger

### Task 1.2: Image Variants Table
**File:** `migrations/YYYYMMDD_create_image_variants.sql`

```sql
CREATE TABLE image_variants (
    id BIGSERIAL PRIMARY KEY,
    character_id BIGINT NOT NULL REFERENCES characters(id) ON DELETE CASCADE ON UPDATE CASCADE,
    variant_type TEXT NOT NULL,           -- e.g., 'clothed', 'topless'
    status_id BIGINT NOT NULL REFERENCES variant_statuses(id) ON DELETE RESTRICT ON UPDATE CASCADE,
    workflow_id BIGINT REFERENCES workflows(id) ON DELETE SET NULL ON UPDATE CASCADE,
    provenance TEXT NOT NULL DEFAULT 'generated',  -- 'generated', 'manually_edited', 'manual_upload'
    is_hero BOOLEAN NOT NULL DEFAULT false,
    file_path TEXT,
    file_size_bytes BIGINT,
    width INTEGER,
    height INTEGER,
    format TEXT,
    version INTEGER NOT NULL DEFAULT 1,
    parent_variant_id BIGINT REFERENCES image_variants(id) ON DELETE SET NULL ON UPDATE CASCADE,
    generation_params JSONB,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_image_variants_character_id ON image_variants(character_id);
CREATE INDEX idx_image_variants_status_id ON image_variants(status_id);
CREATE INDEX idx_image_variants_workflow_id ON image_variants(workflow_id);
CREATE INDEX idx_image_variants_parent_variant_id ON image_variants(parent_variant_id);
CREATE UNIQUE INDEX uq_image_variants_character_hero ON image_variants(character_id, variant_type) WHERE is_hero = true;

CREATE TRIGGER set_updated_at BEFORE UPDATE ON image_variants
    FOR EACH ROW EXECUTE FUNCTION trigger_set_updated_at();
```

**Acceptance Criteria:**
- [ ] `image_variants` table with all required columns
- [ ] Partial unique index ensures at most one hero per character per variant type
- [ ] FK indexes on all foreign key columns
- [ ] `provenance` tracks creation method
- [ ] `parent_variant_id` links edited versions to their source variant
- [ ] `generation_params` stores workflow parameters as JSONB

---

## Phase 2: Source Image Upload

### Task 2.1: Upload Handler
**File:** `src/services/source_image_service.rs`

Handle source image upload with automatic trigger chain.

```rust
use crate::types::DbId;

pub async fn upload_source_image(
    pool: &sqlx::PgPool,
    character_id: DbId,
    file_data: &[u8],
    filename: &str,
) -> Result<UploadResult, anyhow::Error> {
    // 1. Validate file format (PNG, JPEG, WebP)
    // 2. Store file to configured storage path
    // 3. Update character's source_image_path
    // 4. Extract image metadata (dimensions, format, file size)
    // 5. Trigger PRD-076 face embedding extraction (background job)
    // 6. Trigger PRD-022 quality checks (background job)
    // 7. Return upload result with job IDs
    todo!()
}
```

**Acceptance Criteria:**
- [ ] Accepts drag-and-drop or file browser upload (frontend calls same API)
- [ ] Validates format: PNG, JPEG, WebP
- [ ] Stores file and updates character record
- [ ] Triggers face embedding extraction (PRD-076) as background job
- [ ] Triggers image QA (PRD-022) as background job
- [ ] Returns image metadata (dimensions, format, file size)

### Task 2.2: Upload API Endpoint
**File:** `src/routes/source_image_routes.rs`

```rust
/// POST /api/characters/:id/source-image
pub async fn upload_source_image_handler(
    Path(character_id): Path<DbId>,
    mut multipart: Multipart,
) -> Result<Json<UploadResponse>, ApiError> {
    // Parse multipart upload, delegate to service
    todo!()
}
```

**Acceptance Criteria:**
- [ ] Multipart file upload support
- [ ] Returns image metadata and background job IDs
- [ ] 400 for invalid format, 404 for missing character

---

## Phase 3: Variant Generation

### Task 3.1: Variant Generation Service
**File:** `src/services/variant_generation_service.rs`

Orchestrate variant generation via ComfyUI.

```rust
pub struct VariantGenerationRequest {
    pub character_id: DbId,
    pub variant_type: String,
    pub workflow_id: DbId,
    pub count: u32,  // number of candidates to generate
}

pub async fn generate_variants(
    pool: &sqlx::PgPool,
    request: VariantGenerationRequest,
) -> Result<Vec<DbId>, anyhow::Error> {
    // 1. Validate character has approved source image
    // 2. Create N pending variant records
    // 3. Dispatch N generation jobs to ComfyUI via PRD-05 bridge
    // 4. Track progress via PRD-07 execution engine
    // 5. Return variant IDs
    todo!()
}
```

**Acceptance Criteria:**
- [ ] Generates N variant candidates per request
- [ ] Dispatches to ComfyUI via PRD-05 WebSocket bridge
- [ ] Each variant gets a pending record before generation starts
- [ ] Progress tracked via PRD-54 job tray
- [ ] Generation parameters stored on the variant record

### Task 3.2: Variant Generation API
**File:** `src/routes/variant_routes.rs`

```rust
/// POST /api/characters/:id/variants/generate
pub async fn generate_variants_handler(
    Path(character_id): Path<DbId>,
    Json(body): Json<GenerateVariantsRequest>,
) -> Result<Json<GenerateVariantsResponse>, ApiError> {
    // Validate, dispatch, return variant IDs
    todo!()
}
```

**Acceptance Criteria:**
- [ ] Accepts variant type and workflow selection
- [ ] Configurable count of candidates to generate
- [ ] Returns variant IDs for tracking
- [ ] Validates source image exists and is QA-passed

### Task 3.3: Generation Completion Handler
**File:** `src/services/variant_generation_service.rs`

Handle ComfyUI generation completion callback.

```rust
pub async fn on_variant_generated(
    pool: &sqlx::PgPool,
    variant_id: DbId,
    output_path: &str,
) -> Result<(), anyhow::Error> {
    // 1. Store output file path on variant record
    // 2. Extract image metadata
    // 3. Update status to 'generated'
    // 4. Trigger PRD-022 QA checks on the new variant
    // 5. Publish event via PRD-10
    todo!()
}
```

**Acceptance Criteria:**
- [ ] Updates variant record with output file path and metadata
- [ ] Status transitions from `generating` to `generated`
- [ ] QA checks triggered automatically on generated variant
- [ ] Event published for real-time UI updates

---

## Phase 4: Variant Selection & Approval

### Task 4.1: Variant Gallery API
**File:** `src/routes/variant_routes.rs`

```rust
/// GET /api/characters/:id/variants
pub async fn list_variants_handler(
    Path(character_id): Path<DbId>,
    Query(filters): Query<VariantFilters>,
) -> Result<Json<Vec<VariantResponse>>, ApiError> {
    // Return all variants for a character with status, provenance, QA scores
    todo!()
}
```

**Acceptance Criteria:**
- [ ] Returns all variants for a character
- [ ] Includes status, provenance, QA scores, image metadata
- [ ] Filterable by variant type and status
- [ ] Source image included for side-by-side comparison

### Task 4.2: Hero Selection Service
**File:** `src/services/variant_selection_service.rs`

```rust
pub async fn approve_as_hero(
    pool: &sqlx::PgPool,
    variant_id: DbId,
) -> Result<(), anyhow::Error> {
    // 1. Validate variant status is 'generated' or 'editing'
    // 2. Clear previous hero for same character + variant_type
    // 3. Set this variant as hero (is_hero = true, status = approved)
    // 4. Publish event: variant approved
    todo!()
}

pub async fn reject_variant(
    pool: &sqlx::PgPool,
    variant_id: DbId,
) -> Result<(), anyhow::Error> {
    // Set status to rejected
    todo!()
}
```

**Acceptance Criteria:**
- [ ] Only one hero per character per variant type (enforced by partial unique index)
- [ ] Approving a new hero clears previous hero
- [ ] Only approved hero variants are available as scene seeds
- [ ] Rejected variants can be regenerated or deleted

### Task 4.3: Approval API Endpoints
**File:** `src/routes/variant_routes.rs`

```rust
/// POST /api/characters/:id/variants/:variant_id/approve
/// POST /api/characters/:id/variants/:variant_id/reject
/// DELETE /api/characters/:id/variants/:variant_id
```

**Acceptance Criteria:**
- [ ] Approve sets hero status and variant status to approved
- [ ] Reject sets variant status to rejected
- [ ] Delete removes variant file and record
- [ ] Proper validation and error responses

---

## Phase 5: External Edit Loop

### Task 5.1: Export for External Editing
**File:** `src/services/variant_export_service.rs`

```rust
pub async fn export_variant(
    pool: &sqlx::PgPool,
    variant_id: DbId,
) -> Result<ExportResult, anyhow::Error> {
    // 1. Copy variant to export directory at full resolution
    // 2. Update variant status to 'editing'
    // 3. Return export path for download
    todo!()
}
```

**Acceptance Criteria:**
- [ ] Export at full resolution (no quality loss)
- [ ] Status changes to `editing` to indicate external workflow
- [ ] Export path returned for file download

### Task 5.2: Re-import Edited Variant
**File:** `src/services/variant_import_service.rs`

```rust
pub async fn reimport_variant(
    pool: &sqlx::PgPool,
    original_variant_id: DbId,
    file_data: &[u8],
) -> Result<DbId, anyhow::Error> {
    // 1. Create new variant record with parent_variant_id = original
    // 2. Set provenance = 'manually_edited'
    // 3. Increment version number
    // 4. Trigger PRD-022 QA checks on re-imported image
    // 5. Return new variant ID
    todo!()
}
```

**Acceptance Criteria:**
- [ ] Creates new variant linked to original via `parent_variant_id`
- [ ] Version incremented (original v1, edited v2, etc.)
- [ ] Provenance tracked as `manually_edited`
- [ ] QA checks run automatically on re-imported image
- [ ] Full version history preserved

### Task 5.3: Manual Variant Upload
**File:** `src/services/variant_import_service.rs`

```rust
pub async fn upload_manual_variant(
    pool: &sqlx::PgPool,
    character_id: DbId,
    variant_type: &str,
    file_data: &[u8],
) -> Result<DbId, anyhow::Error> {
    // 1. Create variant record with provenance = 'manual_upload'
    // 2. Store file
    // 3. Trigger PRD-022 QA checks
    // 4. Return variant ID
    todo!()
}
```

**Acceptance Criteria:**
- [ ] Variant created with provenance `manual_upload`
- [ ] QA checks run automatically
- [ ] Available for selection alongside generated variants

---

## Phase 6: Frontend Components

### Task 6.1: Source Image Upload Component
**File:** `frontend/src/components/characters/SourceImageUpload.tsx`

```typescript
interface SourceImageUploadProps {
  characterId: number;
  onUploaded: (result: UploadResult) => void;
}

export function SourceImageUpload({ characterId, onUploaded }: SourceImageUploadProps) {
  // Drag-and-drop or file browser
  // Shows preview with metadata (dimensions, format, file size)
  // Progress indicator during upload
  // Status badges for QA and embedding extraction
}
```

**Acceptance Criteria:**
- [ ] Drag-and-drop and file browser support
- [ ] Image preview with metadata display
- [ ] Background job status indicators (QA, embedding)

### Task 6.2: Variant Gallery Component
**File:** `frontend/src/components/characters/VariantGallery.tsx`

```typescript
interface VariantGalleryProps {
  characterId: number;
  variants: Variant[];
  sourceImageUrl: string;
}

export function VariantGallery({ characterId, variants, sourceImageUrl }: VariantGalleryProps) {
  // Source image on the left
  // Generated variants in a grid
  // Hero variant marked with star/checkmark
  // Per-variant: approve, reject, export, delete actions
  // Large preview on click
}
```

**Acceptance Criteria:**
- [ ] Source and all variants displayed side-by-side
- [ ] Hero selection with prominent star/checkmark indicator
- [ ] Quick actions per variant: approve, reject, export, delete
- [ ] Large preview capability (modal or lightbox)
- [ ] Status and provenance labels on each variant

### Task 6.3: External Edit Flow Component
**File:** `frontend/src/components/characters/ExternalEditFlow.tsx`

```typescript
export function ExternalEditFlow({ variantId }: { variantId: number }) {
  // "Export for Editing" button -> downloads full-res image
  // "Re-import Edited" button -> file upload
  // Version history sidebar showing all versions
}
```

**Acceptance Criteria:**
- [ ] Clear round-trip flow: Export -> Edit externally -> Re-import
- [ ] Version history shows original generated + all edited versions
- [ ] Re-import triggers QA automatically

---

## Phase 7: Variant Registry & History

### Task 7.1: Variant History API
**File:** `src/routes/variant_routes.rs`

```rust
/// GET /api/characters/:id/variants/:variant_id/history
pub async fn variant_history_handler(
    Path((character_id, variant_id)): Path<(DbId, DbId)>,
) -> Result<Json<Vec<VariantHistoryEntry>>, ApiError> {
    // Return version chain: original -> edited v2 -> edited v3
    todo!()
}
```

**Acceptance Criteria:**
- [ ] Returns full version history following `parent_variant_id` chain
- [ ] Each entry includes version number, provenance, creation date, QA status
- [ ] Most recent version first

---

## Phase 8: Testing

### Task 8.1: Source Image Upload Tests
**File:** `tests/source_image_test.rs`

**Acceptance Criteria:**
- [ ] Upload valid image -> success with metadata
- [ ] Upload invalid format -> 400 error
- [ ] Upload triggers QA and embedding jobs
- [ ] Re-upload replaces source image

### Task 8.2: Variant Generation Tests
**File:** `tests/variant_generation_test.rs`

**Acceptance Criteria:**
- [ ] Generate variants -> pending records created
- [ ] Completion callback updates variant record
- [ ] QA triggered on generation completion

### Task 8.3: Variant Approval Tests
**File:** `tests/variant_approval_test.rs`

**Acceptance Criteria:**
- [ ] Approve as hero -> only one hero per type per character
- [ ] New hero clears previous hero
- [ ] Rejected variants excluded from scene seeds

---

## Relevant Files

| File | Description |
|------|-------------|
| `migrations/YYYYMMDD_create_variant_statuses.sql` | Variant status lookup table |
| `migrations/YYYYMMDD_create_image_variants.sql` | Image variants table |
| `src/services/source_image_service.rs` | Source image upload handler |
| `src/services/variant_generation_service.rs` | Variant generation orchestrator |
| `src/services/variant_selection_service.rs` | Hero selection and approval |
| `src/services/variant_export_service.rs` | Export for external editing |
| `src/services/variant_import_service.rs` | Re-import and manual upload |
| `src/routes/source_image_routes.rs` | Source image API endpoints |
| `src/routes/variant_routes.rs` | Variant CRUD, approval, history APIs |
| `frontend/src/components/characters/SourceImageUpload.tsx` | Upload component |
| `frontend/src/components/characters/VariantGallery.tsx` | Variant gallery with hero selection |
| `frontend/src/components/characters/ExternalEditFlow.tsx` | Export/re-import flow |

## Dependencies

### Existing Components to Reuse
- PRD-005: ComfyUI WebSocket bridge for variant generation dispatch
- PRD-007: Background task execution for async generation
- PRD-022: Source Image QA (triggered on upload and re-import)
- PRD-054: Job tray for progress tracking
- PRD-076: Face embedding extraction (triggered on upload)

### New Infrastructure Needed
- File storage for source images and variants
- Thumbnail generation for gallery display

## Implementation Order

### MVP
1. Phase 1: Database Schema — Tasks 1.1-1.2
2. Phase 2: Source Image Upload — Tasks 2.1-2.2
3. Phase 3: Variant Generation — Tasks 3.1-3.3
4. Phase 4: Variant Selection & Approval — Tasks 4.1-4.3
5. Phase 6: Frontend — Tasks 6.1-6.2

**MVP Success Criteria:**
- Source image uploaded with automatic QA + embedding
- Variant generation via ComfyUI works end-to-end
- Hero variant selectable per type per character
- Variant gallery shows all variants with status

### Post-MVP Enhancements
1. Phase 5: External Edit Loop — Tasks 5.1-5.3
2. Phase 6: Frontend — Task 6.3
3. Phase 7: Variant History — Task 7.1
4. Phase 8: Testing — Tasks 8.1-8.3
5. Batch variant generation for multiple characters simultaneously

## Notes

1. **File storage strategy:** Source images and variants stored on local filesystem with paths in the database. PRD-048 (External Tiered Storage) handles offloading to remote storage later.
2. **Variant type extensibility:** The `variant_type` column is TEXT, not an enum, to allow studios to define custom variant types beyond clothed/topless.
3. **Hero uniqueness:** The partial unique index `uq_image_variants_character_hero WHERE is_hero = true` ensures database-level enforcement of one hero per type per character.
4. **ComfyUI integration:** Variant generation uses the same ComfyUI bridge as scene generation but with image-to-image workflows instead of video workflows.

## Version History

- **v1.0** (2026-02-18): Initial task list creation from PRD-021 v1.0
